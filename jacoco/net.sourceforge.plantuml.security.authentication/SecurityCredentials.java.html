<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SecurityCredentials.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">plantuml</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.plantuml.security.authentication</a> &gt; <span class="el_source">SecurityCredentials.java</span></div><h1>SecurityCredentials.java</h1><pre class="source lang-java linenums">/* ========================================================================
 * PlantUML : a free UML diagram generator
 * ========================================================================
 *
 * (C) Copyright 2009-2021, Arnaud Roques
 *
 * Project Info:  https://plantuml.com
 *
 * If you like this project or if you find it useful, you can support us at:
 *
 * https://plantuml.com/patreon (only 1$ per month!)
 * https://plantuml.com/paypal
 *
 * This file is part of PlantUML.
 *
 * PlantUML is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * PlantUML distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
 * License for more details.
 *
 * You should have received a copy of the GNU General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301,
 * USA.
 *
 *
 * Original Author:  Arnaud Roques
 *
 *
 */
package net.sourceforge.plantuml.security.authentication;

import java.net.InetSocketAddress;
import java.net.Proxy;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;

import net.sourceforge.plantuml.StringUtils;
import net.sourceforge.plantuml.json.JsonObject;
import net.sourceforge.plantuml.json.JsonValue;

/**
 * Defines a configuration for credentials.
 *
 * @author Aljoscha Rittner
 */
public class SecurityCredentials implements SecurityCredentialsContainer {

<span class="fc" id="L57">	private static final Map&lt;String, Object&gt; EMPTY_MAP = Collections.emptyMap();</span>

	/**
	 * No credentials given.
	 */
<span class="fc" id="L62">	public static final SecurityCredentials NONE = new SecurityCredentials(&quot;&lt;NONE&gt;&quot;, &quot;public&quot;, null, null);</span>

	/**
	 * Name of the configuration.
	 */
	private final String name;
	/**
	 * The type of authorization and access process (e.g. &quot;basicauth&quot; or &quot;oauth2&quot;).
	 */
	private final String type;
	/**
	 * Username or client identifier.
	 */
	private final String identifier;
	/**
	 * User/Client secret information.
	 */
	private final char[] secret;
	/**
	 * Properties defined for a specific authorization and access process.
	 */
<span class="fc" id="L83">	private final Map&lt;String, Object&gt; properties = new HashMap&lt;String, Object&gt;();</span>
	/**
	 * Proxy configuration.
	 * &lt;p&gt;
	 * &lt;p&gt;
	 * {@link Proxy#NO_PROXY} means, we want direct access. null means, we use the
	 * system proxy configuration.
	 */
	private final Proxy proxy;

	/**
	 * Creates BasicAuth credentials without a proxy.
	 *
	 * @param name       Name of the credentials
	 * @param type       The type of authentication and access process (e.g.
	 *                   &quot;basicauth&quot; or &quot;oauth2&quot;)
	 * @param identifier username, clientId, ...
	 * @param secret     the secret information to authenticate the client or user
	 */
	public SecurityCredentials(String name, String type, String identifier, char[] secret) {
<span class="fc" id="L103">		this(name, type, identifier, secret, EMPTY_MAP, null);</span>
<span class="fc" id="L104">	}</span>

	/**
	 * Creates BasicAuth credentials with a proxy.
	 *
	 * @param name       Name of the credentials
	 * @param type       The type of authentication and access process (e.g.
	 *                   &quot;basicauth&quot; or &quot;oauth2&quot;)
	 * @param identifier username, clientId, ...
	 * @param secret     the secret information to authenticate the client or user
	 * @param proxy      proxy configuration
	 */
	public SecurityCredentials(String name, String type, String identifier, char[] secret,
<span class="fc" id="L117">			Map&lt;String, Object&gt; properties, Proxy proxy) {</span>
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">		if (name == null) {</span>
<span class="nc" id="L119">			throw new NullPointerException(&quot;Credential name should not be null&quot;);</span>
		}
<span class="fc" id="L121">		this.name = name;</span>
<span class="fc" id="L122">		this.type = type;</span>
<span class="fc" id="L123">		this.identifier = identifier;</span>
<span class="fc" id="L124">		this.secret = secret;</span>
<span class="fc" id="L125">		this.proxy = proxy;</span>
<span class="fc" id="L126">		this.properties.putAll(properties);</span>
<span class="fc" id="L127">	}</span>

	/**
	 * Creates BasicAuth credentials.
	 *
	 * @param identifier the basic auth user name.
	 * @param secret     password
	 * @return credential object
	 */
	public static SecurityCredentials basicAuth(String identifier, char[] secret) {
<span class="fc" id="L137">		return new SecurityCredentials(identifier, &quot;basicauth&quot;, identifier, secret);</span>
	}

	/**
	 * Creates a SecurityCredentials from a JSON.
	 * &lt;p&gt;
	 * Example:
	 * 
	 * &lt;pre&gt;
	 *     {
	 *         &quot;name&quot;: &quot;jenkins&quot;,
	 *         &quot;identifier&quot;: &quot;alice&quot;,
	 *         &quot;secret&quot;: &quot;secret&quot;,
	 *         &quot;proxy&quot;: {
	 *             &quot;type&quot;: &quot;socket&quot;,
	 *             &quot;address&quot;: &quot;192.168.1.250&quot;,
	 *             &quot;port&quot;: 8080
	 *         }
	 *     }
	 * &lt;/pre&gt;
	 *
	 * @param jsonValue a JSON structure
	 * @return the created SecurityCredentials
	 */
	public static SecurityCredentials fromJson(JsonValue jsonValue) {
		try {
<span class="fc" id="L163">			JsonObject securityObject = jsonValue.asObject();</span>
<span class="fc" id="L164">			JsonValue name = securityObject.get(&quot;name&quot;);</span>
<span class="fc" id="L165">			JsonValue type = securityObject.get(&quot;type&quot;);</span>
<span class="fc" id="L166">			JsonValue identifier = securityObject.get(&quot;identifier&quot;);</span>
<span class="fc" id="L167">			JsonValue secret = securityObject.get(&quot;secret&quot;);</span>

<span class="fc" id="L169">			Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();</span>
<span class="fc" id="L170">			buildProperties(&quot;&quot;, securityObject.get(&quot;properties&quot;), map);</span>

<span class="pc bpc" id="L172" title="1 of 6 branches missed.">			if (type != null &amp;&amp; !type.isNull() &amp;&amp; &quot;tokenauth&quot;.equals(type.asString())) {</span>
<span class="fc" id="L173">				return new SecurityCredentials(name.asString(), &quot;tokenauth&quot;, null, null, map,</span>
<span class="fc" id="L174">						proxyFromJson(securityObject.get(&quot;proxy&quot;)));</span>
<span class="pc bpc" id="L175" title="2 of 4 branches missed.">			} else if (StringUtils.isNotEmpty(name.asString()) &amp;&amp; StringUtils.isNotEmpty(identifier.asString())) {</span>
<span class="pc bpc" id="L176" title="1 of 4 branches missed.">				String authType = type != null &amp;&amp; !type.isNull() ? type.asString() : &quot;basicauth&quot;;</span>
<span class="fc" id="L177">				return new SecurityCredentials(name.asString(), authType, identifier.asString(), extractSecret(secret),</span>
<span class="fc" id="L178">						map, proxyFromJson(securityObject.get(&quot;proxy&quot;)));</span>
			}

<span class="nc" id="L181">		} catch (UnsupportedOperationException use) {</span>
			// We catch UnsupportedOperationException to stop parsing on unexpected elements
<span class="nc" id="L183">		}</span>
<span class="nc" id="L184">		return NONE;</span>
	}

	/**
	 * Creates a Proxy object from a JSON value.
	 * &lt;p&gt;
	 * Example:
	 * 
	 * &lt;pre&gt;
	 *     {
	 *         &quot;type&quot;: &quot;socket&quot;,
	 *         &quot;address&quot;: &quot;192.168.1.250&quot;,
	 *         &quot;port&quot;: 8080
	 *     }
	 * &lt;/pre&gt;
	 *
	 * @param proxyValue JSON, that represents a Proxy object
	 * @return Proxy object or null
	 */
	private static Proxy proxyFromJson(JsonValue proxyValue) {
<span class="pc bpc" id="L204" title="2 of 6 branches missed.">		if (proxyValue != null &amp;&amp; !proxyValue.isNull() &amp;&amp; proxyValue.isObject()) {</span>
<span class="fc" id="L205">			Proxy.Type type = Proxy.Type.DIRECT;</span>

<span class="fc" id="L207">			JsonObject proxyObject = proxyValue.asObject();</span>
<span class="fc" id="L208">			JsonValue proxyType = proxyObject.get(&quot;type&quot;);</span>
<span class="pc bpc" id="L209" title="2 of 4 branches missed.">			if (proxyType != null &amp;&amp; !proxyType.isNull()) {</span>
<span class="fc" id="L210">				type = Proxy.Type.valueOf(proxyType.asString().toUpperCase());</span>
			}
<span class="fc bfc" id="L212" title="All 2 branches covered.">			if (type == Proxy.Type.DIRECT) {</span>
<span class="fc" id="L213">				return Proxy.NO_PROXY;</span>
			}
<span class="fc" id="L215">			JsonValue proxyAddress = proxyObject.get(&quot;address&quot;);</span>
<span class="fc" id="L216">			JsonValue proxyPort = proxyObject.get(&quot;port&quot;);</span>
<span class="pc bpc" id="L217" title="4 of 8 branches missed.">			if (proxyAddress != null &amp;&amp; !proxyAddress.isNull() &amp;&amp; !proxyPort.isNull() &amp;&amp; proxyPort.isNumber()) {</span>
<span class="fc" id="L218">				InetSocketAddress address = new InetSocketAddress(proxyAddress.asString(), proxyPort.asInt());</span>
<span class="fc" id="L219">				return new Proxy(type, address);</span>
			}
		}
<span class="fc" id="L222">		return null;</span>
	}

	/**
	 * Extracts a password, if it is not empty or null.
	 *
	 * @param pwd password json value
	 * @return password or null
	 */
	private static char[] extractSecret(JsonValue pwd) {
<span class="fc bfc" id="L232" title="All 4 branches covered.">		if (pwd == null || pwd.isNull()) {</span>
<span class="fc" id="L233">			return null;</span>
		}
<span class="fc" id="L235">		String pwdStr = pwd.asString();</span>
<span class="fc bfc" id="L236" title="All 2 branches covered.">		if (StringUtils.isEmpty(pwdStr)) {</span>
<span class="fc" id="L237">			return null;</span>
		}

<span class="fc" id="L240">		return pwdStr.toCharArray();</span>
	}

	/**
	 * Creates a properties map from all given key/values.
	 * &lt;p&gt;
	 * Example:&lt;br/&gt;
	 * 
	 * &lt;pre&gt;
	 *     {
	 *         &quot;grantType&quot;: &quot;client_credentials&quot;,
	 *         &quot;scope&quot;: &quot;read write&quot;,
	 *         &quot;accessTokenUri&quot;: &quot;https://login-demo.curity.io/oauth/v2/oauth-token&quot;
	 *         &quot;credentials&quot;: {
	 *             &quot;identifier&quot;: &quot;serviceId&quot;,
	 *             &quot;secret&quot;: &quot;ServiceSecret&quot;
	 *         }
	 *     }
	 *
	 *     will be transformed to:
	 *
	 *     grantType -&gt; client_credentials
	 *     scope -&gt; read write
	 *     accessTokenUri -&gt; https://login-demo.curity.io/oauth/v2/oauth-token
	 *     credentials.identifier -&gt; serviceId
	 *     credentials.secret -&gt; ServiceSecret
	 * &lt;/pre&gt;
	 *
	 * @param prefix    the prefix for the direct children
	 * @param fromValue parent JSON value to read from
	 * @param toMap     map to populate
	 */
	private static void buildProperties(String prefix, JsonValue fromValue, Map&lt;String, Object&gt; toMap) {
<span class="fc bfc" id="L273" title="All 2 branches covered.">		if (!isJsonObjectWithMembers(fromValue)) {</span>
<span class="fc" id="L274">			return;</span>
		}
<span class="fc" id="L276">		JsonObject members = fromValue.asObject();</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">		for (String name : members.names()) {</span>
<span class="fc" id="L278">			JsonValue child = members.get(name);</span>
<span class="pc bpc" id="L279" title="1 of 4 branches missed.">			if (child.isArray() || child.isNull()) {</span>
				// currently, not supported or not needed
<span class="fc" id="L281">				continue;</span>
			}
<span class="fc bfc" id="L283" title="All 2 branches covered.">			String key = StringUtils.isEmpty(prefix) ? name : prefix + '.' + name;</span>
<span class="fc bfc" id="L284" title="All 2 branches covered.">			if (child.isObject()) {</span>
<span class="fc" id="L285">				buildProperties(key, child, toMap);</span>
			} else {
<span class="fc bfc" id="L287" title="All 2 branches covered.">				if (child.isString()) {</span>
<span class="fc" id="L288">					toMap.put(key, child.asString());</span>
<span class="fc bfc" id="L289" title="All 2 branches covered.">				} else if (child.isBoolean()) {</span>
<span class="fc" id="L290">					toMap.put(key, child.asBoolean());</span>
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">				} else if (child.isNumber()) {</span>
<span class="fc" id="L292">					toMap.put(key, child.asDouble());</span>
				}
			}
<span class="fc" id="L295">		}</span>
<span class="fc" id="L296">	}</span>

	/**
	 * Checks, if we have a JSON object with members.
	 *
	 * @param jsonValue the value to check
	 * @return true, if we have members in the JSON object
	 */
	private static boolean isJsonObjectWithMembers(JsonValue jsonValue) {
<span class="pc bpc" id="L305" title="3 of 8 branches missed.">		return jsonValue != null &amp;&amp; !jsonValue.isNull() &amp;&amp; jsonValue.isObject() &amp;&amp; !jsonValue.asObject().isEmpty();</span>
	}

	public String getName() {
<span class="fc" id="L309">		return name;</span>
	}

	public String getType() {
<span class="fc" id="L313">		return type;</span>
	}

	public String getIdentifier() {
<span class="fc" id="L317">		return identifier;</span>
	}

	public char[] getSecret() {
<span class="fc" id="L321">		return secret;</span>
	}

	public Map&lt;String, Object&gt; getProperties() {
<span class="fc" id="L325">		return Collections.unmodifiableMap(properties);</span>
	}

	/**
	 * Returns the property as String.
	 *
	 * @param key Name of the property
	 * @return String representation
	 */
	public String getPropertyStr(String key) {
<span class="nc" id="L335">		Object value = getProperties().get(key);</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">		if (value != null) {</span>
<span class="nc" id="L337">			return value.toString();</span>
		}
<span class="nc" id="L339">		return null;</span>
	}

	/**
	 * Returns the property as characters.
	 *
	 * @param key Name of the property
	 * @return char[] representation
	 */
	public char[] getPropertyChars(String key) {
<span class="nc" id="L349">		Object value = getProperties().get(key);</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">		if (value != null) {</span>
<span class="nc" id="L351">			return value.toString().toCharArray();</span>
		}
<span class="nc" id="L353">		return null;</span>
	}

	/**
	 * Returns the property as boolean.
	 *
	 * @param key Name of the property
	 * @return boolean representation
	 */
	public boolean getPropertyBool(String key) {
<span class="nc" id="L363">		Object value = getProperties().get(key);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">		if (value != null) {</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">			if (value instanceof Boolean) {</span>
<span class="nc" id="L366">				return (Boolean) value;</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">			} else if (value instanceof String) {</span>
<span class="nc" id="L368">				return Boolean.parseBoolean((String) value);</span>
			}
		}
<span class="nc" id="L371">		return false;</span>
	}

	/**
	 * Returns the property as Number.
	 *
	 * @param key Name of the property
	 * @return boolean representation
	 */
	public Number getPropertyNum(String key) {
<span class="nc" id="L381">		Object value = getProperties().get(key);</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">		if (value != null) {</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">			if (value instanceof Number) {</span>
<span class="nc" id="L384">				return (Number) value;</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">			} else if (value instanceof String) {</span>
<span class="nc" id="L386">				return Double.parseDouble((String) value);</span>
			}
		}
<span class="nc" id="L389">		return null;</span>
	}

	public Proxy getProxy() {
<span class="fc" id="L393">		return proxy;</span>
	}

	@Override
	public void eraseCredentials() {
<span class="nc bnc" id="L398" title="All 4 branches missed.">		if (secret != null &amp;&amp; secret.length &gt; 0) {</span>
<span class="nc" id="L399">			Arrays.fill(secret, '*');</span>
		}
<span class="nc" id="L401">	}</span>

	@Override
	public boolean equals(Object o) {
<span class="fc bfc" id="L405" title="All 2 branches covered.">		if (this == o)</span>
<span class="fc" id="L406">			return true;</span>
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">		if (!(o instanceof SecurityCredentials))</span>
<span class="nc" id="L408">			return false;</span>
<span class="fc" id="L409">		SecurityCredentials that = (SecurityCredentials) o;</span>
<span class="fc" id="L410">		return getName().equals(that.getName());</span>
	}

	@Override
	public int hashCode() {
<span class="nc" id="L415">		return Objects.hash(getName());</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>