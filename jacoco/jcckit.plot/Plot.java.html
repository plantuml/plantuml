<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Plot.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">plantuml</a> &gt; <a href="index.source.html" class="el_package">jcckit.plot</a> &gt; <span class="el_source">Plot.java</span></div><h1>Plot.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2003-2004, Franz-Josef Elmer, All rights reserved
 *
 * This library is free software; you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation; either version 2.1 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Lesser General Public License for more details
 * (http://www.gnu.org/copyleft/lesser.html).
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
package jcckit.plot;

import java.util.Vector;

import jcckit.data.DataCurve;
import jcckit.data.DataEvent;
import jcckit.data.DataListener;
import jcckit.data.DataPlot;
import jcckit.data.DataPoint;
import jcckit.graphic.ClippingShape;
import jcckit.graphic.GraphPoint;
import jcckit.graphic.GraphicalComposite;
import jcckit.graphic.GraphicalElement;
import jcckit.transformation.Transformation;
import jcckit.util.ConfigParameters;
import jcckit.util.Factory;

/**
 * A plot is determined by a {@link CoordinateSystem}, {@link Curve Curves},
 * an optional annotation layer and an optional {@link Legend}. When rendered
 * these components are draw in this order.
 * &lt;p&gt;
 * Registrated {@link PlotListener PlotListeners} will be informed
 * when the plot changes.
 * &lt;p&gt;
 * A {@link DataPlot} can be connected with a &lt;tt&gt;Plot&lt;/tt&gt; instance.
 * This is done with the method {@link #connect connect()} which registrates
 * this &lt;tt&gt;Plot&lt;/tt&gt; instance as
 * a {@link DataListener} at the connected &lt;tt&gt;DataPlot&lt;/tt&gt;.
 * After an received {@link DataEvent DataEvents} has been handled
 * the registrated &lt;tt&gt;PlotListeners&lt;/tt&gt; will receive a
 * {@link PlotEvent} of the type {@link PlotEventType#DATA_PLOT_CHANGED}.
 *
 * @author Franz-Josef Elmer
 */
public class Plot implements DataListener {
  /** Configuration parameter key. */
  public static final String COORDINATE_SYSTEM_KEY = &quot;coordinateSystem&quot;,
                             CURVE_FACTORY_KEY = &quot;curveFactory&quot;,
                             LEGEND_VISIBLE_KEY = &quot;legendVisible&quot;,
                             LEGEND_KEY = &quot;legend&quot;,
                             INITIAL_HINT_FOR_NEXT_CURVE_KEY
                                      = &quot;initialHintForNextCurve&quot;;
<span class="nc" id="L62">  private final Vector _plotListeners = new Vector();</span>
  private DataPlot _dataPlot;
  private final CurveFactory _curveFactory;
<span class="nc" id="L65">  private final Vector _curves = new Vector();</span>
<span class="nc" id="L66">  private final Vector _nextCurveHints = new Vector();</span>
  private final Hint _initialHintForNextCurve;
  private final Legend _legend;
  private final boolean _legendVisibility;

  private GraphicalElement _coordinateSystemView;
  private ClippingShape _clippingShape;
  private Transformation _transformation;
  private GraphicalElement _annotation;
<span class="nc" id="L75">  private GraphicalComposite _legendView = new GraphicalComposite(null);</span>

  /**
   * Creates an instance from the specified configuration parameters.
   * &lt;table border=1 cellpadding=5&gt;
   * &lt;tr&gt;&lt;th&gt;Key &amp;amp; Default Value&lt;/th&gt;&lt;th&gt;Type&lt;/th&gt;&lt;th&gt;Mandatory&lt;/th&gt;
   *     &lt;th&gt;Description&lt;/th&gt;&lt;/tr&gt;
   * &lt;tr&gt;&lt;td&gt;&lt;tt&gt;coordinateSystem = &lt;/tt&gt;{@link CartesianCoordinateSystem}&lt;/td&gt;
   *     &lt;td&gt;&lt;tt&gt;ConfigParameters&lt;/tt&gt;&lt;/td&gt;&lt;td&gt;no&lt;/td&gt;
   *     &lt;td&gt;Definition of the {@link CoordinateSystem}.&lt;/td&gt;&lt;/tr&gt;
   * &lt;tr&gt;&lt;td&gt;&lt;tt&gt;curveFactory = &lt;/tt&gt;{@link SimpleCurveFactory}&lt;/td&gt;
   *     &lt;td&gt;&lt;tt&gt;ConfigParameters&lt;/tt&gt;&lt;/td&gt;&lt;td&gt;no&lt;/td&gt;
   *     &lt;td&gt;Definition of the {@link CurveFactory}.&lt;/td&gt;&lt;/tr&gt;
   * &lt;tr&gt;&lt;td&gt;&lt;tt&gt;initialHintForNextCurve = null&lt;/tt&gt;&lt;/td&gt;
   *     &lt;td&gt;&lt;tt&gt;ConfigParameters&lt;/tt&gt;&lt;/td&gt;&lt;td&gt;no&lt;/td&gt;
   *     &lt;td&gt;Definition of the initial {@link Hint} which is needed by some
   *         {@link SymbolFactory SymbolFactories} like {@link BarFactory}.
   *         &lt;/td&gt;&lt;/tr&gt;
   * &lt;tr&gt;&lt;td&gt;&lt;tt&gt;legend = &lt;/tt&gt;default values of {@link Legend}&lt;/td&gt;
   *     &lt;td&gt;&lt;tt&gt;ConfigParameters&lt;/tt&gt;&lt;/td&gt;&lt;td&gt;no&lt;/td&gt;
   *     &lt;td&gt;Configuration parameters of a {@link Legend}.&lt;/td&gt;&lt;/tr&gt;
   * &lt;tr&gt;&lt;td&gt;&lt;tt&gt;legendVisible = true&lt;/tt&gt;&lt;/td&gt;
   *     &lt;td&gt;&lt;tt&gt;boolean&lt;/tt&gt;&lt;/td&gt;&lt;td&gt;no&lt;/td&gt;
   *     &lt;td&gt;If &lt;tt&gt;true&lt;/tt&gt; the {@link Legend} will be created.&lt;/td&gt;&lt;/tr&gt;
   * &lt;/table&gt;
   */
<span class="nc" id="L101">  public Plot(ConfigParameters config) {</span>
<span class="nc" id="L102">    CoordinateSystem coordinateSystem = (CoordinateSystem) Factory.create(</span>
<span class="nc" id="L103">        config.getNode(COORDINATE_SYSTEM_KEY),</span>
<span class="nc" id="L104">        CartesianCoordinateSystem.class.getName());</span>
<span class="nc" id="L105">    setCoordinateSystem(coordinateSystem);</span>
<span class="nc" id="L106">    _curveFactory = (CurveFactory) Factory.create(</span>
<span class="nc" id="L107">        config.getNode(CURVE_FACTORY_KEY),</span>
<span class="nc" id="L108">        SimpleCurveFactory.class.getName());</span>
<span class="nc" id="L109">    _initialHintForNextCurve = (Hint) Factory.createOrGet(</span>
<span class="nc" id="L110">                    config.getNode(INITIAL_HINT_FOR_NEXT_CURVE_KEY), null);</span>
<span class="nc" id="L111">    _legend = new Legend(config.getNode(LEGEND_KEY));</span>
<span class="nc" id="L112">    _legendVisibility = config.getBoolean(LEGEND_VISIBLE_KEY, true);</span>
<span class="nc" id="L113">  }</span>

  /**
   * Sets the coordinate system. All curves will be regenerated and a
   * {@link PlotEvent} of type {@link PlotEventType#COODINATE_SYSTEM_CHANGED}
   * will be fired.
   *
   * @param coordinateSystem New coordinate system.
   */
  public void setCoordinateSystem(CoordinateSystem coordinateSystem)
  {
<span class="nc" id="L124">    _coordinateSystemView = coordinateSystem.getView();</span>
<span class="nc" id="L125">    _clippingShape = coordinateSystem.getClippingShape();</span>
<span class="nc" id="L126">    _transformation = coordinateSystem.getTransformation();</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">    if (_dataPlot != null)</span>
    {
<span class="nc" id="L129">      generateCurves(_dataPlot);</span>
    }
<span class="nc" id="L131">    notifyListeners(</span>
        new PlotEvent(this, PlotEventType.COODINATE_SYSTEM_CHANGED, null));
<span class="nc" id="L133">  }</span>

  /**
   * Adds the specified {@link PlotListener}. Does nothing if
   * already added.
   */
  public void addPlotListener(PlotListener listener) {
<span class="nc bnc" id="L140" title="All 2 branches missed.">    if (!_plotListeners.contains(listener)) {</span>
<span class="nc" id="L141">      _plotListeners.addElement(listener);</span>
    }
<span class="nc" id="L143">  }</span>

  /**
   * Removes the specfied {@link PlotListener}. Does nothing if
   * already removed.
   */
  public void removePlotListener(PlotListener listener) {
<span class="nc" id="L150">    _plotListeners.removeElement(listener);</span>
<span class="nc" id="L151">  }</span>

  /**
   * Sends all registrated {@link PlotListener PlotListeners}
   * the specified event.
   */
  protected void notifyListeners(PlotEvent event) {
<span class="nc bnc" id="L158" title="All 2 branches missed.">    for (int i = 0, n = _plotListeners.size(); i &lt; n; i++) {</span>
<span class="nc" id="L159">      ((PlotListener) _plotListeners.elementAt(i)).plotChanged(event);</span>
    }
<span class="nc" id="L161">  }</span>

  /**
   * Connect the specified {@link DataPlot} with this instance.
   * &lt;p&gt;
   * If this &lt;tt&gt;Plot&lt;/tt&gt; instance is already connected with a
   * &lt;tt&gt;DataPlot&lt;/tt&gt; the connection will be released and a
   * {@link PlotEvent} of the type {@link PlotEventType#DATA_PLOT_DISCONNECTED}
   * will be sent to all registrated {@link PlotListener PlotListeners}.
   * &lt;p&gt;
   * It registers itself at &lt;tt&gt;dataPlot&lt;/tt&gt; and
   * all its {@link DataCurve DataCurves}.
   * &lt;p&gt;
   * Finally all curves will be generated and a &lt;tt&gt;PlotEvent&lt;/tt&gt;
   * of the type {@link PlotEventType#DATA_PLOT_CONNECTED} will be transmitted.
   * @param dataPlot Data to be connected with this plot instance.
   *        Can be &lt;tt&gt;null&lt;/tt&gt; in order to disconnect this instance from
   *        any &lt;tt&gt;DataPlot&lt;/tt&gt;.
   */
  public void connect(DataPlot dataPlot) {
<span class="nc bnc" id="L181" title="All 2 branches missed.">    if (_dataPlot != null) {</span>
<span class="nc" id="L182">      _dataPlot.removeDataListener(this);</span>
<span class="nc" id="L183">      notifyListeners(new PlotEvent(this, PlotEventType.DATA_PLOT_DISCONNECTED,</span>
                                    _dataPlot));
    }
<span class="nc" id="L186">    _dataPlot = dataPlot;</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">    if (_dataPlot != null)</span>
    {
<span class="nc" id="L189">      _dataPlot.addDataListener(this);</span>
<span class="nc" id="L190">      generateCurves(_dataPlot);</span>
<span class="nc" id="L191">      notifyListeners(new PlotEvent(this, PlotEventType.DATA_PLOT_CONNECTED,</span>
                                    _dataPlot));
    }
<span class="nc" id="L194">  }</span>

  /**
   * Transforms a point from device-independent coordinates into
   * data coordinates.
   * @param point Point in device-independent coordinates.
   * @return transform &lt;tt&gt;point&lt;/tt&gt;.
   */
  public DataPoint transform(GraphPoint point) {
<span class="nc" id="L203">    return _transformation.transformToData(point);</span>
  }

  /**
   * Creates a graphical representation of the complete plot.
   * @return &lt;tt&gt;GraphicalComposite&lt;/tt&gt; containing the views of the
   * coordinate system, the curves, and optionally the legend (in this order).
   */
  public GraphicalComposite getCompletePlot() {
<span class="nc" id="L212">    GraphicalComposite result = new GraphicalComposite(null);</span>
<span class="nc" id="L213">    result.addElement(_coordinateSystemView);</span>
<span class="nc" id="L214">    GraphicalElement[] curves = getCurves();</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">    for (int i = 0; i &lt; curves.length; i++) {</span>
<span class="nc" id="L216">      result.addElement(curves[i]);</span>
    }
<span class="nc bnc" id="L218" title="All 2 branches missed.">    if (_annotation != null) {</span>
<span class="nc" id="L219">      result.addElement(_annotation);</span>
    }
<span class="nc bnc" id="L221" title="All 2 branches missed.">    if (_legendVisibility) {</span>
<span class="nc" id="L222">      result.addElement(getLegend());</span>
    }
<span class="nc" id="L224">    return result;</span>
  }

  /** Returns the view of the coordinate system. */
  public GraphicalElement getCoordinateSystem() {
<span class="nc" id="L229">    return _coordinateSystemView;</span>
  }

  /** Returns the graphical representations of all curves. */
  public GraphicalElement[] getCurves() {
<span class="nc" id="L234">    synchronized (_curves) {</span>
<span class="nc" id="L235">      GraphicalElement[] curves = new GraphicalElement[_curves.size()];</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">      for (int i = 0; i &lt; curves.length; i++) {</span>
<span class="nc" id="L237">        curves[i] = ((Curve) _curves.elementAt(i)).getView();</span>
      }
<span class="nc" id="L239">      return curves;</span>
    }
  }

  /**
   * Returns the annotation layer.
   * @return &lt;tt&gt;null&lt;/tt&gt; if no annotation layer.
   */
  public GraphicalElement getAnnotation()
  {
<span class="nc" id="L249">    return _annotation;</span>
  }

  /**
   * Sets the annotation layer.
   * @param annotation Any kind of graphics which will be drawn on the
   *        top of the curves but may be covered by the legend.
   *        Can be &lt;tt&gt;null&lt;/tt&gt;.
   */
  public void setAnnotation(GraphicalElement annotation)
  {
<span class="nc" id="L260">    _annotation = annotation;</span>
<span class="nc" id="L261">  }</span>

  /** Returns &lt;tt&gt;true&lt;/tt&gt; if the legend is visible. */
  public boolean isLegendVisible() {
<span class="nc" id="L265">    return _legendVisibility;</span>
  }

  /** Returns the graphical representations of the legend. */
  public GraphicalElement getLegend() {
<span class="nc" id="L270">    return _legendView;</span>
  }

  /**
   * Handles the received {@link DataEvent} and notifies
   * {@link PlotListener PlotListeners} by an event of the type
   * {@link PlotEventType#DATA_CURVE_CHANGED} or
   * {@link PlotEventType#DATA_PLOT_CHANGED}. The following table shows what
   * this method does:
   * &lt;table border=1 cellpadding=5&gt;
   * &lt;tr&gt;&lt;th&gt;Source of &lt;tt&gt;event&lt;/tt&gt;&lt;/th&gt;
   *     &lt;th&gt;All hints for the next curve are &lt;tt&gt;null&lt;/tt&gt;?&lt;/th&gt;
   *     &lt;th&gt;Action&lt;/th&gt;&lt;th&gt;Type of sent {@link PlotEvent}&lt;/th&gt;&lt;/tr&gt;
   * &lt;tr&gt;&lt;td&gt;{@link DataCurve}&lt;/td&gt;&lt;td&gt;Yes&lt;/td&gt;&lt;td&gt;Recreate changed curve.&lt;td&gt;
   *     &lt;td&gt;&lt;tt&gt;DATA_CURVE_CHANGED&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;
   * &lt;tr&gt;&lt;td&gt;{@link DataCurve}&lt;/td&gt;&lt;td&gt;No&lt;/td&gt;&lt;td&gt;Recreate changed curve
   *         and all curves with large curve index.&lt;td&gt;
   *     &lt;td&gt;&lt;tt&gt;DATA_PLOT_CHANGED&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;
   * &lt;tr&gt;&lt;td&gt;{@link DataPlot}&lt;/td&gt;&lt;td&gt;-&lt;/td&gt;&lt;td&gt;Recreate all curves
   *         and {@link Legend} view.&lt;td&gt;
   *     &lt;td&gt;&lt;tt&gt;DATA_PLOT_CHANGED&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;
   * &lt;/table&gt;
   */
  public void dataChanged(DataEvent event) {
<span class="nc" id="L294">    int index = 0;</span>
<span class="nc" id="L295">    PlotEventType type = PlotEventType.DATA_PLOT_CHANGED;</span>
<span class="nc" id="L296">    synchronized (_curves) {</span>
<span class="nc" id="L297">      int numberOfCurves = _curves.size();</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">      if (event.getContainer() instanceof DataCurve</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">          &amp;&amp; numberOfCurves == _dataPlot.getNumberOfElements()) {</span>
<span class="nc" id="L300">        DataCurve curve = (DataCurve) event.getContainer();</span>
<span class="nc" id="L301">        index = curve.getContainer().getIndexOf(curve);</span>
<span class="nc" id="L302">        type = PlotEventType.DATA_CURVE_CHANGED;</span>
<span class="nc" id="L303">        fillCurve(index, curve);</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">        if (index &lt; numberOfCurves - 1) {</span>
<span class="nc" id="L305">          Vector curveHints</span>
<span class="nc" id="L306">              = (Vector) _nextCurveHints.elementAt(index);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">          for (int i = 0, n = curveHints.size(); i &lt; n; i++) {</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">            if (curveHints.elementAt(i) != null) {</span>
<span class="nc" id="L309">              type = PlotEventType.DATA_PLOT_CHANGED;</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">              for (int j = index +1; j &lt; numberOfCurves; j++) {</span>
<span class="nc" id="L311">                fillCurve(j, (DataCurve) _dataPlot.getElement(j));</span>
              }
<span class="nc" id="L313">              break;</span>
            }
          }
        }
<span class="nc" id="L317">      } else {</span>
<span class="nc" id="L318">        generateCurves(_dataPlot);</span>
      }
<span class="nc" id="L320">    }</span>
<span class="nc" id="L321">    notifyListeners(new PlotEvent(Plot.this, type, index));</span>
<span class="nc" id="L322">  }</span>

  /**
   * Generates all curves based on the specified data.
   * In addition the legend view is created.
   */
  private void generateCurves(DataPlot dataPlot) {
<span class="nc" id="L329">    synchronized (_curves) {</span>
<span class="nc" id="L330">      _legendView = new GraphicalComposite(null);</span>
<span class="nc" id="L331">      _legendView.addElement(_legend.getBox());</span>
<span class="nc" id="L332">      _curves.setSize(0);</span>
<span class="nc" id="L333">      _nextCurveHints.setSize(0);</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">      for (int i = 0, n = dataPlot.getNumberOfElements(); i &lt; n; i++) {</span>
<span class="nc" id="L335">        Curve curve = _curveFactory.create(i, n, _clippingShape, _legend);</span>
<span class="nc" id="L336">        _curves.addElement(curve);</span>
<span class="nc" id="L337">        _nextCurveHints.addElement(new Vector());</span>
<span class="nc" id="L338">        DataCurve dataCurve = (DataCurve) dataPlot.getElement(i);</span>
<span class="nc" id="L339">        _legendView.addElement(curve.getLegendSymbol());</span>
<span class="nc" id="L340">        _legendView.addElement(</span>
<span class="nc" id="L341">            _legend.createCurveTitle(i, n, dataCurve.getTitle()));</span>
<span class="nc" id="L342">        fillCurve(i, dataCurve);</span>
      }
<span class="nc" id="L344">    }</span>
<span class="nc" id="L345">  }</span>

  private void fillCurve(int curveIndex, DataCurve dataCurve) {
<span class="nc" id="L348">    Vector curveHints = (Vector) _nextCurveHints.elementAt(curveIndex);</span>
<span class="nc" id="L349">    Curve curve = (Curve) _curves.elementAt(curveIndex);</span>
<span class="nc" id="L350">    curve.removeAllPoints();</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">    for (int i = 0, n = dataCurve.getNumberOfElements(); i &lt; n; i++) {</span>
<span class="nc" id="L352">      setHintForNextCurve(curveHints, i,</span>
<span class="nc" id="L353">          curve.addPoint(_transformation.transformToGraph(</span>
<span class="nc" id="L354">                                          (DataPoint) dataCurve.getElement(i)),</span>
<span class="nc" id="L355">                         getHintForNextCurve(curveIndex - 1, i)));</span>
    }
<span class="nc" id="L357">  }</span>

  private Hint getHintForNextCurve(int curveIndex, int pointIndex) {
<span class="nc" id="L360">    Hint result = _initialHintForNextCurve;</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">    if (curveIndex &gt;= 0) {</span>
<span class="nc" id="L362">      Vector curveHints = (Vector) _nextCurveHints.elementAt(curveIndex);</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">      result = pointIndex &lt; curveHints.size() ?</span>
<span class="nc" id="L364">                   (Hint) curveHints.elementAt(pointIndex)</span>
<span class="nc" id="L365">                   : getHintForNextCurve(curveIndex - 1, pointIndex);</span>
    }
<span class="nc" id="L367">    return result;</span>
  }

  private void setHintForNextCurve(Vector curveHints, int pointIndex,
                                   Hint hint) {
<span class="nc bnc" id="L372" title="All 2 branches missed.">    while (curveHints.size() &lt;= pointIndex) {</span>
<span class="nc" id="L373">      curveHints.addElement(_initialHintForNextCurve);</span>
    }
<span class="nc" id="L375">    curveHints.setElementAt(hint, pointIndex);</span>
<span class="nc" id="L376">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>