<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommandLinkClass.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">plantuml</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.plantuml.classdiagram.command</a> &gt; <span class="el_source">CommandLinkClass.java</span></div><h1>CommandLinkClass.java</h1><pre class="source lang-java linenums">/* ========================================================================
 * PlantUML : a free UML diagram generator
 * ========================================================================
 *
 * (C) Copyright 2009-2024, Arnaud Roques
 *
 * Project Info:  https://plantuml.com
 * 
 * If you like this project or if you find it useful, you can support us at:
 * 
 * https://plantuml.com/patreon (only 1$ per month!)
 * https://plantuml.com/paypal
 * 
 * This file is part of PlantUML.
 *
 * PlantUML is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * PlantUML distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
 * License for more details.
 *
 * You should have received a copy of the GNU General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301,
 * USA.
 *
 *
 * Original Author:  Arnaud Roques
 * Contribution :  Hisashi Miyashita
 *
 *
 */
package net.sourceforge.plantuml.classdiagram.command;

import net.sourceforge.plantuml.StringUtils;
import net.sourceforge.plantuml.abel.Entity;
import net.sourceforge.plantuml.abel.LeafType;
import net.sourceforge.plantuml.abel.Link;
import net.sourceforge.plantuml.abel.LinkArg;
import net.sourceforge.plantuml.command.CommandExecutionResult;
import net.sourceforge.plantuml.command.ParserPass;
import net.sourceforge.plantuml.command.SingleLineCommand2;
import net.sourceforge.plantuml.decoration.LinkDecor;
import net.sourceforge.plantuml.decoration.LinkType;
import net.sourceforge.plantuml.descdiagram.command.CommandLinkElement;
import net.sourceforge.plantuml.descdiagram.command.Labels;
import net.sourceforge.plantuml.klimt.color.ColorParser;
import net.sourceforge.plantuml.klimt.color.ColorType;
import net.sourceforge.plantuml.klimt.color.NoSuchColorException;
import net.sourceforge.plantuml.klimt.creole.Display;
import net.sourceforge.plantuml.objectdiagram.AbstractClassOrObjectDiagram;
import net.sourceforge.plantuml.plasma.Quark;
import net.sourceforge.plantuml.project.Failable;
import net.sourceforge.plantuml.regex.RegexConcat;
import net.sourceforge.plantuml.regex.RegexLeaf;
import net.sourceforge.plantuml.regex.RegexOptional;
import net.sourceforge.plantuml.regex.RegexOr;
import net.sourceforge.plantuml.regex.RegexResult;
import net.sourceforge.plantuml.skin.UmlDiagramType;
import net.sourceforge.plantuml.url.Url;
import net.sourceforge.plantuml.url.UrlBuilder;
import net.sourceforge.plantuml.url.UrlMode;
import net.sourceforge.plantuml.utils.Direction;
import net.sourceforge.plantuml.utils.LineLocation;

final public class CommandLinkClass extends SingleLineCommand2&lt;AbstractClassOrObjectDiagram&gt; {

	private static final String SINGLE = &quot;[.\\\\]{0,2}[%pLN_]+(?:[.\\\\]{1,2}[%pLN_]+)*&quot;;
	private static final String SINGLE_GUILLEMENT = &quot;[%g][.\\\\]{0,2}[%pLN_]+(?:[.\\\\]{1,2}[%pLN_]+)*[%g]&quot;;
	private static final String SINGLE2 = &quot;(?:&quot; + SINGLE + &quot;|&quot; + SINGLE_GUILLEMENT + &quot;)&quot;;
	private static final String COUPLE = &quot;\\([%s]*(&quot; + SINGLE2 + &quot;)[%s]*,[%s]*(&quot; + SINGLE2 + &quot;)[%s]*\\)&quot;;

	public CommandLinkClass(UmlDiagramType umlDiagramType) {
<span class="fc" id="L78">		super(getRegexConcat(umlDiagramType));</span>
<span class="fc" id="L79">	}</span>

	static private RegexConcat getRegexConcat(UmlDiagramType umlDiagramType) {
<span class="fc" id="L82">		return RegexConcat.build(CommandLinkClass.class.getName() + umlDiagramType, RegexLeaf.start(), //</span>
				new RegexOptional( //
						new RegexConcat( //
								new RegexLeaf(1, &quot;HEADER&quot;, &quot;@([\\d.]+)&quot;), //
<span class="fc" id="L86">								RegexLeaf.spaceOneOrMore() //</span>
						)), new RegexOr( //
<span class="fc" id="L88">								new RegexLeaf(1, &quot;ENT1&quot;, getClassIdentifier()), //</span>
								new RegexLeaf(2, &quot;COUPLE1&quot;, COUPLE)), //

<span class="fc" id="L91">				RegexLeaf.spaceZeroOrMore(), //</span>

				new RegexOptional(new RegexConcat( //
<span class="fc" id="L94">						RegexLeaf.spaceOneOrMore(), //</span>
						new RegexLeaf(&quot;[\\[]&quot;), //
						new RegexLeaf(1, &quot;QUALIFIER1&quot;, &quot;([^\\[\\]]+)&quot;), //
						new RegexLeaf(&quot;[\\]]&quot;), //
<span class="fc" id="L98">						RegexLeaf.spaceOneOrMore() //</span>
				)), //
				new RegexOptional(new RegexLeaf(1, &quot;FIRST_LABEL&quot;, &quot;[%g]([^%g]+)[%g]&quot;)), //

<span class="fc" id="L102">				RegexLeaf.spaceZeroOrMore(), //</span>

				new RegexConcat(//
<span class="fc" id="L105">						new RegexLeaf(1, &quot;ARROW_HEAD1&quot;, LinkDecor.getRegexDecors1()), //</span>
						new RegexLeaf(1, &quot;ARROW_BODY1&quot;, &quot;([-=.]+)&quot;), //
						new RegexLeaf(1, &quot;ARROW_STYLE1&quot;, &quot;(?:\\[(&quot; + CommandLinkElement.LINE_STYLE + &quot;)\\])?&quot;), //
						new RegexLeaf(1, &quot;ARROW_DIRECTION&quot;, &quot;(left|right|up|down|le?|ri?|up?|do?)?&quot;), //
						new RegexOptional(new RegexLeaf(1, &quot;INSIDE&quot;, &quot;(0|\\(0\\)|\\(0|0\\))(?=[-=.~])&quot;)), //
						new RegexLeaf(1, &quot;ARROW_STYLE2&quot;, &quot;(?:\\[(&quot; + CommandLinkElement.LINE_STYLE + &quot;)\\])?&quot;), //
						new RegexLeaf(1, &quot;ARROW_BODY2&quot;, &quot;([-=.]*)&quot;), //
<span class="fc" id="L112">						new RegexLeaf(1, &quot;ARROW_HEAD2&quot;, LinkDecor.getRegexDecors2())), //</span>

<span class="fc" id="L114">				RegexLeaf.spaceZeroOrMore(), //</span>

				new RegexOptional(new RegexLeaf(1, &quot;SECOND_LABEL&quot;, &quot;[%g]([^%g]+)[%g]&quot;)), //
				new RegexOptional(new RegexConcat( //
<span class="fc" id="L118">						RegexLeaf.spaceOneOrMore(), //</span>
						new RegexLeaf(&quot;[\\[]&quot;), //
						new RegexLeaf(1, &quot;QUALIFIER2&quot;, &quot;([^\\[\\]]+)&quot;), //
						new RegexLeaf(&quot;[\\]]&quot;), //
<span class="fc" id="L122">						RegexLeaf.spaceOneOrMore() //</span>
				)), //

<span class="fc" id="L125">				RegexLeaf.spaceZeroOrMore(), //</span>

				new RegexOr( //
<span class="fc" id="L128">						new RegexLeaf(1, &quot;ENT2&quot;, getClassIdentifier()), //</span>
						new RegexLeaf(2, &quot;COUPLE2&quot;, COUPLE)), //
<span class="fc" id="L130">				RegexLeaf.spaceZeroOrMore(), //</span>
<span class="fc" id="L131">				color().getRegex(), //</span>
<span class="fc" id="L132">				RegexLeaf.spaceZeroOrMore(), //</span>
				UrlBuilder.OPTIONAL, //
<span class="fc" id="L134">				RegexLeaf.spaceZeroOrMore(), //</span>
				new RegexOptional( //
						new RegexConcat( //
								new RegexLeaf(&quot;:&quot;), //
<span class="fc" id="L138">								RegexLeaf.spaceZeroOrMore(), //</span>
								new RegexLeaf(1, &quot;LABEL_LINK&quot;, &quot;(.+)&quot;) //
<span class="fc" id="L140">						)), RegexLeaf.end());</span>
	}

	private static ColorParser color() {
<span class="fc" id="L144">		return ColorParser.simpleColor(ColorType.LINE);</span>
	}

	private static String getClassIdentifier() {
<span class="fc" id="L148">		return &quot;(&quot; + getSeparator() + &quot;?[%pLN_$]+(?:&quot; + getSeparator() + &quot;[%pLN_$]+)*|[%g][^%g]+[%g])&quot;;</span>
	}

	public static String getSeparator() {
<span class="fc" id="L152">		return &quot;(?:\\.|::|\\\\|\\\\\\\\)&quot;;</span>
	}

	@Override
	protected CommandExecutionResult executeArg(AbstractClassOrObjectDiagram diagram, LineLocation location,
			RegexResult arg, ParserPass currentPass) throws NoSuchColorException {
<span class="fc" id="L158">		String ent1String = diagram.cleanId(arg.get(&quot;ENT1&quot;, 0));</span>
<span class="fc" id="L159">		String ent2String = diagram.cleanId(arg.get(&quot;ENT2&quot;, 0));</span>
<span class="pc bpc" id="L160" title="3 of 4 branches missed.">		if (ent1String == null &amp;&amp; ent2String == null)</span>
<span class="nc" id="L161">			return executeArgSpecial3(location, diagram, arg);</span>

<span class="pc bpc" id="L163" title="1 of 2 branches missed.">		if (ent1String == null)</span>
<span class="nc" id="L164">			return executeArgSpecial1(location, diagram, arg);</span>

<span class="pc bpc" id="L166" title="1 of 2 branches missed.">		if (ent2String == null)</span>
<span class="nc" id="L167">			return executeArgSpecial2(location, diagram, arg);</span>

<span class="fc" id="L169">		String port1 = null;</span>
<span class="fc" id="L170">		String port2 = null;</span>
<span class="fc" id="L171">		final LinkType linkType = getLinkType(arg);</span>
<span class="pc bpc" id="L172" title="3 of 4 branches missed.">		if (ent1String.contains(&quot;::&quot;) &amp;&amp; diagram.firstWithName(ent1String) == null) {</span>
<span class="nc" id="L173">			port1 = diagram.getPortId(ent1String);</span>
<span class="nc" id="L174">			ent1String = diagram.removePortId(ent1String);</span>
		}

<span class="pc bpc" id="L177" title="3 of 4 branches missed.">		if (ent2String.contains(&quot;::&quot;) &amp;&amp; diagram.firstWithName(ent2String) == null) {</span>
<span class="nc" id="L178">			port2 = diagram.getPortId(ent2String);</span>
<span class="nc" id="L179">			ent2String = diagram.removePortId(ent2String);</span>
		}

<span class="fc" id="L182">		final Failable&lt;Quark&lt;Entity&gt;&gt; quark1 = diagram.quarkInContextSafe(true, ent1String);</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">		if (quark1.isFail())</span>
<span class="nc" id="L184">			return CommandExecutionResult.error(quark1.getError());</span>
<span class="fc" id="L185">		final Failable&lt;Quark&lt;Entity&gt;&gt; quark2 = diagram.quarkInContextSafe(true, ent2String);</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">		if (quark2.isFail())</span>
<span class="nc" id="L187">			return CommandExecutionResult.error(quark2.getError());</span>

<span class="fc" id="L189">		Entity cl1 = quark1.get().getData();</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">		if (cl1 == null)</span>
<span class="fc" id="L191">			cl1 = diagram.reallyCreateLeaf(location, quark1.get(),</span>
<span class="fc" id="L192">					Display.getWithNewlines(diagram.getPragma(), quark1.get().getName()), LeafType.CLASS, null);</span>
<span class="fc" id="L193">		Entity cl2 = quark2.get().getData();</span>
<span class="fc bfc" id="L194" title="All 2 branches covered.">		if (cl2 == null)</span>
<span class="fc" id="L195">			cl2 = diagram.reallyCreateLeaf(location, quark2.get(),</span>
<span class="fc" id="L196">					Display.getWithNewlines(diagram.getPragma(), quark2.get().getName()), LeafType.CLASS, null);</span>

<span class="fc" id="L198">		final Direction dir = getDirection(arg);</span>
		final int queue;
<span class="fc bfc" id="L200" title="All 4 branches covered.">		if (dir == Direction.LEFT || dir == Direction.RIGHT)</span>
<span class="fc" id="L201">			queue = 1;</span>
		else
<span class="fc" id="L203">			queue = getQueueLength(arg);</span>

<span class="fc" id="L205">		final Labels labels = new Labels(arg);</span>

<span class="fc" id="L207">		final String kal1 = arg.get(&quot;QUALIFIER1&quot;, 0);</span>
<span class="fc" id="L208">		final String kal2 = arg.get(&quot;QUALIFIER2&quot;, 0);</span>

<span class="fc" id="L210">		final LinkArg linkArg = LinkArg</span>
<span class="fc" id="L211">				.build(labels.getDisplay(diagram.getPragma()), queue,</span>
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">						diagram.getSkinParam().classAttributeIconSize() &gt; 0)</span>
<span class="fc" id="L213">				.withQuantifier(labels.getFirstLabel(), labels.getSecondLabel())</span>
<span class="fc" id="L214">				.withDistanceAngle(diagram.getLabeldistance(), diagram.getLabelangle()).withKal(kal1, kal2);</span>

<span class="fc" id="L216">		Link link = new Link(location, diagram, diagram.getSkinParam().getCurrentStyleBuilder(), cl1, cl2, linkType,</span>
				linkArg);
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">		if (arg.get(&quot;URL&quot;, 0) != null) {</span>
<span class="nc" id="L219">			final UrlBuilder urlBuilder = new UrlBuilder(diagram.getSkinParam().getValue(&quot;topurl&quot;), UrlMode.STRICT);</span>
<span class="nc" id="L220">			final Url url = urlBuilder.getUrl(arg.get(&quot;URL&quot;, 0));</span>
<span class="nc" id="L221">			link.setUrl(url);</span>
		}
<span class="fc" id="L223">		link.setPortMembers(port1, port2);</span>

<span class="fc bfc" id="L225" title="All 4 branches covered.">		if (dir == Direction.LEFT || dir == Direction.UP)</span>
<span class="fc" id="L226">			link = link.getInv();</span>

<span class="fc" id="L228">		link.setLinkArrow(labels.getLinkArrow());</span>
<span class="fc" id="L229">		link.setColors(color().getColor(arg, diagram.getSkinParam().getIHtmlColorSet()));</span>
<span class="fc" id="L230">		link.applyStyle(arg.getLazzy(&quot;ARROW_STYLE&quot;, 0));</span>
<span class="fc" id="L231">		link.setCodeLine(location);</span>

<span class="fc" id="L233">		addLink(diagram, link, arg.get(&quot;HEADER&quot;, 0));</span>

<span class="fc" id="L235">		return CommandExecutionResult.ok();</span>
	}

	private void addLink(AbstractClassOrObjectDiagram diagram, Link link, String weight) {
<span class="fc" id="L239">		diagram.addLink(link);</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">		if (weight != null)</span>
<span class="nc" id="L241">			link.setWeight(Double.parseDouble(weight));</span>

<span class="fc" id="L243">	}</span>

	private CommandExecutionResult executeArgSpecial1(LineLocation location, AbstractClassOrObjectDiagram diagram,
			RegexResult arg) {
<span class="nc" id="L247">		final String name1A = StringUtils.eventuallyRemoveStartingAndEndingDoubleQuote(arg.get(&quot;COUPLE1&quot;, 0));</span>
<span class="nc" id="L248">		final String name1B = StringUtils.eventuallyRemoveStartingAndEndingDoubleQuote(arg.get(&quot;COUPLE1&quot;, 1));</span>

<span class="nc" id="L250">		final Quark&lt;Entity&gt; quark1A = diagram.quarkInContext(true, name1A);</span>
<span class="nc" id="L251">		final Quark&lt;Entity&gt; quark1B = diagram.quarkInContext(true, name1B);</span>

<span class="nc bnc" id="L253" title="All 4 branches missed.">		if (quark1A.getData() != null == false)</span>
<span class="nc" id="L254">			return CommandExecutionResult.error(&quot;No class &quot; + name1A);</span>

<span class="nc bnc" id="L256" title="All 4 branches missed.">		if (quark1B.getData() != null == false)</span>
<span class="nc" id="L257">			return CommandExecutionResult.error(&quot;No class &quot; + name1B);</span>

<span class="nc" id="L259">		final Entity cl1A = quark1A.getData();</span>
<span class="nc" id="L260">		final Entity cl1B = quark1B.getData();</span>

<span class="nc" id="L262">		final String id2 = StringUtils.eventuallyRemoveStartingAndEndingDoubleQuote(arg.get(&quot;ENT2&quot;, 0), &quot;\&quot;&quot;);</span>
<span class="nc" id="L263">		final Quark&lt;Entity&gt; ent2 = diagram.quarkInContext(true, id2);</span>

<span class="nc" id="L265">		Entity cl2 = ent2.getData();</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">		if (cl2 == null)</span>
<span class="nc" id="L267">			cl2 = diagram.reallyCreateLeaf(location, ent2, Display.getWithNewlines(diagram.getPragma(), ent2.getName()),</span>
					LeafType.CLASS, null);

<span class="nc" id="L270">		final LinkType linkType = getLinkType(arg);</span>
<span class="nc" id="L271">		final Display label = Display.getWithNewlines(diagram.getPragma(), arg.get(&quot;LABEL_LINK&quot;, 0));</span>

<span class="nc" id="L273">		final boolean result = diagram.associationClass(location, 1, cl1A, cl1B, cl2, linkType, label);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">		if (result == false)</span>
<span class="nc" id="L275">			return CommandExecutionResult.error(&quot;Cannot have more than 2 assocications&quot;);</span>

<span class="nc" id="L277">		return CommandExecutionResult.ok();</span>
	}

	private CommandExecutionResult executeArgSpecial2(LineLocation location, AbstractClassOrObjectDiagram diagram,
			RegexResult arg) {
<span class="nc" id="L282">		final String name2A = StringUtils.eventuallyRemoveStartingAndEndingDoubleQuote(arg.get(&quot;COUPLE2&quot;, 0));</span>
<span class="nc" id="L283">		final String name2B = StringUtils.eventuallyRemoveStartingAndEndingDoubleQuote(arg.get(&quot;COUPLE2&quot;, 1));</span>

<span class="nc" id="L285">		final Quark&lt;Entity&gt; quark2A = diagram.quarkInContext(true, name2A);</span>
<span class="nc" id="L286">		final Quark&lt;Entity&gt; quark2B = diagram.quarkInContext(true, name2B);</span>

<span class="nc bnc" id="L288" title="All 4 branches missed.">		if (quark2A.getData() != null == false)</span>
<span class="nc" id="L289">			return CommandExecutionResult.error(&quot;No class &quot; + name2A);</span>

<span class="nc bnc" id="L291" title="All 4 branches missed.">		if (quark2B.getData() != null == false)</span>
<span class="nc" id="L292">			return CommandExecutionResult.error(&quot;No class &quot; + name2B);</span>

<span class="nc" id="L294">		final Entity cl2A = quark2A.getData();</span>
<span class="nc" id="L295">		final Entity cl2B = quark2B.getData();</span>

<span class="nc" id="L297">		final String id1 = StringUtils.eventuallyRemoveStartingAndEndingDoubleQuote(arg.get(&quot;ENT1&quot;, 0), &quot;\&quot;&quot;);</span>
<span class="nc" id="L298">		final Quark&lt;Entity&gt; ent1 = diagram.quarkInContext(true, id1);</span>

<span class="nc" id="L300">		Entity cl1 = (Entity) ent1.getData();</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">		if (cl1 == null)</span>
<span class="nc" id="L302">			cl1 = diagram.reallyCreateLeaf(location, ent1, Display.getWithNewlines(diagram.getPragma(), ent1.getName()),</span>
					LeafType.CLASS, null);

<span class="nc" id="L305">		final LinkType linkType = getLinkType(arg);</span>
<span class="nc" id="L306">		final Display label = Display.getWithNewlines(diagram.getPragma(), arg.get(&quot;LABEL_LINK&quot;, 0));</span>

<span class="nc" id="L308">		final boolean result = diagram.associationClass(location, 2, cl2A, cl2B, cl1, linkType, label);</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">		if (result == false)</span>
<span class="nc" id="L310">			return CommandExecutionResult.error(&quot;Cannot have more than 2 assocications&quot;);</span>

<span class="nc" id="L312">		return CommandExecutionResult.ok();</span>
	}

	private CommandExecutionResult executeArgSpecial3(LineLocation location, AbstractClassOrObjectDiagram diagram,
			RegexResult arg) {

<span class="nc" id="L318">		final String name1A = StringUtils.eventuallyRemoveStartingAndEndingDoubleQuote(arg.get(&quot;COUPLE1&quot;, 0));</span>
<span class="nc" id="L319">		final String name1B = StringUtils.eventuallyRemoveStartingAndEndingDoubleQuote(arg.get(&quot;COUPLE1&quot;, 1));</span>
<span class="nc" id="L320">		final String name2A = StringUtils.eventuallyRemoveStartingAndEndingDoubleQuote(arg.get(&quot;COUPLE2&quot;, 0));</span>
<span class="nc" id="L321">		final String name2B = StringUtils.eventuallyRemoveStartingAndEndingDoubleQuote(arg.get(&quot;COUPLE2&quot;, 1));</span>

<span class="nc" id="L323">		final Quark&lt;Entity&gt; quark1A = diagram.quarkInContext(true, name1A);</span>
<span class="nc" id="L324">		final Quark&lt;Entity&gt; quark1B = diagram.quarkInContext(true, name1B);</span>
<span class="nc" id="L325">		final Quark&lt;Entity&gt; quark2A = diagram.quarkInContext(true, name2A);</span>
<span class="nc" id="L326">		final Quark&lt;Entity&gt; quark2B = diagram.quarkInContext(true, name2B);</span>

<span class="nc bnc" id="L328" title="All 4 branches missed.">		if (quark1A.getData() != null == false)</span>
<span class="nc" id="L329">			return CommandExecutionResult.error(&quot;No class &quot; + name1A);</span>
<span class="nc bnc" id="L330" title="All 4 branches missed.">		if (quark1B.getData() != null == false)</span>
<span class="nc" id="L331">			return CommandExecutionResult.error(&quot;No class &quot; + name1B);</span>
<span class="nc bnc" id="L332" title="All 4 branches missed.">		if (quark2A.getData() != null == false)</span>
<span class="nc" id="L333">			return CommandExecutionResult.error(&quot;No class &quot; + name2A);</span>
<span class="nc bnc" id="L334" title="All 4 branches missed.">		if (quark2B.getData() != null == false)</span>
<span class="nc" id="L335">			return CommandExecutionResult.error(&quot;No class &quot; + name2B);</span>

<span class="nc" id="L337">		final Entity cl1A = (Entity) quark1A.getData();</span>
<span class="nc" id="L338">		final Entity cl1B = (Entity) quark1B.getData();</span>
<span class="nc" id="L339">		final Entity cl2A = (Entity) quark2A.getData();</span>
<span class="nc" id="L340">		final Entity cl2B = (Entity) quark2B.getData();</span>

<span class="nc" id="L342">		final LinkType linkType = getLinkType(arg);</span>
<span class="nc" id="L343">		final Display label = Display.getWithNewlines(diagram.getPragma(), arg.get(&quot;LABEL_LINK&quot;, 0));</span>

<span class="nc" id="L345">		return diagram.associationClass(location, cl1A, cl1B, cl2A, cl2B, linkType, label);</span>
	}

	private LinkType getLinkType(RegexResult arg) {
<span class="fc" id="L349">		final LinkDecor decors1 = LinkDecor.lookupDecors1(getArrowHead1(arg));</span>
<span class="fc" id="L350">		final LinkDecor decors2 = LinkDecor.lookupDecors2(getArrowHead2(arg));</span>

<span class="fc" id="L352">		LinkType result = new LinkType(decors2, decors1);</span>
<span class="pc bpc" id="L353" title="1 of 4 branches missed.">		if (arg.get(&quot;ARROW_BODY1&quot;, 0).contains(&quot;.&quot;) || arg.get(&quot;ARROW_BODY2&quot;, 0).contains(&quot;.&quot;))</span>
<span class="fc" id="L354">			result = result.goDashed();</span>

<span class="fc" id="L356">		final String middle = arg.get(&quot;INSIDE&quot;, 0);</span>
<span class="pc bpc" id="L357" title="1 of 2 branches missed.">		if (&quot;0&quot;.equals(middle))</span>
<span class="nc" id="L358">			result = result.withMiddleCircle();</span>
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">		else if (&quot;0)&quot;.equals(middle))</span>
<span class="nc" id="L360">			result = result.withMiddleCircleCircled1();</span>
<span class="pc bpc" id="L361" title="1 of 2 branches missed.">		else if (&quot;(0&quot;.equals(middle))</span>
<span class="nc" id="L362">			result = result.withMiddleCircleCircled2();</span>
<span class="pc bpc" id="L363" title="1 of 2 branches missed.">		else if (&quot;(0)&quot;.equals(middle))</span>
<span class="nc" id="L364">			result = result.withMiddleCircleCircled();</span>

<span class="fc" id="L366">		return result;</span>
	}

	private int getQueueLength(RegexResult arg) {
<span class="fc" id="L370">		String s = getFullArrow(arg);</span>
<span class="fc" id="L371">		s = s.replaceAll(&quot;[^-.=]&quot;, &quot;&quot;);</span>
<span class="fc" id="L372">		return s.length();</span>
	}

	private Direction getDirection(RegexResult arg) {
<span class="fc" id="L376">		String s = getFullArrow(arg);</span>
<span class="fc" id="L377">		s = s.replaceAll(&quot;[^-.=\\w]&quot;, &quot;&quot;);</span>
<span class="fc bfc" id="L378" title="All 2 branches covered.">		if (s.startsWith(&quot;o&quot;))</span>
<span class="fc" id="L379">			s = s.substring(1);</span>

<span class="pc bpc" id="L381" title="1 of 2 branches missed.">		if (s.endsWith(&quot;o&quot;))</span>
<span class="nc" id="L382">			s = s.substring(0, s.length() - 1);</span>

<span class="fc" id="L384">		return StringUtils.getQueueDirection(s);</span>
	}

	private String getArrowHead1(RegexResult arg) {
<span class="fc" id="L388">		return getArrowHead(arg, &quot;ARROW_HEAD1&quot;);</span>
	}

	private String getArrowHead2(RegexResult arg) {
<span class="fc" id="L392">		return getArrowHead(arg, &quot;ARROW_HEAD2&quot;);</span>
	}

	private String getArrowHead(RegexResult arg, final String key) {
<span class="fc" id="L396">		return notNull(arg.get(key, 0)).replaceAll(&quot;_&quot;, &quot;&quot;);</span>
	}

	private String getFullArrow(RegexResult arg) {
<span class="fc" id="L400">		return getArrowHead1(arg) + notNull(arg.get(&quot;ARROW_BODY1&quot;, 0)) + notNull(arg.get(&quot;ARROW_DIRECTION&quot;, 0))</span>
<span class="fc" id="L401">				+ notNull(arg.get(&quot;ARROW_BODY2&quot;, 0)) + getArrowHead2(arg);</span>
	}

	public static String notNull(String s) {
<span class="fc bfc" id="L405" title="All 2 branches covered.">		if (s == null)</span>
<span class="fc" id="L406">			return &quot;&quot;;</span>
<span class="fc" id="L407">		return s;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>