<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MacroBlock.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">plantuml</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.plantuml.webp</a> &gt; <span class="el_source">MacroBlock.java</span></div><h1>MacroBlock.java</h1><pre class="source lang-java linenums">/*	This file is part of javavp8decoder.

    javavp8decoder is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    javavp8decoder is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with javavp8decoder.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package net.sourceforge.plantuml.webp;

import java.io.IOException;

public class MacroBlock {

	private int filterLevel;
<span class="nc" id="L23">	private boolean keepDebugInfo = false;</span>
	private int segmentId;
	private int skipCoeff;
	private boolean skipInnerLoopFilter;
	SubBlock[][] uSubBlocks;
	private int uVFilterLevel;

	private int uvMode;
	SubBlock[][] vSubBlocks;
	private int x, y;
	SubBlock y2SubBlock;
	private int yMode;
	SubBlock[][] ySubBlocks;

<span class="nc" id="L37">	MacroBlock(int x, int y, boolean keepDebugInfo) {</span>
<span class="nc" id="L38">		this.x = x - 1;</span>
<span class="nc" id="L39">		this.y = y - 1;</span>
<span class="nc" id="L40">		this.keepDebugInfo = keepDebugInfo;</span>

<span class="nc" id="L42">		ySubBlocks = new SubBlock[4][4];</span>
<span class="nc" id="L43">		uSubBlocks = new SubBlock[2][2];</span>
<span class="nc" id="L44">		vSubBlocks = new SubBlock[2][2];</span>
<span class="nc" id="L45">		SubBlock above = null;</span>
<span class="nc" id="L46">		SubBlock left = null;</span>

<span class="nc bnc" id="L48" title="All 2 branches missed.">		for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">			for (int j = 0; j &lt; 4; j++) {</span>
<span class="nc" id="L50">				left = null;</span>
<span class="nc" id="L51">				above = null;</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">				if (j &gt; 0)</span>
<span class="nc" id="L53">					left = ySubBlocks[j - 1][i];</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">				if (i &gt; 0)</span>
<span class="nc" id="L55">					above = ySubBlocks[j][i - 1];</span>
<span class="nc" id="L56">				ySubBlocks[j][i] = new SubBlock(this, above, left, SubBlock.PLANE.Y1);</span>
			}
		}

<span class="nc bnc" id="L60" title="All 2 branches missed.">		for (int i = 0; i &lt; 2; i++) {</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">			for (int j = 0; j &lt; 2; j++) {</span>
<span class="nc" id="L62">				left = null;</span>
<span class="nc" id="L63">				above = null;</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">				if (j &gt; 0)</span>
<span class="nc" id="L65">					left = uSubBlocks[j - 1][i];</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">				if (i &gt; 0)</span>
<span class="nc" id="L67">					above = uSubBlocks[j][i - 1];</span>
<span class="nc" id="L68">				uSubBlocks[j][i] = new SubBlock(this, above, left, SubBlock.PLANE.U);</span>
			}
		}

<span class="nc bnc" id="L72" title="All 2 branches missed.">		for (int i = 0; i &lt; 2; i++) {</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">			for (int j = 0; j &lt; 2; j++) {</span>
<span class="nc" id="L74">				left = null;</span>
<span class="nc" id="L75">				above = null;</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">				if (j &gt; 0)</span>
<span class="nc" id="L77">					left = vSubBlocks[j - 1][i];</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">				if (i &gt; 0)</span>
<span class="nc" id="L79">					above = vSubBlocks[j][i - 1];</span>
<span class="nc" id="L80">				vSubBlocks[j][i] = new SubBlock(this, above, left, SubBlock.PLANE.V);</span>
			}
		}
<span class="nc" id="L83">		y2SubBlock = new SubBlock(this, null, null, SubBlock.PLANE.Y2);</span>

<span class="nc" id="L85">	}</span>

	public void decodeMacroBlock(VP8Frame frame) throws IOException {
<span class="nc" id="L88">		MacroBlock mb = this;</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">		if (mb.getSkipCoeff() &gt; 0) {</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">			if (mb.getYMode() != Globals.B_PRED)</span>
<span class="nc" id="L91">				mb.skipInnerLoopFilter = true;</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">		} else if (mb.getYMode() != Globals.B_PRED) {</span>
<span class="nc" id="L93">			decodeMacroBlockTokens(frame, true);</span>
		} else {
<span class="nc" id="L95">			decodeMacroBlockTokens(frame, false);</span>
		}
<span class="nc" id="L97">	}</span>

	private void decodeMacroBlockTokens(VP8Frame frame, boolean withY2) throws IOException {
<span class="nc" id="L100">		skipInnerLoopFilter = false;</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">		if (withY2) {</span>
<span class="nc" id="L102">			skipInnerLoopFilter = skipInnerLoopFilter | decodePlaneTokens(frame, 1, SubBlock.PLANE.Y2, false);</span>
		}
<span class="nc" id="L104">		skipInnerLoopFilter = skipInnerLoopFilter | decodePlaneTokens(frame, 4, SubBlock.PLANE.Y1, withY2);</span>
<span class="nc" id="L105">		skipInnerLoopFilter = skipInnerLoopFilter | decodePlaneTokens(frame, 2, SubBlock.PLANE.U, false);</span>
<span class="nc" id="L106">		skipInnerLoopFilter = skipInnerLoopFilter | decodePlaneTokens(frame, 2, SubBlock.PLANE.V, false);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">		skipInnerLoopFilter = !skipInnerLoopFilter;</span>
<span class="nc" id="L108">	}</span>

	private boolean decodePlaneTokens(VP8Frame frame, int dimentions, SubBlock.PLANE plane, boolean withY2)
			throws IOException {
<span class="nc" id="L112">		MacroBlock mb = this;</span>
<span class="nc" id="L113">		boolean r = false;</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">		for (int y = 0; y &lt; dimentions; y++) {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">			for (int x = 0; x &lt; dimentions; x++) {</span>
<span class="nc" id="L116">				int L = 0;</span>
<span class="nc" id="L117">				int A = 0;</span>
<span class="nc" id="L118">				int lc = 0;</span>
<span class="nc" id="L119">				SubBlock sb = mb.getSubBlock(plane, x, y);</span>
<span class="nc" id="L120">				SubBlock left = frame.getLeftSubBlock(sb, plane);</span>
<span class="nc" id="L121">				SubBlock above = frame.getAboveSubBlock(sb, plane);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">				if (left.hasNoZeroToken()) {</span>

<span class="nc" id="L124">					L = 1;</span>
				}

<span class="nc" id="L127">				lc += L;</span>

<span class="nc bnc" id="L129" title="All 2 branches missed.">				if (above.hasNoZeroToken()) {</span>

<span class="nc" id="L131">					A = 1;</span>
				}

<span class="nc" id="L134">				lc += A;</span>
<span class="nc" id="L135">				sb.decodeSubBlock(frame.getTokenBoolDecoder(), frame.getCoefProbs(), lc,</span>
<span class="nc" id="L136">						SubBlock.planeToType(plane, withY2), withY2);</span>
<span class="nc" id="L137">				r = r | sb.hasNoZeroToken();</span>
			}
		}
<span class="nc" id="L140">		return r;</span>
	}

	public void dequantMacroBlock(VP8Frame frame) {
<span class="nc" id="L144">		MacroBlock mb = this;</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">		if (mb.getYMode() != Globals.B_PRED) {</span>
<span class="nc" id="L146">			SubBlock sb = mb.getY2SubBlock();</span>
<span class="nc" id="L147">			int acQValue = frame.getSegmentQuants().getSegQuants()[this.getSegmentId()].getY2ac_delta_q();</span>
<span class="nc" id="L148">			int dcQValue = frame.getSegmentQuants().getSegQuants()[this.getSegmentId()].getY2dc();</span>

<span class="nc" id="L150">			int input[] = new int[16];</span>
<span class="nc" id="L151">			input[0] = sb.getTokens()[0] * dcQValue;</span>

<span class="nc bnc" id="L153" title="All 2 branches missed.">			for (int x = 1; x &lt; 16; x++)</span>
<span class="nc" id="L154">				input[x] = sb.getTokens()[x] * acQValue;</span>

<span class="nc" id="L156">			sb.setDiff(IDCT.iwalsh4x4(input));</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">			for (int j = 0; j &lt; 4; j++) {</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">				for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L159">					SubBlock ysb = mb.getYSubBlock(i, j);</span>
<span class="nc" id="L160">					ysb.dequantSubBlock(frame, sb.getDiff()[i][j]);</span>
				}
			}

<span class="nc" id="L164">			mb.predictY(frame);</span>
<span class="nc" id="L165">			mb.predictUV(frame);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">			for (int i = 0; i &lt; 2; i++) {</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">				for (int j = 0; j &lt; 2; j++) {</span>
<span class="nc" id="L168">					SubBlock uvsb = mb.getUSubBlock(j, i);</span>
<span class="nc" id="L169">					uvsb.dequantSubBlock(frame, null);</span>
<span class="nc" id="L170">					uvsb = mb.getVSubBlock(i, j);</span>
<span class="nc" id="L171">					uvsb.dequantSubBlock(frame, null);</span>
				}
			}
<span class="nc" id="L174">			mb.recon_mb();</span>

<span class="nc" id="L176">		} else {</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">			for (int j = 0; j &lt; 4; j++) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">				for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L179">					SubBlock sb = mb.getYSubBlock(i, j);</span>
<span class="nc" id="L180">					sb.dequantSubBlock(frame, null);</span>
<span class="nc" id="L181">					sb.predict(frame);</span>
<span class="nc" id="L182">					sb.reconstruct();</span>
				}
			}
<span class="nc" id="L185">			mb.predictUV(frame);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">			for (int i = 0; i &lt; 2; i++) {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">				for (int j = 0; j &lt; 2; j++) {</span>
<span class="nc" id="L188">					SubBlock sb = mb.getUSubBlock(j, i);</span>
<span class="nc" id="L189">					sb.dequantSubBlock(frame, null);</span>
<span class="nc" id="L190">					sb.reconstruct();</span>
				}
			}
<span class="nc bnc" id="L193" title="All 2 branches missed.">			for (int i = 0; i &lt; 2; i++) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">				for (int j = 0; j &lt; 2; j++) {</span>
<span class="nc" id="L195">					SubBlock sb = mb.getVSubBlock(j, i);</span>
<span class="nc" id="L196">					sb.dequantSubBlock(frame, null);</span>
<span class="nc" id="L197">					sb.reconstruct();</span>
				}
			}
		}
<span class="nc" id="L201">	}</span>

	public void drawDebug() {
<span class="nc bnc" id="L204" title="All 2 branches missed.">		for (int j = 0; j &lt; 4; j++)</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">			for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L206">				SubBlock sb = ySubBlocks[i][0];</span>
<span class="nc" id="L207">				sb.drawDebugH();</span>
<span class="nc" id="L208">				sb = ySubBlocks[0][j];</span>
<span class="nc" id="L209">				sb.drawDebugV();</span>
			}
<span class="nc" id="L211">	}</span>

	public SubBlock getBottomSubBlock(int x, SubBlock.PLANE plane) {
<span class="nc bnc" id="L214" title="All 2 branches missed.">		if (plane == SubBlock.PLANE.Y1) {</span>
<span class="nc" id="L215">			return ySubBlocks[x][3];</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">		} else if (plane == SubBlock.PLANE.U) {</span>
<span class="nc" id="L217">			return uSubBlocks[x][1];</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">		} else if (plane == SubBlock.PLANE.V) {</span>
<span class="nc" id="L219">			return vSubBlocks[x][1];</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">		} else if (plane == SubBlock.PLANE.Y2) {</span>
<span class="nc" id="L221">			return y2SubBlock;</span>
		}
<span class="nc" id="L223">		return null;</span>
	}

	public String getDebugString() {
<span class="nc" id="L227">		String r = new String();</span>
<span class="nc" id="L228">		r = r + &quot; YMode: &quot; + Globals.getModeAsString(yMode);</span>
<span class="nc" id="L229">		r = r + &quot;\n UVMode: &quot; + Globals.getModeAsString(uvMode);</span>
<span class="nc" id="L230">		r = r + &quot;\n SegmentID: &quot; + segmentId;</span>
<span class="nc" id="L231">		r = r + &quot;\n Filter Level: &quot; + filterLevel;</span>
<span class="nc" id="L232">		r = r + &quot;\n UV Filter Level: &quot; + uVFilterLevel;</span>
<span class="nc" id="L233">		r = r + &quot;\n Skip Coeff: &quot; + skipCoeff;</span>

<span class="nc" id="L235">		return r;</span>
	}

	public int getFilterLevel() {
<span class="nc" id="L239">		return this.filterLevel;</span>
	}

	public SubBlock getLeftSubBlock(int y, SubBlock.PLANE plane) {
<span class="nc bnc" id="L243" title="All 2 branches missed.">		if (plane == SubBlock.PLANE.Y1) {</span>
<span class="nc" id="L244">			return ySubBlocks[0][y];</span>
		}

<span class="nc bnc" id="L247" title="All 2 branches missed.">		else if (plane == SubBlock.PLANE.V) {</span>
<span class="nc" id="L248">			return vSubBlocks[0][y];</span>
		}
<span class="nc bnc" id="L250" title="All 2 branches missed.">		if (plane == SubBlock.PLANE.Y2) {</span>
<span class="nc" id="L251">			return y2SubBlock;</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">		} else if (plane == SubBlock.PLANE.U) {</span>
<span class="nc" id="L253">			return uSubBlocks[0][y];</span>
		}
<span class="nc" id="L255">		return null;</span>
	}

	public SubBlock getRightSubBlock(int y, SubBlock.PLANE plane) {
<span class="nc bnc" id="L259" title="All 2 branches missed.">		if (plane == SubBlock.PLANE.Y1) {</span>
<span class="nc" id="L260">			return ySubBlocks[3][y];</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">		} else if (plane == SubBlock.PLANE.U) {</span>
<span class="nc" id="L262">			return uSubBlocks[1][y];</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">		} else if (plane == SubBlock.PLANE.V) {</span>
<span class="nc" id="L264">			return vSubBlocks[1][y];</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">		} else if (plane == SubBlock.PLANE.Y2) {</span>
<span class="nc" id="L266">			return y2SubBlock;</span>
		}
<span class="nc" id="L268">		return null;</span>
	}

	public int getSkipCoeff() {
<span class="nc" id="L272">		return skipCoeff;</span>
	}

	public SubBlock getSubBlock(SubBlock.PLANE plane, int i, int j) {
<span class="nc bnc" id="L276" title="All 5 branches missed.">		switch (plane) {</span>
		case Y1:
<span class="nc" id="L278">			return getYSubBlock(i, j);</span>
		case U:
<span class="nc" id="L280">			return getUSubBlock(i, j);</span>

		case V:
<span class="nc" id="L283">			return getVSubBlock(i, j);</span>
		case Y2:
<span class="nc" id="L285">			return getY2SubBlock();</span>
		}
<span class="nc" id="L287">		return null;</span>
	}

	public int getSubblockX(SubBlock sb) {
<span class="nc bnc" id="L291" title="All 2 branches missed.">		if (sb.getPlane() == SubBlock.PLANE.Y1) {</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">			for (int y = 0; y &lt; 4; y++)</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">				for (int x = 0; x &lt; 4; x++)</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">					if (ySubBlocks[x][y] == sb)</span>
<span class="nc" id="L295">						return x;</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">		} else if (sb.getPlane() == SubBlock.PLANE.U) {</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">			for (int y = 0; y &lt; 2; y++)</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">				for (int x = 0; x &lt; 2; x++)</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">					if (uSubBlocks[x][y] == sb)</span>
<span class="nc" id="L300">						return x;</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">		} else if (sb.getPlane() == SubBlock.PLANE.V) {</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">			for (int y = 0; y &lt; 2; y++)</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">				for (int x = 0; x &lt; 2; x++)</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">					if (vSubBlocks[x][y] == sb)</span>
<span class="nc" id="L305">						return x;</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">		} else if (sb.getPlane() == SubBlock.PLANE.Y2) {</span>
<span class="nc" id="L307">			return 0;</span>
		}

<span class="nc" id="L310">		return -100;</span>

	}

	public int getSubblockY(SubBlock sb) {
<span class="nc bnc" id="L315" title="All 2 branches missed.">		if (sb.getPlane() == SubBlock.PLANE.Y1) {</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">			for (int y = 0; y &lt; 4; y++)</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">				for (int x = 0; x &lt; 4; x++)</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">					if (ySubBlocks[x][y] == sb)</span>
<span class="nc" id="L319">						return y;</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">		} else if (sb.getPlane() == SubBlock.PLANE.U) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">			for (int y = 0; y &lt; 2; y++)</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">				for (int x = 0; x &lt; 2; x++)</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">					if (uSubBlocks[x][y] == sb)</span>
<span class="nc" id="L324">						return y;</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">		} else if (sb.getPlane() == SubBlock.PLANE.V) {</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">			for (int y = 0; y &lt; 2; y++)</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">				for (int x = 0; x &lt; 2; x++)</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">					if (vSubBlocks[x][y] == sb)</span>
<span class="nc" id="L329">						return y;</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">		} else if (sb.getPlane() == SubBlock.PLANE.Y2) {</span>
<span class="nc" id="L331">			return 0;</span>
		}

<span class="nc" id="L334">		return -100;</span>
	}

	public SubBlock getUSubBlock(int i, int j) {
<span class="nc" id="L338">		return uSubBlocks[i][j];</span>
	}

	public int getUVFilterLevel() {
<span class="nc" id="L342">		return this.uVFilterLevel;</span>
	}

	public int getUvMode() {
<span class="nc" id="L346">		return uvMode;</span>
	}

	public SubBlock getVSubBlock(int i, int j) {
<span class="nc" id="L350">		return vSubBlocks[i][j];</span>
	}

	public int getX() {
<span class="nc" id="L354">		return x;</span>
	}

	public int getY() {
<span class="nc" id="L358">		return y;</span>
	}

	public SubBlock getY2SubBlock() {
<span class="nc" id="L362">		return y2SubBlock;</span>
	}

	public int getYMode() {
<span class="nc" id="L366">		return yMode;</span>
	}

	public SubBlock getYSubBlock(int i, int j) {
<span class="nc" id="L370">		return ySubBlocks[i][j];</span>
	}

	public boolean isKeepDebugInfo() {
<span class="nc" id="L374">		return keepDebugInfo;</span>
	}

	public boolean isSkip_inner_lf() {
<span class="nc" id="L378">		return skipInnerLoopFilter;</span>
	}

	public void predictUV(VP8Frame frame) {
<span class="nc" id="L382">		MacroBlock aboveMb = frame.getMacroBlock(x, y - 1);</span>
<span class="nc" id="L383">		MacroBlock leftMb = frame.getMacroBlock(x - 1, y);</span>

<span class="nc bnc" id="L385" title="All 5 branches missed.">		switch (this.uvMode) {</span>
		case Globals.DC_PRED:
			// System.out.println(&quot;UV DC_PRED&quot;);

<span class="nc" id="L389">			boolean up_available = false;</span>
<span class="nc" id="L390">			boolean left_available = false;</span>
<span class="nc" id="L391">			int Uaverage = 0;</span>
<span class="nc" id="L392">			int Vaverage = 0;</span>
<span class="nc" id="L393">			int expected_udc = 0;</span>
<span class="nc" id="L394">			int expected_vdc = 0;</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">			if (x &gt; 0)</span>
<span class="nc" id="L396">				left_available = true;</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">			if (y &gt; 0)</span>
<span class="nc" id="L398">				up_available = true;</span>
<span class="nc bnc" id="L399" title="All 4 branches missed.">			if (up_available || left_available) {</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">				if (up_available) {</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">					for (int j = 0; j &lt; 2; j++) {</span>
<span class="nc" id="L402">						SubBlock usb = aboveMb.getUSubBlock(j, 1);</span>
<span class="nc" id="L403">						SubBlock vsb = aboveMb.getVSubBlock(j, 1);</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">						for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L405">							Uaverage += usb.getDest()[i][3];</span>
<span class="nc" id="L406">							Vaverage += vsb.getDest()[i][3];</span>
						}
					}
				}

<span class="nc bnc" id="L411" title="All 2 branches missed.">				if (left_available) {</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">					for (int j = 0; j &lt; 2; j++) {</span>
<span class="nc" id="L413">						SubBlock usb = leftMb.getUSubBlock(1, j);</span>
<span class="nc" id="L414">						SubBlock vsb = leftMb.getVSubBlock(1, j);</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">						for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L416">							Uaverage += usb.getDest()[3][i];</span>
<span class="nc" id="L417">							Vaverage += vsb.getDest()[3][i];</span>
						}
					}
				}

<span class="nc" id="L422">				int shift = 2;</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">				if (up_available)</span>
<span class="nc" id="L424">					shift++;</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">				if (left_available)</span>
<span class="nc" id="L426">					shift++;</span>

<span class="nc" id="L428">				expected_udc = (Uaverage + (1 &lt;&lt; (shift - 1))) &gt;&gt; shift;</span>
<span class="nc" id="L429">				expected_vdc = (Vaverage + (1 &lt;&lt; (shift - 1))) &gt;&gt; shift;</span>
<span class="nc" id="L430">			} else {</span>
<span class="nc" id="L431">				expected_udc = 128;</span>
<span class="nc" id="L432">				expected_vdc = 128;</span>
			}

<span class="nc" id="L435">			int ufill[][] = new int[4][4];</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">			for (int y = 0; y &lt; 4; y++)</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">				for (int x = 0; x &lt; 4; x++)</span>
<span class="nc" id="L438">					ufill[x][y] = expected_udc;</span>

<span class="nc" id="L440">			int vfill[][] = new int[4][4];</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">			for (int y = 0; y &lt; 4; y++)</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">				for (int x = 0; x &lt; 4; x++)</span>
<span class="nc" id="L443">					vfill[x][y] = expected_vdc;</span>

<span class="nc bnc" id="L445" title="All 2 branches missed.">			for (int y = 0; y &lt; 2; y++)</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">				for (int x = 0; x &lt; 2; x++) {</span>
<span class="nc" id="L447">					SubBlock usb = uSubBlocks[x][y];</span>
<span class="nc" id="L448">					SubBlock vsb = vSubBlocks[x][y];</span>
<span class="nc" id="L449">					usb.setPredict(ufill);</span>
<span class="nc" id="L450">					vsb.setPredict(vfill);</span>
				}

<span class="nc" id="L453">			break;</span>
		case Globals.V_PRED:
			// System.out.println(&quot;UV V_PRED&quot;);

<span class="nc" id="L457">			SubBlock[] aboveUSb = new SubBlock[2];</span>
<span class="nc" id="L458">			SubBlock[] aboveVSb = new SubBlock[2];</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">			for (int x = 0; x &lt; 2; x++) {</span>
<span class="nc" id="L460">				aboveUSb[x] = aboveMb.getUSubBlock(x, 1);</span>
<span class="nc" id="L461">				aboveVSb[x] = aboveMb.getVSubBlock(x, 1);</span>
			}

<span class="nc bnc" id="L464" title="All 2 branches missed.">			for (int y = 0; y &lt; 2; y++)</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">				for (int x = 0; x &lt; 2; x++) {</span>
<span class="nc" id="L466">					SubBlock usb = uSubBlocks[y][x];</span>
<span class="nc" id="L467">					SubBlock vsb = vSubBlocks[y][x];</span>
<span class="nc" id="L468">					int ublock[][] = new int[4][4];</span>
<span class="nc" id="L469">					int vblock[][] = new int[4][4];</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">					for (int j = 0; j &lt; 4; j++)</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">						for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L472">							ublock[j][i] = aboveUSb[y].getMacroBlockPredict(Globals.V_PRED)[j][3];</span>
<span class="nc" id="L473">							vblock[j][i] = aboveVSb[y].getMacroBlockPredict(Globals.V_PRED)[j][3];</span>
						}
<span class="nc" id="L475">					usb.setPredict(ublock);</span>
<span class="nc" id="L476">					vsb.setPredict(vblock);</span>
				}

<span class="nc" id="L479">			break;</span>

		case Globals.H_PRED:
			// System.out.println(&quot;UV H_PRED&quot;);

<span class="nc" id="L484">			SubBlock[] leftUSb = new SubBlock[2];</span>
<span class="nc" id="L485">			SubBlock[] leftVSb = new SubBlock[2];</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">			for (int x = 0; x &lt; 2; x++) {</span>
<span class="nc" id="L487">				leftUSb[x] = leftMb.getUSubBlock(1, x);</span>
<span class="nc" id="L488">				leftVSb[x] = leftMb.getVSubBlock(1, x);</span>
			}

<span class="nc bnc" id="L491" title="All 2 branches missed.">			for (int y = 0; y &lt; 2; y++)</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">				for (int x = 0; x &lt; 2; x++) {</span>
<span class="nc" id="L493">					SubBlock usb = uSubBlocks[x][y];</span>
<span class="nc" id="L494">					SubBlock vsb = vSubBlocks[x][y];</span>
<span class="nc" id="L495">					int ublock[][] = new int[4][4];</span>
<span class="nc" id="L496">					int vblock[][] = new int[4][4];</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">					for (int j = 0; j &lt; 4; j++)</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">						for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L499">							ublock[i][j] = leftUSb[y].getMacroBlockPredict(Globals.H_PRED)[3][j];</span>
<span class="nc" id="L500">							vblock[i][j] = leftVSb[y].getMacroBlockPredict(Globals.H_PRED)[3][j];</span>
						}
<span class="nc" id="L502">					usb.setPredict(ublock);</span>
<span class="nc" id="L503">					vsb.setPredict(vblock);</span>
				}

<span class="nc" id="L506">			break;</span>
		case Globals.TM_PRED:
			// TODO:
			// System.out.println(&quot;UV TM_PRED MB&quot;);
<span class="nc" id="L510">			MacroBlock ALMb = frame.getMacroBlock(x - 1, y - 1);</span>
<span class="nc" id="L511">			SubBlock ALUSb = ALMb.getUSubBlock(1, 1);</span>
<span class="nc" id="L512">			int alu = ALUSb.getDest()[3][3];</span>
<span class="nc" id="L513">			SubBlock ALVSb = ALMb.getVSubBlock(1, 1);</span>
<span class="nc" id="L514">			int alv = ALVSb.getDest()[3][3];</span>

<span class="nc" id="L516">			aboveUSb = new SubBlock[2];</span>
<span class="nc" id="L517">			leftUSb = new SubBlock[2];</span>
<span class="nc" id="L518">			aboveVSb = new SubBlock[2];</span>
<span class="nc" id="L519">			leftVSb = new SubBlock[2];</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">			for (int x = 0; x &lt; 2; x++) {</span>
<span class="nc" id="L521">				aboveUSb[x] = aboveMb.getUSubBlock(x, 1);</span>
<span class="nc" id="L522">				leftUSb[x] = leftMb.getUSubBlock(1, x);</span>
<span class="nc" id="L523">				aboveVSb[x] = aboveMb.getVSubBlock(x, 1);</span>
<span class="nc" id="L524">				leftVSb[x] = leftMb.getVSubBlock(1, x);</span>
			}

<span class="nc bnc" id="L527" title="All 2 branches missed.">			for (int b = 0; b &lt; 2; b++) {</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">				for (int a = 0; a &lt; 4; a++) {</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">					for (int d = 0; d &lt; 2; d++) {</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">						for (int c = 0; c &lt; 4; c++) {</span>

<span class="nc" id="L532">							int upred = leftUSb[b].getDest()[3][a] + aboveUSb[d].getDest()[c][3] - alu;</span>
<span class="nc" id="L533">							upred = Globals.clamp(upred, 255);</span>
<span class="nc" id="L534">							uSubBlocks[d][b].setPixel(c, a, upred);</span>

<span class="nc" id="L536">							int vpred = leftVSb[b].getDest()[3][a] + aboveVSb[d].getDest()[c][3] - alv;</span>
<span class="nc" id="L537">							vpred = Globals.clamp(vpred, 255);</span>
<span class="nc" id="L538">							vSubBlocks[d][b].setPixel(c, a, vpred);</span>

						}
					}

				}
			}

<span class="nc" id="L546">			break;</span>
		default:
<span class="nc" id="L548">			System.out.println(&quot;TODO predict_mb_uv: &quot; + this.yMode);</span>
<span class="nc" id="L549">			System.exit(0);</span>
		}
<span class="nc" id="L551">	}</span>

	public void predictY(VP8Frame frame) {
<span class="nc" id="L554">		MacroBlock aboveMb = frame.getMacroBlock(x, y - 1);</span>
<span class="nc" id="L555">		MacroBlock leftMb = frame.getMacroBlock(x - 1, y);</span>

<span class="nc bnc" id="L557" title="All 5 branches missed.">		switch (this.yMode) {</span>
		case Globals.DC_PRED:
			// System.out.println(&quot;DC_PRED&quot;);
<span class="nc" id="L560">			boolean up_available = false;</span>
<span class="nc" id="L561">			boolean left_available = false;</span>

<span class="nc" id="L563">			int average = 0;</span>
<span class="nc" id="L564">			int expected_dc = 0;</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">			if (x &gt; 0)</span>
<span class="nc" id="L566">				left_available = true;</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">			if (y &gt; 0)</span>
<span class="nc" id="L568">				up_available = true;</span>

<span class="nc bnc" id="L570" title="All 4 branches missed.">			if (up_available || left_available) {</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">				if (up_available) {</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">					for (int j = 0; j &lt; 4; j++) {</span>
<span class="nc" id="L573">						SubBlock sb = aboveMb.getYSubBlock(j, 3);</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">						for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L575">							average += sb.getDest()[i][3];</span>
						}
					}
				}

<span class="nc bnc" id="L580" title="All 2 branches missed.">				if (left_available) {</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">					for (int j = 0; j &lt; 4; j++) {</span>
<span class="nc" id="L582">						SubBlock sb = leftMb.getYSubBlock(3, j);</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">						for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L584">							average += sb.getDest()[3][i];</span>
						}
					}
				}

<span class="nc" id="L589">				int shift = 3;</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">				if (up_available)</span>
<span class="nc" id="L591">					shift++;</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">				if (left_available)</span>
<span class="nc" id="L593">					shift++;</span>

<span class="nc" id="L595">				expected_dc = (average + (1 &lt;&lt; (shift - 1))) &gt;&gt; shift;</span>
<span class="nc" id="L596">			} else {</span>
<span class="nc" id="L597">				expected_dc = 128;</span>
			}

<span class="nc" id="L600">			int fill[][] = new int[4][4];</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">			for (int y = 0; y &lt; 4; y++)</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">				for (int x = 0; x &lt; 4; x++)</span>
<span class="nc" id="L603">					fill[x][y] = expected_dc;</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">			for (int y = 0; y &lt; 4; y++)</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">				for (int x = 0; x &lt; 4; x++) {</span>
<span class="nc" id="L606">					SubBlock sb = ySubBlocks[x][y];</span>
<span class="nc" id="L607">					sb.setPredict(fill);</span>
				}

<span class="nc" id="L610">			break;</span>
		case Globals.V_PRED:
			// System.out.println(&quot;V_PRED&quot;);

<span class="nc" id="L614">			SubBlock[] aboveYSb = new SubBlock[4];</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">			for (int x = 0; x &lt; 4; x++)</span>
<span class="nc" id="L616">				aboveYSb[x] = aboveMb.getYSubBlock(x, 3);</span>

<span class="nc bnc" id="L618" title="All 2 branches missed.">			for (int y = 0; y &lt; 4; y++) {</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">				for (int x = 0; x &lt; 4; x++) {</span>
<span class="nc" id="L620">					SubBlock sb = ySubBlocks[x][y];</span>
<span class="nc" id="L621">					int block[][] = new int[4][4];</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">					for (int j = 0; j &lt; 4; j++)</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">						for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L624">							block[i][j] = aboveYSb[x].getPredict(Globals.B_VE_PRED, false)[i][3];</span>
						}
<span class="nc" id="L626">					sb.setPredict(block);</span>

				}
			}

<span class="nc" id="L631">			break;</span>

		case Globals.H_PRED:
			// System.out.println(&quot;H_PRED&quot;);

<span class="nc" id="L636">			SubBlock[] leftYSb = new SubBlock[4];</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">			for (int x = 0; x &lt; 4; x++)</span>
<span class="nc" id="L638">				leftYSb[x] = leftMb.getYSubBlock(3, x);</span>

<span class="nc bnc" id="L640" title="All 2 branches missed.">			for (int y = 0; y &lt; 4; y++)</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">				for (int x = 0; x &lt; 4; x++) {</span>
<span class="nc" id="L642">					SubBlock sb = ySubBlocks[x][y];</span>
<span class="nc" id="L643">					int block[][] = new int[4][4];</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">					for (int j = 0; j &lt; 4; j++)</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">						for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L646">							block[i][j] = leftYSb[y].getPredict(Globals.B_DC_PRED, true)[3][j];</span>
						}
<span class="nc" id="L648">					sb.setPredict(block);</span>
				}

<span class="nc" id="L651">			SubBlock[] leftUSb = new SubBlock[2];</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">			for (int x = 0; x &lt; 2; x++)</span>
<span class="nc" id="L653">				leftUSb[x] = leftMb.getYSubBlock(1, x);</span>

<span class="nc" id="L655">			break;</span>
		case Globals.TM_PRED:
			// System.out.println(&quot;TM_PRED MB&quot;);
<span class="nc" id="L658">			MacroBlock ALMb = frame.getMacroBlock(x - 1, y - 1);</span>
<span class="nc" id="L659">			SubBlock ALSb = ALMb.getYSubBlock(3, 3);</span>
<span class="nc" id="L660">			int al = ALSb.getDest()[3][3];</span>

<span class="nc" id="L662">			aboveYSb = new SubBlock[4];</span>
<span class="nc" id="L663">			leftYSb = new SubBlock[4];</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">			for (int x = 0; x &lt; 4; x++)</span>
<span class="nc" id="L665">				aboveYSb[x] = aboveMb.getYSubBlock(x, 3);</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">			for (int x = 0; x &lt; 4; x++)</span>
<span class="nc" id="L667">				leftYSb[x] = leftMb.getYSubBlock(3, x);</span>
<span class="nc" id="L668">			fill = new int[4][4];</span>

<span class="nc bnc" id="L670" title="All 2 branches missed.">			for (int b = 0; b &lt; 4; b++) {</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">				for (int a = 0; a &lt; 4; a++) {</span>

<span class="nc bnc" id="L673" title="All 2 branches missed.">					for (int d = 0; d &lt; 4; d++) {</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">						for (int c = 0; c &lt; 4; c++) {</span>

<span class="nc" id="L676">							int pred = leftYSb[b].getDest()[3][a] + aboveYSb[d].getDest()[c][3] - al;</span>

<span class="nc" id="L678">							ySubBlocks[d][b].setPixel(c, a, Globals.clamp(pred, 255));</span>

						}
					}

				}
			}

<span class="nc" id="L686">			break;</span>
		default:
<span class="nc" id="L688">			System.out.println(&quot;TODO predict_mb_y: &quot; + this.yMode);</span>
<span class="nc" id="L689">			System.exit(0);</span>
		}
<span class="nc" id="L691">	}</span>

	public void recon_mb() {
<span class="nc bnc" id="L694" title="All 2 branches missed.">		for (int j = 0; j &lt; 4; j++)</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">			for (int i = 0; i &lt; 4; i++) {</span>
<span class="nc" id="L696">				SubBlock sb = ySubBlocks[i][j];</span>
<span class="nc" id="L697">				sb.reconstruct();</span>
			}

<span class="nc bnc" id="L700" title="All 2 branches missed.">		for (int j = 0; j &lt; 2; j++)</span>
<span class="nc bnc" id="L701" title="All 2 branches missed.">			for (int i = 0; i &lt; 2; i++) {</span>
<span class="nc" id="L702">				SubBlock sb = uSubBlocks[i][j];</span>
<span class="nc" id="L703">				sb.reconstruct();</span>
			}
<span class="nc bnc" id="L705" title="All 2 branches missed.">		for (int j = 0; j &lt; 2; j++)</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">			for (int i = 0; i &lt; 2; i++) {</span>
<span class="nc" id="L707">				SubBlock sb = vSubBlocks[i][j];</span>
<span class="nc" id="L708">				sb.reconstruct();</span>
			}

<span class="nc" id="L711">	}</span>

	public void setFilterLevel(int value) {
<span class="nc" id="L714">		this.filterLevel = value;</span>
<span class="nc" id="L715">	}</span>

	public void setSegmentId(int value) {
<span class="nc" id="L718">		this.segmentId = value;</span>
<span class="nc" id="L719">	}</span>

	public void setSkipCoeff(int mbSkipCoeff) {
<span class="nc" id="L722">		skipCoeff = mbSkipCoeff;</span>
<span class="nc" id="L723">	}</span>

	public void setUVFilterLevel(int value) {
<span class="nc" id="L726">		this.uVFilterLevel = value;</span>
<span class="nc" id="L727">	}</span>

	public void setUvMode(int mode) {
<span class="nc" id="L730">		this.uvMode = mode;</span>
<span class="nc" id="L731">	}</span>

	public void setYMode(int yMode) {
<span class="nc" id="L734">		this.yMode = yMode;</span>
<span class="nc" id="L735">	}</span>

	public String toString() {
<span class="nc" id="L738">		return &quot;x: &quot; + x + &quot;y: &quot; + y;</span>
	}

	public int getSegmentId() {
<span class="nc" id="L742">		return segmentId;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>