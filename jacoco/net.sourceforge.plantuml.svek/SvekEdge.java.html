<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SvekEdge.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">plantuml</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.plantuml.svek</a> &gt; <span class="el_source">SvekEdge.java</span></div><h1>SvekEdge.java</h1><pre class="source lang-java linenums">/* ========================================================================
 * PlantUML : a free UML diagram generator
 * ========================================================================
 *
 * (C) Copyright 2009-2025, Arnaud Roques
 *
 * Project Info:  https://plantuml.com
 *
 * If you like this project or if you find it useful, you can support us at:
 *
 * https://plantuml.com/patreon (only 1$ per month!)
 * https://plantuml.com/paypal
 *
 * This file is part of PlantUML.
 *
 * PlantUML is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * PlantUML distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
 * License for more details.
 *
 * You should have received a copy of the GNU General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301,
 * USA.
 *
 *
 * Original Author:  Arnaud Roques
 *
 *
 */
package net.sourceforge.plantuml.svek;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Set;

import net.sourceforge.plantuml.StringUtils;
import net.sourceforge.plantuml.abel.CucaNote;
import net.sourceforge.plantuml.abel.Entity;
import net.sourceforge.plantuml.abel.LeafType;
import net.sourceforge.plantuml.abel.Link;
import net.sourceforge.plantuml.abel.LinkArrow;
import net.sourceforge.plantuml.abel.LinkStrategy;
import net.sourceforge.plantuml.abel.NoteLinkStrategy;
import net.sourceforge.plantuml.annotation.DuplicateCode;
import net.sourceforge.plantuml.cruise.XAbstractEdge;
import net.sourceforge.plantuml.cruise.XEdge;
import net.sourceforge.plantuml.cucadiagram.EntityPort;
import net.sourceforge.plantuml.decoration.LinkDecor;
import net.sourceforge.plantuml.decoration.LinkMiddleDecor;
import net.sourceforge.plantuml.decoration.LinkType;
import net.sourceforge.plantuml.decoration.Rainbow;
import net.sourceforge.plantuml.descdiagram.command.StringWithArrow;
import net.sourceforge.plantuml.dot.DotSplines;
import net.sourceforge.plantuml.dot.GraphvizVersion;
import net.sourceforge.plantuml.klimt.UGroup;
import net.sourceforge.plantuml.klimt.UGroupType;
import net.sourceforge.plantuml.klimt.UStroke;
import net.sourceforge.plantuml.klimt.UTranslate;
import net.sourceforge.plantuml.klimt.color.ColorType;
import net.sourceforge.plantuml.klimt.color.Colors;
import net.sourceforge.plantuml.klimt.color.HColor;
import net.sourceforge.plantuml.klimt.color.HColors;
import net.sourceforge.plantuml.klimt.creole.CreoleMode;
import net.sourceforge.plantuml.klimt.creole.Display;
import net.sourceforge.plantuml.klimt.drawing.UGraphic;
import net.sourceforge.plantuml.klimt.font.FontConfiguration;
import net.sourceforge.plantuml.klimt.font.StringBounder;
import net.sourceforge.plantuml.klimt.geom.BezierUtils;
import net.sourceforge.plantuml.klimt.geom.HorizontalAlignment;
import net.sourceforge.plantuml.klimt.geom.MagneticBorder;
import net.sourceforge.plantuml.klimt.geom.PointAndAngle;
import net.sourceforge.plantuml.klimt.geom.Positionable;
import net.sourceforge.plantuml.klimt.geom.PositionableUtils;
import net.sourceforge.plantuml.klimt.geom.Side;
import net.sourceforge.plantuml.klimt.geom.VerticalAlignment;
import net.sourceforge.plantuml.klimt.geom.XDimension2D;
import net.sourceforge.plantuml.klimt.geom.XPoint2D;
import net.sourceforge.plantuml.klimt.shape.DotPath;
import net.sourceforge.plantuml.klimt.shape.TextBlock;
import net.sourceforge.plantuml.klimt.shape.TextBlockUtils;
import net.sourceforge.plantuml.klimt.shape.UDrawable;
import net.sourceforge.plantuml.klimt.shape.ULine;
import net.sourceforge.plantuml.klimt.shape.UPolygon;
import net.sourceforge.plantuml.skin.AlignmentParam;
import net.sourceforge.plantuml.skin.ColorParam;
import net.sourceforge.plantuml.skin.LineParam;
import net.sourceforge.plantuml.skin.Pragma;
import net.sourceforge.plantuml.skin.PragmaKey;
import net.sourceforge.plantuml.skin.UmlDiagramType;
import net.sourceforge.plantuml.skin.VisibilityModifier;
import net.sourceforge.plantuml.skin.rose.Rose;
import net.sourceforge.plantuml.stereo.Stereotype;
import net.sourceforge.plantuml.style.ISkinParam;
import net.sourceforge.plantuml.style.SName;
import net.sourceforge.plantuml.style.Style;
import net.sourceforge.plantuml.style.StyleBuilder;
import net.sourceforge.plantuml.style.StyleSignature;
import net.sourceforge.plantuml.style.StyleSignatureBasic;
import net.sourceforge.plantuml.svek.extremity.Extremity;
import net.sourceforge.plantuml.svek.extremity.ExtremityArrow;
import net.sourceforge.plantuml.svek.extremity.ExtremityFactory;
import net.sourceforge.plantuml.svek.extremity.ExtremityFactoryExtends;
import net.sourceforge.plantuml.svek.extremity.ExtremityOther;
import net.sourceforge.plantuml.svek.image.EntityImageNoteLink;
import net.sourceforge.plantuml.url.Url;
import net.sourceforge.plantuml.utils.Direction;
import net.sourceforge.plantuml.utils.Log;
import net.sourceforge.plantuml.utils.Position;

@DuplicateCode(reference = &quot;SvekEdge, CucaDiagramFileMakerElk, CucaDiagramFileMakerSmetana&quot;)
public class SvekEdge extends XAbstractEdge implements XEdge, UDrawable {

<span class="nc" id="L120">	private static final XDimension2D CONSTRAINT_SPOT = new XDimension2D(10, 10);</span>

	private final Cluster ltail;
	private final Cluster lhead;

	private final EntityPort startUid;
	private final EntityPort endUid;

	private final TextBlock startTailText;
	private final TextBlock endHeadText;
	private final TextBlock labelText;
<span class="nc" id="L131">	private boolean divideLabelWidthByTwo = false;</span>

	private final int lineColor;
	private final int noteLabelColor;
	private final int startTailColor;
	private final int endHeadColor;

	private final StringBounder stringBounder;

	private DotPath dotPath;
	private DotPath dotPathInit;

	private Positionable startTailLabelXY;
	private Positionable endHeadLabelXY;
	private Positionable labelXY;

	private UDrawable extremity1;
	private UDrawable extremity2;

	private double dx;
	private double dy;

	private boolean opale;
	private Cluster projectionCluster;

	private final Pragma pragma;
	private final HColor backgroundColor;
	private final boolean useRankSame;
	private final UStroke defaultThickness;
	private HColor arrowLollipopColor;

	private final double labelShield;

	@Override
	public String toString() {
<span class="nc" id="L166">		return super.toString() + &quot; color=&quot; + lineColor;</span>
	}

	private LinkStrategy getLinkStrategy() {
<span class="nc" id="L170">		return link.getLinkStrategy();</span>
	}

	public Direction getArrowDirection() {
<span class="nc bnc" id="L174" title="All 2 branches missed.">		if (getLinkArrow() == LinkArrow.BACKWARD)</span>
<span class="nc" id="L175">			return getArrowDirectionInternal().getInv();</span>

<span class="nc" id="L177">		return getArrowDirectionInternal();</span>
	}

	private Direction getArrowDirectionInternal() {
<span class="nc bnc" id="L181" title="All 2 branches missed.">		if (isAutolink()) {</span>
<span class="nc" id="L182">			final double startAngle = dotPath.getStartAngle();</span>
<span class="nc" id="L183">			return Direction.LEFT;</span>
		}
<span class="nc" id="L185">		final XPoint2D start = dotPath.getStartPoint();</span>
<span class="nc" id="L186">		final XPoint2D end = dotPath.getEndPoint();</span>
<span class="nc" id="L187">		final double ang = Math.atan2(end.getX() - start.getX(), end.getY() - start.getY());</span>
<span class="nc bnc" id="L188" title="All 4 branches missed.">		if (ang &gt; -Math.PI / 4 &amp;&amp; ang &lt; Math.PI / 4)</span>
<span class="nc" id="L189">			return Direction.DOWN;</span>

<span class="nc bnc" id="L191" title="All 4 branches missed.">		if (ang &gt; Math.PI * 3 / 4 || ang &lt; -Math.PI * 3 / 4)</span>
<span class="nc" id="L192">			return Direction.UP;</span>

<span class="nc bnc" id="L194" title="All 2 branches missed.">		return end.getX() &gt; start.getX() ? Direction.RIGHT : Direction.LEFT;</span>
	}

	public double getArrowDirectionInRadian() {
<span class="nc bnc" id="L198" title="All 2 branches missed.">		if (getLinkArrow() == LinkArrow.BACKWARD)</span>
<span class="nc" id="L199">			return Math.PI + getArrowDirectionInRadianInternal();</span>

<span class="nc" id="L201">		return getArrowDirectionInRadianInternal();</span>
	}

	private double getArrowDirectionInRadianInternal() {
<span class="nc bnc" id="L205" title="All 2 branches missed.">		if (isAutolink()) {</span>
<span class="nc" id="L206">			final double startAngle = dotPath.getStartAngle();</span>
<span class="nc" id="L207">			return startAngle;</span>
		}
<span class="nc" id="L209">		final XPoint2D start = dotPath.getStartPoint();</span>
<span class="nc" id="L210">		final XPoint2D end = dotPath.getEndPoint();</span>
<span class="nc" id="L211">		final double ang = Math.atan2(end.getX() - start.getX(), end.getY() - start.getY());</span>
<span class="nc" id="L212">		return ang;</span>
	}

	private Cluster getCluster2(Bibliotekon bibliotekon, Entity entityMutable) {
<span class="nc bnc" id="L216" title="All 2 branches missed.">		for (Cluster cl : bibliotekon.allCluster())</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">			if (cl.getGroups().contains(entityMutable))</span>
<span class="nc" id="L218">				return cl;</span>

<span class="nc" id="L220">		throw new IllegalArgumentException();</span>
	}

	public SvekEdge(Link link, ISkinParam skinParam, StringBounder stringBounder, FontConfiguration font,
			FontConfiguration cardinalityFont, Bibliotekon bibliotekon, Pragma pragma,
			GraphvizVersion graphvizVersion) {
<span class="nc" id="L226">		super(link, skinParam, bibliotekon);</span>
		// ::comment when __CORE__
<span class="nc bnc" id="L228" title="All 4 branches missed.">		if (graphvizVersion.useShieldForQuantifier() &amp;&amp; link.getLinkArg().getQuantifier1() != null)</span>
<span class="nc" id="L229">			link.getEntity1().ensureMargins(Margins.uniform(16));</span>

<span class="nc bnc" id="L231" title="All 4 branches missed.">		if (graphvizVersion.useShieldForQuantifier() &amp;&amp; link.getLinkArg().getQuantifier2() != null)</span>
<span class="nc" id="L232">			link.getEntity2().ensureMargins(Margins.uniform(16));</span>
		// ::done

<span class="nc bnc" id="L235" title="All 2 branches missed.">		if (link.getLinkArg().getKal1() != null)</span>
<span class="nc" id="L236">			this.kal1 = new Kal(this, link.getLinkArg().getKal1(), skinParam, link.getEntity1(), link, stringBounder);</span>

<span class="nc bnc" id="L238" title="All 2 branches missed.">		if (link.getLinkArg().getKal2() != null)</span>
<span class="nc" id="L239">			this.kal2 = new Kal(this, link.getLinkArg().getKal2(), skinParam, link.getEntity2(), link, stringBounder);</span>

<span class="nc" id="L241">		this.useRankSame = skinParam.useRankSame();</span>
<span class="nc" id="L242">		this.startUid = link.getEntityPort1(bibliotekon);</span>
<span class="nc" id="L243">		this.endUid = link.getEntityPort2(bibliotekon);</span>

<span class="nc" id="L245">		Cluster ltail = null;</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">		if (startUid.startsWith(Cluster.CENTER_ID))</span>
<span class="nc" id="L247">			ltail = getCluster2(bibliotekon, link.getEntity1());</span>

<span class="nc" id="L249">		Cluster lhead = null;</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">		if (endUid.startsWith(Cluster.CENTER_ID))</span>
<span class="nc" id="L251">			lhead = getCluster2(bibliotekon, link.getEntity2());</span>

<span class="nc bnc" id="L253" title="All 2 branches missed.">		if (link.getColors() != null) {</span>
<span class="nc" id="L254">			skinParam = link.getColors().mute(skinParam);</span>
<span class="nc" id="L255">			font = font.mute(link.getColors());</span>
		}
<span class="nc" id="L257">		this.backgroundColor = skinParam.getBackgroundColor();</span>
<span class="nc" id="L258">		this.defaultThickness = skinParam.getThickness(LineParam.arrow, null);</span>
<span class="nc" id="L259">		this.arrowLollipopColor = skinParam.getHtmlColor(ColorParam.arrowLollipop, null, false);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">		if (arrowLollipopColor == null)</span>
<span class="nc" id="L261">			this.arrowLollipopColor = backgroundColor;</span>

<span class="nc" id="L263">		this.pragma = pragma;</span>
<span class="nc" id="L264">		this.stringBounder = stringBounder;</span>
<span class="nc" id="L265">		this.ltail = ltail;</span>
<span class="nc" id="L266">		this.lhead = lhead;</span>

<span class="nc" id="L268">		this.lineColor = bibliotekon.getColorSequence().getValue();</span>
<span class="nc" id="L269">		this.noteLabelColor = bibliotekon.getColorSequence().getValue();</span>
<span class="nc" id="L270">		this.startTailColor = bibliotekon.getColorSequence().getValue();</span>
<span class="nc" id="L271">		this.endHeadColor = bibliotekon.getColorSequence().getValue();</span>

		TextBlock labelOnly;
<span class="nc bnc" id="L274" title="All 2 branches missed.">		if (Display.isNull(link.getLabel())) {</span>
<span class="nc" id="L275">			labelOnly = TextBlockUtils.EMPTY_TEXT_BLOCK;</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">			if (getLinkArrow() != LinkArrow.NONE_OR_SEVERAL)</span>
<span class="nc" id="L277">				labelOnly = StringWithArrow.addMagicArrow(labelOnly, this, font);</span>

		} else {
<span class="nc" id="L280">			final HorizontalAlignment alignment = getMessageTextAlignment(diagramType(), skinParam);</span>
<span class="nc" id="L281">			final boolean hasSeveralGuideLines = link.getLabel().hasSeveralGuideLines();</span>
			final TextBlock block;
<span class="nc bnc" id="L283" title="All 2 branches missed.">			if (hasSeveralGuideLines)</span>
<span class="nc" id="L284">				block = StringWithArrow.addSeveralMagicArrows(link.getLabel(), this, font, alignment, skinParam);</span>
			else
<span class="nc" id="L286">				block = link.getLabel().create0(font, alignment, skinParam, skinParam.maxMessageSize(),</span>
						CreoleMode.SIMPLE_LINE, null, null);

<span class="nc" id="L289">			labelOnly = addVisibilityModifier(block, link, skinParam);</span>
<span class="nc bnc" id="L290" title="All 4 branches missed.">			if (getLinkArrow() != LinkArrow.NONE_OR_SEVERAL &amp;&amp; hasSeveralGuideLines == false)</span>
<span class="nc" id="L291">				labelOnly = StringWithArrow.addMagicArrow(labelOnly, this, font);</span>

		}

<span class="nc" id="L295">		final CucaNote note = link.getNote();</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">		if (note == null) {</span>
<span class="nc" id="L297">			labelText = labelOnly;</span>
		} else {
<span class="nc" id="L299">			final TextBlock noteOnly = new EntityImageNoteLink(note.getDisplay(), note.getColors(), skinParam,</span>
<span class="nc" id="L300">					link.getStyleBuilder());</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">			if (note.getStrategy() == NoteLinkStrategy.HALF_NOT_PRINTED</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">					|| note.getStrategy() == NoteLinkStrategy.HALF_PRINTED_FULL)</span>
<span class="nc" id="L303">				divideLabelWidthByTwo = true;</span>

<span class="nc bnc" id="L305" title="All 2 branches missed.">			if (note.getPosition() == Position.LEFT)</span>
<span class="nc" id="L306">				labelText = TextBlockUtils.mergeLR(noteOnly, labelOnly, VerticalAlignment.CENTER);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">			else if (note.getPosition() == Position.RIGHT)</span>
<span class="nc" id="L308">				labelText = TextBlockUtils.mergeLR(labelOnly, noteOnly, VerticalAlignment.CENTER);</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">			else if (note.getPosition() == Position.TOP)</span>
<span class="nc" id="L310">				labelText = TextBlockUtils.mergeTB(noteOnly, labelOnly, HorizontalAlignment.CENTER);</span>
			else
<span class="nc" id="L312">				labelText = TextBlockUtils.mergeTB(labelOnly, noteOnly, HorizontalAlignment.CENTER);</span>

		}

<span class="nc bnc" id="L316" title="All 2 branches missed.">		if (link.getQuantifier1() == null)</span>
<span class="nc" id="L317">			startTailText = null;</span>
		else
<span class="nc" id="L319">			startTailText = Display.getWithNewlines(skinParam.getPragma(), link.getQuantifier1()).create(cardinalityFont,</span>
					HorizontalAlignment.CENTER, skinParam);

<span class="nc bnc" id="L322" title="All 2 branches missed.">		if (link.getQuantifier2() == null)</span>
<span class="nc" id="L323">			endHeadText = null;</span>
		else
<span class="nc" id="L325">			endHeadText = Display.getWithNewlines(skinParam.getPragma(), link.getQuantifier2()).create(cardinalityFont,</span>
					HorizontalAlignment.CENTER, skinParam);

<span class="nc bnc" id="L328" title="All 2 branches missed.">		if (link.getType().getMiddleDecor() == LinkMiddleDecor.NONE)</span>
<span class="nc" id="L329">			this.labelShield = 0;</span>
		else
<span class="nc" id="L331">			this.labelShield = 7;</span>

<span class="nc" id="L333">	}</span>

	private Kal kal1;
	private Kal kal2;

	private TextBlock addVisibilityModifier(TextBlock block, Link link, ISkinParam skinParam) {
<span class="nc" id="L339">		final VisibilityModifier visibilityModifier = link.getVisibilityModifier();</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">		if (visibilityModifier != null) {</span>
<span class="nc" id="L341">			final Rose rose = new Rose();</span>
<span class="nc" id="L342">			final HColor fore = rose.getHtmlColor(skinParam, visibilityModifier.getForeground());</span>
<span class="nc" id="L343">			TextBlock visibility = visibilityModifier.getUBlock(skinParam.classAttributeIconSize(), fore, null, false);</span>
<span class="nc" id="L344">			visibility = TextBlockUtils.withMargin(visibility, 0, 1, 2, 0);</span>
<span class="nc" id="L345">			block = TextBlockUtils.mergeLR(visibility, block, VerticalAlignment.CENTER);</span>
		}
<span class="nc bnc" id="L347" title="All 2 branches missed.">		final double marginLabel = startUid.equalsId(endUid) ? 6 : 1;</span>
<span class="nc" id="L348">		return TextBlockUtils.withMargin(block, marginLabel, marginLabel);</span>
	}

	private HorizontalAlignment getMessageTextAlignment(UmlDiagramType umlDiagramType, ISkinParam skinParam) {
<span class="nc bnc" id="L352" title="All 2 branches missed.">		if (umlDiagramType == UmlDiagramType.STATE)</span>
<span class="nc" id="L353">			return skinParam.getHorizontalAlignment(AlignmentParam.stateMessageAlignment, null, false, null);</span>

<span class="nc" id="L355">		return skinParam.getDefaultTextAlignment(HorizontalAlignment.CENTER);</span>
	}

	public boolean hasNoteLabelText() {
<span class="nc bnc" id="L359" title="All 4 branches missed.">		return labelText != null &amp;&amp; labelText != TextBlockUtils.EMPTY_TEXT_BLOCK;</span>
	}

	private LinkArrow getLinkArrow() {
<span class="nc" id="L363">		return link.getLinkArrow();</span>
	}

	// ::comment when __CORE__
	public void appendLine(GraphvizVersion graphvizVersion, StringBuilder sb, DotMode dotMode, DotSplines dotSplines) {
		// Log.println(&quot;inverted=&quot; + isInverted());
		// if (isInverted()) {
		// sb.append(endUid);
		// sb.append(&quot;-&gt;&quot;);
		// sb.append(startUid);
		// } else {
<span class="nc" id="L374">		sb.append(startUid.getFullString());</span>
<span class="nc" id="L375">		sb.append(&quot;-&gt;&quot;);</span>
<span class="nc" id="L376">		sb.append(endUid.getFullString());</span>
		// }
<span class="nc" id="L378">		sb.append(&quot;[&quot;);</span>
<span class="nc" id="L379">		final LinkType linkType = link.getTypePatchCluster();</span>
<span class="nc" id="L380">		String decoration = linkType.getSpecificDecorationSvek(getLinkStrategy());</span>
<span class="nc bnc" id="L381" title="All 4 branches missed.">		if (decoration.length() &gt; 0 &amp;&amp; decoration.endsWith(&quot;,&quot;) == false)</span>
<span class="nc" id="L382">			decoration += &quot;,&quot;;</span>

<span class="nc" id="L384">		sb.append(decoration);</span>

<span class="nc" id="L386">		int length = link.getLength();</span>
<span class="nc bnc" id="L387" title="All 4 branches missed.">		if (graphvizVersion.ignoreHorizontalLinks() &amp;&amp; length == 1)</span>
<span class="nc" id="L388">			length = 2;</span>

<span class="nc bnc" id="L390" title="All 2 branches missed.">		if (useRankSame) {</span>
<span class="nc bnc" id="L391" title="All 6 branches missed.">			if (pragma.isDefine(PragmaKey.HORIZONTAL_LINE_BETWEEN_DIFFERENT_PACKAGE_ALLOWED) || link.isInvis() || length != 1) {</span>
				// if (graphvizVersion.isJs() == false) {
<span class="nc" id="L393">				sb.append(&quot;minlen=&quot; + (length - 1));</span>
<span class="nc" id="L394">				sb.append(&quot;,&quot;);</span>
				// }
			}
		} else {
<span class="nc" id="L398">			sb.append(&quot;minlen=&quot; + (length - 1));</span>
<span class="nc" id="L399">			sb.append(&quot;,&quot;);</span>
		}
<span class="nc" id="L401">		sb.append(&quot;color=\&quot;&quot; + StringUtils.sharp000000(lineColor) + &quot;\&quot;&quot;);</span>
<span class="nc bnc" id="L402" title="All 4 branches missed.">		if (hasNoteLabelText() || link.getLinkConstraint() != null) {</span>
<span class="nc" id="L403">			sb.append(&quot;,&quot;);</span>
<span class="nc bnc" id="L404" title="All 6 branches missed.">			if (graphvizVersion.useXLabelInsteadOfLabel() || dotMode == DotMode.NO_LEFT_RIGHT_AND_XLABEL</span>
					|| dotSplines == DotSplines.ORTHO) {
<span class="nc" id="L406">				sb.append(&quot;xlabel=&lt;&quot;);</span>
			} else {
<span class="nc" id="L408">				sb.append(&quot;label=&lt;&quot;);</span>
			}
<span class="nc bnc" id="L410" title="All 2 branches missed.">			XDimension2D dimNote = hasNoteLabelText() ? labelText.calculateDimension(stringBounder) : CONSTRAINT_SPOT;</span>
<span class="nc" id="L411">			dimNote = dimNote.delta(2 * labelShield);</span>

<span class="nc" id="L413">			appendTable(sb, eventuallyDivideByTwo(dimNote), noteLabelColor, graphvizVersion);</span>
<span class="nc" id="L414">			sb.append(&quot;&gt;&quot;);</span>
		}

<span class="nc bnc" id="L417" title="All 2 branches missed.">		if (startTailText != null) {</span>
<span class="nc" id="L418">			sb.append(&quot;,&quot;);</span>
<span class="nc" id="L419">			sb.append(&quot;taillabel=&lt;&quot;);</span>
<span class="nc" id="L420">			appendTable(sb, startTailText.calculateDimension(stringBounder), startTailColor, graphvizVersion);</span>
<span class="nc" id="L421">			sb.append(&quot;&gt;&quot;);</span>
		}
<span class="nc bnc" id="L423" title="All 2 branches missed.">		if (endHeadText != null) {</span>
<span class="nc" id="L424">			sb.append(&quot;,&quot;);</span>
<span class="nc" id="L425">			sb.append(&quot;headlabel=&lt;&quot;);</span>
<span class="nc" id="L426">			appendTable(sb, endHeadText.calculateDimension(stringBounder), endHeadColor, graphvizVersion);</span>
<span class="nc" id="L427">			sb.append(&quot;&gt;&quot;);</span>
		}

<span class="nc bnc" id="L430" title="All 2 branches missed.">		if (link.isInvis()) {</span>
<span class="nc" id="L431">			sb.append(&quot;,&quot;);</span>
<span class="nc" id="L432">			sb.append(&quot;style=invis&quot;);</span>
		}

<span class="nc bnc" id="L435" title="All 4 branches missed.">		if (link.isConstraint() == false || link.hasTwoEntryPointsSameContainer())</span>
<span class="nc" id="L436">			sb.append(&quot;,constraint=false&quot;);</span>

<span class="nc bnc" id="L438" title="All 2 branches missed.">		if (link.getSametail() != null)</span>
<span class="nc" id="L439">			sb.append(&quot;,sametail=&quot; + link.getSametail());</span>

<span class="nc" id="L441">		sb.append(&quot;];&quot;);</span>
<span class="nc" id="L442">		SvekUtils.println(sb);</span>
<span class="nc" id="L443">	}</span>
	// ::done

	private XDimension2D eventuallyDivideByTwo(XDimension2D dim) {
<span class="nc bnc" id="L447" title="All 2 branches missed.">		if (divideLabelWidthByTwo)</span>
<span class="nc" id="L448">			return new XDimension2D(dim.getWidth() / 2, dim.getHeight());</span>

<span class="nc" id="L450">		return dim;</span>
	}

	public String rankSame() {
		// if (graphvizVersion == GraphvizVersion.V2_34_0) {
		// return null;
		// }
<span class="nc bnc" id="L457" title="All 4 branches missed.">		if (pragma.isDefine(PragmaKey.HORIZONTAL_LINE_BETWEEN_DIFFERENT_PACKAGE_ALLOWED) == false &amp;&amp; link.getLength() == 1</span>
		/* &amp;&amp; graphvizVersion.isJs() == false */) {
<span class="nc" id="L459">			return &quot;{rank=same; &quot; + getStartUidPrefix() + &quot;; &quot; + getEndUidPrefix() + &quot;}&quot;;</span>
		}
<span class="nc" id="L461">		return null;</span>
	}

	public static void appendTable(StringBuilder sb, XDimension2D dim, int col, GraphvizVersion graphvizVersion) {
<span class="nc" id="L465">		final int w = (int) dim.getWidth();</span>
<span class="nc" id="L466">		final int h = (int) dim.getHeight();</span>
<span class="nc" id="L467">		appendTable(sb, w, h, col);</span>
<span class="nc" id="L468">	}</span>

	public static void appendTable(StringBuilder sb, int w, int h, int col) {
<span class="nc" id="L471">		sb.append(&quot;&lt;TABLE &quot;);</span>
<span class="nc" id="L472">		sb.append(&quot;BGCOLOR=\&quot;&quot; + StringUtils.sharp000000(col) + &quot;\&quot; &quot;);</span>
<span class="nc" id="L473">		sb.append(&quot;FIXEDSIZE=\&quot;TRUE\&quot; WIDTH=\&quot;&quot; + w + &quot;\&quot; HEIGHT=\&quot;&quot; + h + &quot;\&quot;&gt;&quot;);</span>
<span class="nc" id="L474">		sb.append(&quot;&lt;TR&quot;);</span>
<span class="nc" id="L475">		sb.append(&quot;&gt;&quot;);</span>
<span class="nc" id="L476">		sb.append(&quot;&lt;TD&quot;);</span>
		// sb.append(&quot; FIXEDSIZE=\&quot;TRUE\&quot; WIDTH=\&quot;&quot; + 0 + &quot;\&quot; HEIGHT=\&quot;&quot; + 0 +
		// &quot;\&quot;&quot;);
<span class="nc" id="L479">		sb.append(&quot;&gt;&quot;);</span>
<span class="nc" id="L480">		sb.append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="nc" id="L481">		sb.append(&quot;&lt;/TR&gt;&quot;);</span>
<span class="nc" id="L482">		sb.append(&quot;&lt;/TABLE&gt;&quot;);</span>
<span class="nc" id="L483">	}</span>

	public final String getStartUidPrefix() {
<span class="nc" id="L486">		return startUid.getPrefix();</span>
	}

	public final String getEndUidPrefix() {
<span class="nc" id="L490">		return endUid.getPrefix();</span>
	}

	private UDrawable getExtremitySpecial(XPoint2D center, LinkDecor decor, double angle, Cluster cluster,
			SvekNode nodeContact) {
<span class="nc" id="L495">		final ExtremityFactory extremityFactory = decor.getExtremityFactoryLegacy(backgroundColor);</span>
<span class="nc" id="L496">		return extremityFactory.createUDrawable(center, angle, null);</span>
	}

	private UDrawable getExtremitySimplier(XPoint2D center, ExtremityFactory extremityFactory, double angle,
			Cluster cluster, SvekNode nodeContact, boolean isStart, Kal kal) {
<span class="nc bnc" id="L501" title="All 2 branches missed.">		if (extremityFactory == null)</span>
<span class="nc" id="L502">			return null;</span>

<span class="nc" id="L504">		Side side = null;</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">		if (nodeContact != null)</span>
<span class="nc" id="L506">			side = nodeContact.getRectangleArea().getClosestSide(center);</span>

		final UTranslate translateForKal;
<span class="nc bnc" id="L509" title="All 2 branches missed.">		if (kal == null) {</span>
<span class="nc" id="L510">			translateForKal = new UTranslate(0, 0);</span>
		} else {
<span class="nc" id="L512">			translateForKal = kal.getTranslateForDecoration();</span>
<span class="nc" id="L513">			center = translateForKal.getTranslated(center);</span>
		}

<span class="nc" id="L516">		final Extremity extremity = (Extremity) extremityFactory.createUDrawable(center, angle, side);</span>
<span class="nc" id="L517">		final double decorationLength = extremity.getDecorationLength();</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">		if (isStart)</span>
<span class="nc" id="L519">			dotPath.moveStartPoint(</span>
<span class="nc" id="L520">					translateForKal.compose(new UTranslate(decorationLength, 0).rotate(angle - Math.PI)));</span>
		else
<span class="nc" id="L522">			dotPath.moveEndPoint(translateForKal.compose(new UTranslate(decorationLength, 0).rotate(angle - Math.PI)));</span>

<span class="nc" id="L524">		return extremity;</span>
	}

	private UDrawable getExtremity(final XPoint2D center, LinkDecor decor, PointListIterator pointListIterator,
			double angle, Cluster cluster, SvekNode nodeContact) {
<span class="nc" id="L529">		final ExtremityFactory extremityFactory = decor.getExtremityFactoryLegacy(backgroundColor);</span>

<span class="nc bnc" id="L531" title="All 2 branches missed.">		if (cluster != null) {</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">			if (extremityFactory != null) {</span>
				// System.err.println(&quot;angle=&quot; + angle * 180 / Math.PI);
<span class="nc" id="L534">				return extremityFactory.createUDrawable(center, angle, null);</span>
			}
<span class="nc bnc" id="L536" title="All 2 branches missed.">			if (decor == LinkDecor.EXTENDS)</span>
<span class="nc" id="L537">				return new ExtremityFactoryExtends(backgroundColor).createUDrawable(center, angle, null);</span>

<span class="nc" id="L539">			return null;</span>
		}

<span class="nc bnc" id="L542" title="All 2 branches missed.">		if (extremityFactory != null) {</span>
<span class="nc" id="L543">			final List&lt;XPoint2D&gt; points = pointListIterator.next();</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">			if (points.size() == 0)</span>
<span class="nc" id="L545">				return null;</span>
			// throw new IllegalStateException();
			// return extremityFactory.createUDrawable(center, angle, null);

<span class="nc" id="L549">			final XPoint2D p0 = points.get(0);</span>
<span class="nc" id="L550">			final XPoint2D p1 = points.get(1);</span>
<span class="nc" id="L551">			final XPoint2D p2 = points.get(2);</span>

<span class="nc" id="L553">			Side side = null;</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">			if (nodeContact != null)</span>
<span class="nc" id="L555">				side = nodeContact.getRectangleArea().getClosestSide(p1);</span>

<span class="nc" id="L557">			return extremityFactory.createTBRDrawableLegacy(p0, p1, p2, side);</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">		} else if (decor == LinkDecor.NONE) {</span>
<span class="nc" id="L559">			final UPolygon sh = new UPolygon(pointListIterator.cloneMe().next());</span>
<span class="nc" id="L560">			final XPoint2D contact = sh.checkMiddleContactForSpecificTriangle(center);</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">			if (contact != null) {</span>
<span class="nc" id="L562">				return new UDrawable() {</span>
					public void drawU(UGraphic ug) {
<span class="nc" id="L564">						ULine line = new ULine(contact.getX() - center.getX(), contact.getY() - center.getY());</span>
<span class="nc" id="L565">						ug = ug.apply(UTranslate.point(center));</span>
<span class="nc" id="L566">						ug.draw(line);</span>
<span class="nc" id="L567">					}</span>
				};
			}
<span class="nc bnc" id="L570" title="All 2 branches missed.">		} else if (decor != LinkDecor.NONE) {</span>
<span class="nc" id="L571">			final UPolygon sh = new UPolygon(pointListIterator.next());</span>
<span class="nc" id="L572">			return new ExtremityOther(sh);</span>
		}
<span class="nc" id="L574">		return null;</span>

	}

	public void solveLine(SvgResult fullSvg) {
<span class="nc bnc" id="L579" title="All 2 branches missed.">		if (this.link.isInvis())</span>
<span class="nc" id="L580">			return;</span>

<span class="nc" id="L582">		int idx = fullSvg.getIndexFromColor(this.lineColor);</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">		if (idx == -1) {</span>
<span class="nc" id="L584">			return;</span>
			// throw new IllegalStateException();
		}
<span class="nc" id="L587">		idx = fullSvg.indexOf(&quot;d=\&quot;&quot;, idx);</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">		if (idx == -1)</span>
<span class="nc" id="L589">			throw new IllegalStateException();</span>

<span class="nc" id="L591">		final int end = fullSvg.indexOf(&quot;\&quot;&quot;, idx + 3);</span>
<span class="nc" id="L592">		final SvgResult path = fullSvg.substring(idx + 3, end);</span>

<span class="nc bnc" id="L594" title="All 2 branches missed.">		if (path.isPathConsistent() == false)</span>
<span class="nc" id="L595">			return;</span>

<span class="nc" id="L597">		dotPath = path.toDotPath();</span>

<span class="nc" id="L599">		final XPoint2D tmpStartPoint = dotPath.getStartPoint();</span>
<span class="nc" id="L600">		final XPoint2D tmpEndPoint = dotPath.getEndPoint();</span>

<span class="nc" id="L602">		final SvekNode svekNode1 = getSvekNode1();</span>
<span class="nc" id="L603">		final SvekNode svekNode2 = getSvekNode2();</span>
<span class="nc bnc" id="L604" title="All 4 branches missed.">		if (svekNode1 != null &amp;&amp; svekNode2 != null) {</span>
<span class="nc" id="L605">			final XPoint2D tmpPos1 = svekNode1.getRectangleArea().getPointCenter();</span>
<span class="nc" id="L606">			final XPoint2D tmpPos2 = svekNode2.getRectangleArea().getPointCenter();</span>

<span class="nc" id="L608">			final double normal = tmpStartPoint.distance(tmpPos1) + tmpEndPoint.distance(tmpPos2);</span>
<span class="nc" id="L609">			final double inversed = tmpStartPoint.distance(tmpPos2) + tmpEndPoint.distance(tmpPos1);</span>

			// Sometime, GraphViz inverses the result line.
<span class="nc bnc" id="L612" title="All 2 branches missed.">			if (inversed &lt; normal)</span>
				// So we reverse the inversion...
<span class="nc" id="L614">				dotPath = dotPath.reverse();</span>
		}

		// Used for Kal
<span class="nc" id="L618">		dotPathInit = dotPath.copy();</span>

<span class="nc bnc" id="L620" title="All 2 branches missed.">		if (projectionCluster != null) {</span>
			// System.err.println(&quot;Line::solveLine1 projectionCluster=&quot; +
			// projectionCluster.getClusterPosition());
<span class="nc" id="L623">			projectionCluster.manageEntryExitPoint(stringBounder);</span>
			// System.err.println(&quot;Line::solveLine2 projectionCluster=&quot; +
			// projectionCluster.getClusterPosition());
			// if (lhead != null)
			// System.err.println(&quot;Line::solveLine ltail=&quot; + lhead.getClusterPosition());
			// if (ltail != null)
			// System.err.println(&quot;Line::solveLine ltail=&quot; + ltail.getClusterPosition());
		}
<span class="nc bnc" id="L631" title="All 2 branches missed.">		dotPath = dotPath.simulateCompound(lhead == null ? null : lhead.getRectangleArea(),</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">				ltail == null ? null : ltail.getRectangleArea());</span>

<span class="nc" id="L634">		final SvgResult lineSvg = fullSvg.substring(end);</span>
<span class="nc" id="L635">		PointListIterator pointListIterator = null;</span>

<span class="nc" id="L637">		final LinkType linkType = link.getType();</span>

<span class="nc bnc" id="L639" title="All 2 branches missed.">		if (getLinkStrategy() == LinkStrategy.SIMPLIER) {</span>
<span class="nc" id="L640">			this.extremity1 = getExtremitySimplier(dotPath.getStartPoint(),</span>
<span class="nc" id="L641">					linkType.getDecor2().getExtremityFactoryComplete(backgroundColor),</span>
<span class="nc" id="L642">					dotPath.getStartAngle() + Math.PI, ltail, svekNode1, true, kal1);</span>
<span class="nc" id="L643">			this.extremity2 = getExtremitySimplier(dotPath.getEndPoint(),</span>
<span class="nc" id="L644">					linkType.getDecor1().getExtremityFactoryComplete(backgroundColor), dotPath.getEndAngle(), lhead,</span>
					svekNode2, false, kal2);
		} else {
<span class="nc" id="L647">			pointListIterator = lineSvg.getPointsWithThisColor(lineColor);</span>
<span class="nc bnc" id="L648" title="All 6 branches missed.">			if (link.getLength() == 1 &amp;&amp; isThereTwo(linkType) &amp;&amp; count(pointListIterator.cloneMe()) == 2) {</span>
				// Sorry, this is ugly because of
				// https://github.com/plantuml/plantuml/issues/1353

<span class="nc" id="L652">				final List&lt;XPoint2D&gt; points = pointListIterator.next();</span>
<span class="nc" id="L653">				final XPoint2D p1 = points.get(1);</span>

<span class="nc" id="L655">				XPoint2D startPoint = dotPath.getStartPoint();</span>
<span class="nc" id="L656">				XPoint2D endPoint = dotPath.getEndPoint();</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">				if (p1.distance(startPoint) &lt; p1.distance(endPoint))</span>
<span class="nc" id="L658">					startPoint = p1;</span>
				else
<span class="nc" id="L660">					endPoint = p1;</span>

<span class="nc" id="L662">				this.extremity1 = getExtremitySpecial(startPoint, linkType.getDecor2(),</span>
<span class="nc" id="L663">						dotPath.getStartAngle() + Math.PI, ltail, svekNode1);</span>
<span class="nc" id="L664">				this.extremity2 = getExtremitySpecial(endPoint, linkType.getDecor1(), dotPath.getEndAngle(), lhead,</span>
						svekNode2);
<span class="nc" id="L666">			} else {</span>
<span class="nc" id="L667">				this.extremity1 = getExtremity(dotPath.getStartPoint(), linkType.getDecor2(), pointListIterator,</span>
<span class="nc" id="L668">						dotPath.getStartAngle() + Math.PI, ltail, svekNode1);</span>
<span class="nc" id="L669">				this.extremity2 = getExtremity(dotPath.getEndPoint(), linkType.getDecor1(), pointListIterator,</span>
<span class="nc" id="L670">						dotPath.getEndAngle(), lhead, svekNode2);</span>
			}
		}

<span class="nc bnc" id="L674" title="All 2 branches missed.">		if (link.getEntity1().getLeafType() == LeafType.LOLLIPOP_HALF)</span>
<span class="nc" id="L675">			svekNode1.addImpact(dotPath.getStartAngle() + Math.PI);</span>

<span class="nc bnc" id="L677" title="All 2 branches missed.">		if (link.getEntity2().getLeafType() == LeafType.LOLLIPOP_HALF)</span>
<span class="nc" id="L678">			svekNode2.addImpact(dotPath.getEndAngle());</span>

<span class="nc bnc" id="L680" title="All 6 branches missed.">		if (getLinkStrategy() == LinkStrategy.LEGACY_toberemoved &amp;&amp; extremity1 instanceof Extremity</span>
				&amp;&amp; extremity2 instanceof Extremity) {
<span class="nc" id="L682">			final XPoint2D p1 = ((Extremity) extremity1).somePoint();</span>
<span class="nc" id="L683">			final XPoint2D p2 = ((Extremity) extremity2).somePoint();</span>
<span class="nc bnc" id="L684" title="All 4 branches missed.">			if (p1 != null &amp;&amp; p2 != null) {</span>
				// http://plantuml.sourceforge.net/qa/?qa=4240/some-relations-point-wrong-direction-when-the-linetype-ortho
<span class="nc" id="L686">				final double dist1start = p1.distance(dotPath.getStartPoint());</span>
<span class="nc" id="L687">				final double dist1end = p1.distance(dotPath.getEndPoint());</span>
<span class="nc" id="L688">				final double dist2start = p2.distance(dotPath.getStartPoint());</span>
<span class="nc" id="L689">				final double dist2end = p2.distance(dotPath.getEndPoint());</span>
<span class="nc bnc" id="L690" title="All 4 branches missed.">				if (dist1start &gt; dist1end &amp;&amp; dist2end &gt; dist2start) {</span>
<span class="nc" id="L691">					pointListIterator = lineSvg.getPointsWithThisColor(lineColor);</span>
<span class="nc" id="L692">					this.extremity2 = getExtremity(dotPath.getEndPoint(), linkType.getDecor1(), pointListIterator,</span>
<span class="nc" id="L693">							dotPath.getEndAngle(), lhead, svekNode2);</span>
<span class="nc" id="L694">					this.extremity1 = getExtremity(dotPath.getStartPoint(), linkType.getDecor2(), pointListIterator,</span>
<span class="nc" id="L695">							dotPath.getStartAngle() + Math.PI, ltail, svekNode1);</span>
				}
			}

		}

<span class="nc bnc" id="L701" title="All 4 branches missed.">		if (hasNoteLabelText() || link.getLinkConstraint() != null) {</span>
<span class="nc" id="L702">			final XPoint2D pos = getXY(fullSvg, this.noteLabelColor);</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">			if (pos != null) {</span>
//				corner1.manage(pos);
<span class="nc bnc" id="L705" title="All 2 branches missed.">				this.labelXY = hasNoteLabelText() ? TextBlockUtils.asPositionable(labelText, stringBounder, pos)</span>
<span class="nc" id="L706">						: TextBlockUtils.asPositionable(CONSTRAINT_SPOT, stringBounder, pos);</span>
			}
		}

<span class="nc bnc" id="L710" title="All 2 branches missed.">		if (this.startTailText != null) {</span>
<span class="nc" id="L711">			final XPoint2D pos = getXY(fullSvg, this.startTailColor);</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">			if (pos != null) {</span>
//				corner1.manage(pos);
<span class="nc" id="L714">				this.startTailLabelXY = TextBlockUtils.asPositionable(startTailText, stringBounder, pos);</span>
			}
		}

<span class="nc bnc" id="L718" title="All 2 branches missed.">		if (this.endHeadText != null) {</span>
<span class="nc" id="L719">			final XPoint2D pos = getXY(fullSvg, this.endHeadColor);</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">			if (pos != null) {</span>
//				corner1.manage(pos);
<span class="nc" id="L722">				this.endHeadLabelXY = TextBlockUtils.asPositionable(endHeadText, stringBounder, pos);</span>
//				corner1.manage(pos.getX() - 15, pos.getY());
			}
		}

<span class="nc bnc" id="L727" title="All 2 branches missed.">		if (isOpalisable() == false)</span>
<span class="nc" id="L728">			setOpale(false);</span>

<span class="nc" id="L730">	}</span>

	private boolean isThereTwo(final LinkType linkType) {
<span class="nc bnc" id="L733" title="All 2 branches missed.">		return linkType.getDecor2().getExtremityFactoryLegacy(backgroundColor) != null</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">				&amp;&amp; linkType.getDecor1().getExtremityFactoryLegacy(backgroundColor) != null;</span>
	}

	private int count(PointListIterator it) {
<span class="nc" id="L738">		int nb = 0;</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">		while (it.hasNext()) {</span>
<span class="nc" id="L740">			it.next();</span>
<span class="nc" id="L741">			nb++;</span>
		}
<span class="nc" id="L743">		return nb;</span>
	}

	private SvekNode getSvekNode2() {
<span class="nc" id="L747">		return bibliotekon.getNode(link.getEntity2());</span>
	}

	private SvekNode getSvekNode1() {
<span class="nc" id="L751">		return bibliotekon.getNode(link.getEntity1());</span>
	}

	private Cluster getSvekCluster1() {
<span class="nc" id="L755">		return bibliotekon.getCluster(link.getEntity1());</span>
	}

	private Cluster getSvekCluster2() {
<span class="nc" id="L759">		return bibliotekon.getCluster(link.getEntity2());</span>
	}

	private boolean isOpalisable() {
<span class="nc bnc" id="L763" title="All 2 branches missed.">		return dotPath.getBeziers().size() &lt;= 1;</span>
	}

	private XPoint2D getXY(SvgResult svgResult, int color) {
<span class="nc" id="L767">		final int idx = svgResult.getIndexFromColor(color);</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">		if (idx == -1)</span>
<span class="nc" id="L769">			return null;</span>

<span class="nc" id="L771">		return SvekUtils.getMinXY(svgResult.substring(idx).extractList(SvgResult.POINTS_EQUALS));</span>

	}

	private StyleSignature getDefaultStyleDefinition(Stereotype stereotype) {
<span class="nc" id="L776">		final StyleSignature result = StyleSignatureBasic.of(SName.root, SName.element, diagramType().getStyleName(),</span>
				SName.arrow);

<span class="nc" id="L779">		return result.withTOBECHANGED(stereotype);</span>
	}

	private Set&lt;String&gt; ids;

	public void setSharedIds(Set&lt;String&gt; ids) {
<span class="nc" id="L785">		this.ids = ids;</span>
<span class="nc" id="L786">	}</span>

	@DuplicateCode(reference = &quot;MyElkPath&quot;)
	public void drawU(UGraphic ug) {

<span class="nc bnc" id="L791" title="All 2 branches missed.">		if (opale)</span>
<span class="nc" id="L792">			return;</span>

<span class="nc bnc" id="L794" title="All 2 branches missed.">		if (link.isInvis())</span>
<span class="nc" id="L795">			return;</span>

<span class="nc bnc" id="L797" title="All 2 branches missed.">		if (dotPath == null) {</span>
<span class="nc" id="L798">			Log.info(() -&gt; &quot;DotPath is null for &quot; + this);</span>
<span class="nc" id="L799">			return;</span>
		}

<span class="nc" id="L802">		ug.draw(link.commentForSvg());</span>
<span class="nc" id="L803">		final UGroup group = new UGroup(link.getLocation());</span>
<span class="nc" id="L804">		group.put(UGroupType.DATA_UID, link.getUid());</span>
<span class="nc" id="L805">		group.put(UGroupType.CLASS, &quot;link&quot;);</span>
<span class="nc" id="L806">		group.put(UGroupType.ID, &quot;link_&quot; + link.getEntity1().getName() + &quot;_&quot; + link.getEntity2().getName());</span>
<span class="nc" id="L807">		group.put(UGroupType.DATA_ENTITY_1, link.getEntity1().getName());</span>
<span class="nc" id="L808">		group.put(UGroupType.DATA_ENTITY_2, link.getEntity2().getName());</span>
<span class="nc" id="L809">		group.put(UGroupType.DATA_ENTITY_1_UID, link.getEntity1().getUid());</span>
<span class="nc" id="L810">		group.put(UGroupType.DATA_ENTITY_2_UID, link.getEntity2().getUid());</span>
<span class="nc" id="L811">		ug.startGroup(group);</span>
<span class="nc" id="L812">		double x = 0;</span>
<span class="nc" id="L813">		double y = 0;</span>
<span class="nc" id="L814">		final Url url = link.getUrl();</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">		if (url != null)</span>
<span class="nc" id="L816">			ug.startUrl(url);</span>

<span class="nc bnc" id="L818" title="All 2 branches missed.">		if (link.isAutoLinkOfAGroup()) {</span>
<span class="nc" id="L819">			final Cluster cl = bibliotekon.getCluster((Entity) link.getEntity1());</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">			if (cl != null) {</span>
<span class="nc" id="L821">				x += cl.getRectangleArea().getWidth();</span>
<span class="nc" id="L822">				x -= dotPath.getStartPoint().getX() - cl.getRectangleArea().getMinX();</span>
			}
		}

<span class="nc" id="L826">		x += dx;</span>
<span class="nc" id="L827">		y += dy;</span>

<span class="nc" id="L829">		final StyleBuilder currentStyleBuilder = this.getCurrentStyleBuilder();</span>
<span class="nc" id="L830">		final Style styleLine = getDefaultStyleDefinition(this.getStereotype()).getMergedStyle(currentStyleBuilder);</span>
<span class="nc" id="L831">		final UStroke suggestedStroke = styleLine.getStroke();</span>
<span class="nc" id="L832">		final Rainbow rainbow = Rainbow.build(styleLine, this.skinParam.getIHtmlColorSet());</span>

		// Warning: duplicated from SmetanaPath and SvekEdge

<span class="nc" id="L836">		HColor arrowHeadColor = rainbow.getArrowHeadColor();</span>
<span class="nc" id="L837">		HColor color = rainbow.getColor();</span>

<span class="nc bnc" id="L839" title="All 2 branches missed.">		if (this.link.getColors() != null) {</span>
<span class="nc" id="L840">			final HColor newColor = this.link.getColors().getColor(ColorType.ARROW, ColorType.LINE);</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">			if (newColor != null) {</span>
<span class="nc" id="L842">				color = newColor;</span>
<span class="nc" id="L843">				arrowHeadColor = color;</span>
			}
<span class="nc bnc" id="L845" title="All 2 branches missed.">		} else if (this.link.getSpecificColor() != null) {</span>
<span class="nc" id="L846">			color = this.link.getSpecificColor();</span>
<span class="nc" id="L847">			arrowHeadColor = color;</span>
		}

<span class="nc" id="L850">		ug = ug.apply(HColors.none().bg()).apply(color);</span>
<span class="nc" id="L851">		final LinkType linkType = link.getType();</span>
		UStroke stroke;
<span class="nc bnc" id="L853" title="All 4 branches missed.">		if (suggestedStroke == null || linkType.getStyle().isNormal() == false)</span>
<span class="nc" id="L854">			stroke = linkType.getStroke3(defaultThickness);</span>
		else
<span class="nc" id="L856">			stroke = linkType.getStroke3(suggestedStroke);</span>

<span class="nc bnc" id="L858" title="All 4 branches missed.">		if (link.getColors() != null &amp;&amp; link.getColors().getSpecificLineStroke() != null)</span>
<span class="nc" id="L859">			stroke = link.getColors().getSpecificLineStroke();</span>

<span class="nc" id="L861">		ug = ug.apply(stroke);</span>

<span class="nc" id="L863">		DotPath todraw = dotPath.copy();</span>

		// Apply corner rounding if pragma is set
<span class="nc" id="L866">		final String radiusStr = pragma.getValue(PragmaKey.EDGE_CORNER_RADIUS);</span>
<span class="nc bnc" id="L867" title="All 2 branches missed.">		if (radiusStr != null) {</span>
			try {
<span class="nc" id="L869">				final double radius = Double.parseDouble(radiusStr);</span>
<span class="nc bnc" id="L870" title="All 2 branches missed.">				if (radius &gt; 0)</span>
<span class="nc" id="L871">					todraw.muteToRoundOrthogonalPaths(radius);</span>
<span class="nc" id="L872">			} catch (NumberFormatException e) {</span>
				// Ignore invalid radius values
<span class="nc" id="L874">			}</span>
		}

<span class="nc" id="L877">		UTranslate magneticForce1 = UTranslate.none();</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">		if (getSvekNode1() != null) {</span>
<span class="nc" id="L879">			final MagneticBorder magneticBorder1 = getSvekNode1().getMagneticBorder();</span>
<span class="nc" id="L880">			magneticForce1 = magneticBorder1.getForceAt(ug.getStringBounder(), todraw.getStartPoint().move(dx, dy));</span>
<span class="nc" id="L881">			todraw.moveStartPoint(magneticForce1);</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">		} else if (getSvekCluster1() != null) {</span>
<span class="nc" id="L883">			final MagneticBorder magneticBorder1 = getSvekCluster1().getMagneticBorder();</span>
<span class="nc" id="L884">			magneticForce1 = magneticBorder1.getForceAt(ug.getStringBounder(), todraw.getStartPoint().move(dx, dy));</span>
<span class="nc" id="L885">			todraw.moveStartPoint(magneticForce1);</span>
		}

<span class="nc" id="L888">		UTranslate magneticForce2 = UTranslate.none();</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">		if (getSvekNode2() != null) {</span>
<span class="nc" id="L890">			final MagneticBorder magneticBorder2 = getSvekNode2().getMagneticBorder();</span>
<span class="nc" id="L891">			magneticForce2 = magneticBorder2.getForceAt(ug.getStringBounder(), todraw.getEndPoint().move(dx, dy));</span>
<span class="nc" id="L892">			todraw.moveEndPoint(magneticForce2);</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">		} else if (getSvekCluster2() != null) {</span>
<span class="nc" id="L894">			final MagneticBorder magneticBorder2 = getSvekCluster2().getMagneticBorder();</span>
<span class="nc" id="L895">			magneticForce2 = magneticBorder2.getForceAt(ug.getStringBounder(), todraw.getEndPoint().move(dx, dy));</span>
<span class="nc" id="L896">			todraw.moveEndPoint(magneticForce2);</span>
		}

<span class="nc" id="L899">		todraw.setCommentAndCodeLine(uniq(ids, link.idCommentForSvg()), link.getCodeLine());</span>

<span class="nc" id="L901">		drawRainbow(ug.apply(new UTranslate(x, y)), color, arrowHeadColor, todraw, link.getSupplementaryColors(),</span>
				stroke, magneticForce1, magneticForce2);

<span class="nc" id="L904">		ug = ug.apply(UStroke.simple()).apply(color);</span>

<span class="nc bnc" id="L906" title="All 4 branches missed.">		if (hasNoteLabelText() &amp;&amp; this.labelXY != null</span>
<span class="nc bnc" id="L907" title="All 4 branches missed.">				&amp;&amp; (link.getNote() == null || link.getNote().getStrategy() != NoteLinkStrategy.HALF_NOT_PRINTED))</span>
<span class="nc" id="L908">			this.labelText.drawU(ug.apply(new UTranslate(x + this.labelXY.getPosition().getX() + labelShield,</span>
<span class="nc" id="L909">					y + this.labelXY.getPosition().getY() + labelShield)));</span>

<span class="nc bnc" id="L911" title="All 6 branches missed.">		if (this.startTailText != null &amp;&amp; this.startTailLabelXY != null &amp;&amp; this.startTailLabelXY.getPosition() != null)</span>
<span class="nc" id="L912">			this.startTailText.drawU(ug.apply(new UTranslate(x + this.startTailLabelXY.getPosition().getX(),</span>
<span class="nc" id="L913">					y + this.startTailLabelXY.getPosition().getY())));</span>

<span class="nc bnc" id="L915" title="All 6 branches missed.">		if (this.endHeadText != null &amp;&amp; this.endHeadLabelXY != null &amp;&amp; this.endHeadLabelXY.getPosition() != null)</span>
<span class="nc" id="L916">			this.endHeadText.drawU(ug.apply(new UTranslate(x + this.endHeadLabelXY.getPosition().getX(),</span>
<span class="nc" id="L917">					y + this.endHeadLabelXY.getPosition().getY())));</span>

<span class="nc bnc" id="L919" title="All 2 branches missed.">		if (linkType.getMiddleDecor() != LinkMiddleDecor.NONE) {</span>
<span class="nc" id="L920">			final PointAndAngle middle = dotPath.getMiddle();</span>
<span class="nc" id="L921">			final double angleRad = middle.getAngle();</span>
<span class="nc" id="L922">			final double angleDeg = -angleRad * 180.0 / Math.PI;</span>
<span class="nc" id="L923">			final UDrawable mi = linkType.getMiddleDecor().getMiddleFactory(arrowLollipopColor, backgroundColor)</span>
<span class="nc" id="L924">					.createUDrawable(angleDeg - 45);</span>
<span class="nc" id="L925">			mi.drawU(ug.apply(new UTranslate(x + middle.getX(), y + middle.getY())));</span>
		}

<span class="nc bnc" id="L928" title="All 2 branches missed.">		if (url != null)</span>
<span class="nc" id="L929">			ug.closeUrl();</span>

<span class="nc bnc" id="L931" title="All 2 branches missed.">		if (link.getLinkConstraint() != null) {</span>
<span class="nc" id="L932">			final double xConstraint = x + this.labelXY.getPosition().getX();</span>
<span class="nc" id="L933">			final double yConstraint = y + this.labelXY.getPosition().getY();</span>
//			ug.apply(new UTranslate(xConstraint, yConstraint)).draw(URectangle.build(10, 10));
<span class="nc" id="L935">			final List&lt;XPoint2D&gt; square = getSquare(xConstraint, yConstraint);</span>
<span class="nc" id="L936">			final Set&lt;XPoint2D&gt; bez = todraw.sample();</span>
<span class="nc" id="L937">			XPoint2D minPt = null;</span>
<span class="nc" id="L938">			double minDist = Double.MAX_VALUE;</span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">			for (XPoint2D pt : square)</span>
<span class="nc bnc" id="L940" title="All 2 branches missed.">				for (XPoint2D pt2 : bez) {</span>
<span class="nc" id="L941">					final double distance = pt2.distance(pt);</span>
<span class="nc bnc" id="L942" title="All 4 branches missed.">					if (minPt == null || distance &lt; minDist) {</span>
<span class="nc" id="L943">						minPt = pt;</span>
<span class="nc" id="L944">						minDist = distance;</span>
					}
<span class="nc" id="L946">				}</span>

<span class="nc" id="L948">			link.getLinkConstraint().setPosition(link, minPt);</span>
<span class="nc" id="L949">			link.getLinkConstraint().drawMe(ug, skinParam);</span>
		}

<span class="nc bnc" id="L952" title="All 2 branches missed.">		if (kal1 != null)</span>
<span class="nc" id="L953">			kal1.drawU(ug);</span>

<span class="nc bnc" id="L955" title="All 2 branches missed.">		if (kal2 != null)</span>
<span class="nc" id="L956">			kal2.drawU(ug);</span>

<span class="nc" id="L958">		ug.closeGroup();</span>
<span class="nc" id="L959">	}</span>

	public void computeKal() {
<span class="nc bnc" id="L962" title="All 2 branches missed.">		if (kal1 != null) {</span>
<span class="nc" id="L963">			final UTranslate tr = UTranslate.point(dotPathInit.getStartPoint()).compose(new UTranslate(dx, dy));</span>
<span class="nc" id="L964">			kal1.setTranslate(tr, extremity1);</span>
		}
<span class="nc bnc" id="L966" title="All 2 branches missed.">		if (kal2 != null) {</span>
<span class="nc" id="L967">			final UTranslate tr = UTranslate.point(dotPathInit.getEndPoint()).compose(new UTranslate(dx, dy));</span>
<span class="nc" id="L968">			kal2.setTranslate(tr, extremity2);</span>
		}
<span class="nc" id="L970">	}</span>

	private List&lt;XPoint2D&gt; getSquare(double x, double y) {
<span class="nc" id="L973">		final List&lt;XPoint2D&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L974">		result.add(new XPoint2D(x, y));</span>
<span class="nc" id="L975">		result.add(new XPoint2D(x + 5, y));</span>
<span class="nc" id="L976">		result.add(new XPoint2D(x + 10, y));</span>
<span class="nc" id="L977">		result.add(new XPoint2D(x, y + 5));</span>
<span class="nc" id="L978">		result.add(new XPoint2D(x + 10, y + 5));</span>
<span class="nc" id="L979">		result.add(new XPoint2D(x, y + 10));</span>
<span class="nc" id="L980">		result.add(new XPoint2D(x + 5, y + 10));</span>
<span class="nc" id="L981">		result.add(new XPoint2D(x + 10, y + 10));</span>
<span class="nc" id="L982">		return result;</span>
	}

	private String uniq(final Set&lt;String&gt; ids, final String comment) {
<span class="nc" id="L986">		boolean changed = ids.add(comment);</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">		if (changed)</span>
<span class="nc" id="L988">			return comment;</span>

<span class="nc" id="L990">		int i = 1;</span>
		while (true) {
<span class="nc" id="L992">			final String candidate = comment + &quot;-&quot; + i;</span>
<span class="nc" id="L993">			changed = ids.add(candidate);</span>
<span class="nc bnc" id="L994" title="All 2 branches missed.">			if (changed)</span>
<span class="nc" id="L995">				return candidate;</span>
<span class="nc" id="L996">			i++;</span>
<span class="nc" id="L997">		}</span>
	}

	private void drawRainbow(UGraphic ug, HColor color, HColor headColor, DotPath todraw,
			List&lt;Colors&gt; supplementaryColors, UStroke stroke, UTranslate magneticForce1, UTranslate magneticForce2) {
<span class="nc" id="L1002">		ug.draw(todraw);</span>
<span class="nc" id="L1003">		final LinkType linkType = link.getType();</span>

<span class="nc bnc" id="L1005" title="All 2 branches missed.">		if (headColor.isTransparent()) {</span>
<span class="nc bnc" id="L1006" title="All 2 branches missed.">			if (this.extremity1 instanceof ExtremityArrow) {</span>
<span class="nc" id="L1007">				final UGraphic ugHead = ug.apply(color).apply(stroke.onlyThickness());</span>
<span class="nc" id="L1008">				((ExtremityArrow) this.extremity1).drawLineIfTransparent(ugHead.apply(magneticForce1));</span>
<span class="nc" id="L1009">			}</span>
<span class="nc bnc" id="L1010" title="All 2 branches missed.">		} else if (this.extremity1 != null) {</span>
<span class="nc" id="L1011">			UGraphic ugHead = ug.apply(headColor).apply(stroke.onlyThickness());</span>
<span class="nc bnc" id="L1012" title="All 2 branches missed.">			if (linkType.getDecor2().isFill())</span>
<span class="nc" id="L1013">				ugHead = ugHead.apply(color.bg());</span>
			else
<span class="nc" id="L1015">				ugHead = ugHead.apply(HColors.none().bg());</span>
<span class="nc" id="L1016">			this.extremity1.drawU(ugHead.apply(magneticForce1));</span>
		}

<span class="nc bnc" id="L1019" title="All 2 branches missed.">		if (headColor.isTransparent()) {</span>
<span class="nc bnc" id="L1020" title="All 2 branches missed.">			if (this.extremity2 instanceof ExtremityArrow) {</span>
<span class="nc" id="L1021">				final UGraphic ugHead = ug.apply(color).apply(stroke.onlyThickness());</span>
<span class="nc" id="L1022">				((ExtremityArrow) this.extremity2).drawLineIfTransparent(ugHead.apply(magneticForce2));</span>
<span class="nc" id="L1023">			}</span>
<span class="nc bnc" id="L1024" title="All 2 branches missed.">		} else if (this.extremity2 != null) {</span>
<span class="nc" id="L1025">			UGraphic ugHead = ug.apply(headColor).apply(stroke.onlyThickness());</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">			if (linkType.getDecor1().isFill())</span>
<span class="nc" id="L1027">				ugHead = ugHead.apply(color.bg());</span>
			else
<span class="nc" id="L1029">				ugHead = ugHead.apply(HColors.none().bg());</span>
<span class="nc" id="L1030">			this.extremity2.drawU(ugHead.apply(magneticForce2));</span>
		}

<span class="nc" id="L1033">		int i = 0;</span>
<span class="nc bnc" id="L1034" title="All 2 branches missed.">		for (Colors colors : supplementaryColors) {</span>
<span class="nc" id="L1035">			ug.apply(new UTranslate(2 * (i + 1), 2 * (i + 1))).apply(colors.getColor(ColorType.LINE)).draw(todraw);</span>
<span class="nc" id="L1036">			i++;</span>
<span class="nc" id="L1037">		}</span>
<span class="nc" id="L1038">	}</span>

	public boolean isInverted() {
<span class="nc" id="L1041">		return link.isInverted();</span>
	}

	private double getDecorDzeta() {
<span class="nc" id="L1045">		final LinkType linkType = link.getType();</span>
<span class="nc" id="L1046">		final int size1 = linkType.getDecor1().getMargin();</span>
<span class="nc" id="L1047">		final int size2 = linkType.getDecor2().getMargin();</span>
<span class="nc" id="L1048">		return size1 + size2;</span>
	}

	public double getHorizontalDzeta(StringBounder stringBounder) {
<span class="nc bnc" id="L1052" title="All 2 branches missed.">		if (startUid.equalsId(endUid))</span>
<span class="nc" id="L1053">			return getDecorDzeta();</span>

		final ArithmeticStrategy strategy;
<span class="nc bnc" id="L1056" title="All 2 branches missed.">		if (isHorizontal())</span>
<span class="nc" id="L1057">			strategy = new ArithmeticStrategySum();</span>
		else
<span class="nc" id="L1059">			return 0;</span>

<span class="nc bnc" id="L1061" title="All 2 branches missed.">		if (hasNoteLabelText())</span>
<span class="nc" id="L1062">			strategy.eat(labelText.calculateDimension(stringBounder).getWidth());</span>

<span class="nc bnc" id="L1064" title="All 2 branches missed.">		if (startTailText != null)</span>
<span class="nc" id="L1065">			strategy.eat(startTailText.calculateDimension(stringBounder).getWidth());</span>

<span class="nc bnc" id="L1067" title="All 2 branches missed.">		if (endHeadText != null)</span>
<span class="nc" id="L1068">			strategy.eat(endHeadText.calculateDimension(stringBounder).getWidth());</span>

<span class="nc" id="L1070">		return strategy.getResult() + getDecorDzeta();</span>
	}

	private boolean isHorizontal() {
<span class="nc bnc" id="L1074" title="All 2 branches missed.">		return link.getLength() == 1;</span>
	}

	public double getVerticalDzeta(StringBounder stringBounder) {
<span class="nc bnc" id="L1078" title="All 2 branches missed.">		if (startUid.equalsId(endUid))</span>
<span class="nc" id="L1079">			return getDecorDzeta();</span>

<span class="nc bnc" id="L1081" title="All 2 branches missed.">		if (isHorizontal())</span>
<span class="nc" id="L1082">			return 0;</span>

<span class="nc" id="L1084">		final ArithmeticStrategy strategy = new ArithmeticStrategySum();</span>
<span class="nc bnc" id="L1085" title="All 2 branches missed.">		if (hasNoteLabelText())</span>
<span class="nc" id="L1086">			strategy.eat(labelText.calculateDimension(stringBounder).getHeight());</span>

<span class="nc bnc" id="L1088" title="All 2 branches missed.">		if (startTailText != null)</span>
<span class="nc" id="L1089">			strategy.eat(startTailText.calculateDimension(stringBounder).getHeight());</span>

<span class="nc bnc" id="L1091" title="All 2 branches missed.">		if (endHeadText != null)</span>
<span class="nc" id="L1092">			strategy.eat(endHeadText.calculateDimension(stringBounder).getHeight());</span>

<span class="nc" id="L1094">		return strategy.getResult() + getDecorDzeta();</span>
	}

	public void manageCollision(Collection&lt;SvekNode&gt; allNodes) {
<span class="nc bnc" id="L1098" title="All 2 branches missed.">		for (SvekNode sh : allNodes) {</span>
<span class="nc" id="L1099">			final Positionable cl = PositionableUtils.addMargin(sh, 8, 8);</span>
<span class="nc bnc" id="L1100" title="All 6 branches missed.">			if (startTailText != null &amp;&amp; startTailLabelXY != null &amp;&amp; PositionableUtils.intersect(cl, startTailLabelXY))</span>
<span class="nc" id="L1101">				startTailLabelXY = PositionableUtils.moveAwayFrom(cl, startTailLabelXY);</span>

<span class="nc bnc" id="L1103" title="All 6 branches missed.">			if (endHeadText != null &amp;&amp; endHeadLabelXY != null &amp;&amp; PositionableUtils.intersect(cl, endHeadLabelXY))</span>
<span class="nc" id="L1104">				endHeadLabelXY = PositionableUtils.moveAwayFrom(cl, endHeadLabelXY);</span>

<span class="nc" id="L1106">		}</span>

<span class="nc" id="L1108">	}</span>

	private XPoint2D avoid2(XPoint2D move, Positionable pos, SvekNode sh) {
<span class="nc" id="L1111">		final Oscillator oscillator = new Oscillator();</span>
<span class="nc" id="L1112">		final XPoint2D orig = new XPoint2D(move.x, move.y);</span>
<span class="nc bnc" id="L1113" title="All 2 branches missed.">		while (cut(pos, sh)) {</span>
<span class="nc" id="L1114">			final XPoint2D m = oscillator.nextPosition();</span>
<span class="nc" id="L1115">			move = new XPoint2D(orig.x + m.x, orig.y + m.y);</span>
<span class="nc" id="L1116">		}</span>
<span class="nc" id="L1117">		return move;</span>
	}

	private boolean cut(Positionable pos, SvekNode sh) {
<span class="nc bnc" id="L1121" title="All 4 branches missed.">		return BezierUtils.intersect(pos, sh) || tooClose(pos);</span>
	}

	private boolean tooClose(Positionable pos) {
<span class="nc" id="L1125">		final double dist = dotPath.getMinDist(BezierUtils.getCenter(pos));</span>
<span class="nc" id="L1126">		final XDimension2D dim = pos.getSize();</span>
		// Log.println(&quot;dist=&quot; + dist);
<span class="nc bnc" id="L1128" title="All 4 branches missed.">		return dist &lt; (dim.getWidth() / 2 + 2) || dist &lt; (dim.getHeight() / 2 + 2);</span>
	}

	public void moveDelta(double deltaX, double deltaY) {
<span class="nc" id="L1132">		this.dx += deltaX;</span>
<span class="nc" id="L1133">		this.dy += deltaY;</span>
<span class="nc" id="L1134">	}</span>

	public final DotPath getDotPath() {
<span class="nc" id="L1137">		final DotPath result = dotPath.copy();</span>
<span class="nc" id="L1138">		result.moveDelta(dx, dy);</span>
<span class="nc" id="L1139">		return result;</span>
	}

	public int getLength() {
<span class="nc" id="L1143">		return link.getLength();</span>
	}

	public void setOpale(boolean opale) {
<span class="nc" id="L1147">		this.link.setOpale(opale);</span>
<span class="nc" id="L1148">		this.opale = opale;</span>

<span class="nc" id="L1150">	}</span>

	public boolean isOpale() {
<span class="nc" id="L1153">		return opale;</span>
	}

	public boolean isHorizontalSolitary() {
<span class="nc" id="L1157">		return link.isHorizontalSolitary();</span>
	}

	public boolean isLinkFromOrTo(Entity group) {
<span class="nc bnc" id="L1161" title="All 4 branches missed.">		return link.getEntity1() == group || link.getEntity2() == group;</span>
	}

	public boolean hasEntryPoint() {
<span class="nc" id="L1165">		return link.hasEntryPoint();</span>
	}

	public void setProjectionCluster(Cluster cluster) {
<span class="nc" id="L1169">		this.projectionCluster = cluster;</span>

<span class="nc" id="L1171">	}</span>

	public boolean isHidden() {
<span class="nc" id="L1174">		return link.isHidden();</span>
	}

	public boolean sameConnections(SvekEdge other) {
<span class="nc" id="L1178">		return link.sameConnections(other.link);</span>
	}

	private boolean isAutolink() {
<span class="nc bnc" id="L1182" title="All 2 branches missed.">		return link.getEntity1() == link.getEntity2();</span>
	}

	public XPoint2D getMyPoint(Entity entity) {
<span class="nc bnc" id="L1186" title="All 2 branches missed.">		if (link.getEntity1() == entity)</span>
<span class="nc" id="L1187">			return moveDelta(dotPath.getStartPoint());</span>

<span class="nc bnc" id="L1189" title="All 2 branches missed.">		if (link.getEntity2() == entity)</span>
<span class="nc" id="L1190">			return moveDelta(dotPath.getEndPoint());</span>

<span class="nc" id="L1192">		throw new IllegalArgumentException();</span>
	}

	private XPoint2D moveDelta(XPoint2D pt) {
<span class="nc" id="L1196">		return new UTranslate(dx, dy).getTranslated(pt);</span>
		// return new XPoint2D(pt.getX() + dx, pt.getY() + dy);
	}

	public boolean isLink(Link link) {
<span class="nc bnc" id="L1201" title="All 2 branches missed.">		return this.link == link;</span>
	}

	public XPoint2D getStartContactPoint() {
<span class="nc bnc" id="L1205" title="All 2 branches missed.">		if (dotPath == null)</span>
<span class="nc" id="L1206">			return null;</span>
<span class="nc" id="L1207">		final XPoint2D start = dotPath.getStartPoint();</span>
<span class="nc bnc" id="L1208" title="All 2 branches missed.">		if (start == null)</span>
<span class="nc" id="L1209">			return null;</span>

<span class="nc" id="L1211">		return new UTranslate(dx, dy).getTranslated(start);</span>
		// return new XPoint2D(dx + start.getX(), dy + start.getY());
	}

	public XPoint2D getEndContactPoint() {
<span class="nc" id="L1216">		final XPoint2D end = dotPath.getEndPoint();</span>
<span class="nc bnc" id="L1217" title="All 2 branches missed.">		if (end == null)</span>
<span class="nc" id="L1218">			return null;</span>

<span class="nc" id="L1220">		return new UTranslate(dx, dy).getTranslated(end);</span>
		// return new XPoint2D(dx + end.getX(), dy + end.getY());
	}

	public StyleBuilder getCurrentStyleBuilder() {
<span class="nc" id="L1225">		return link.getStyleBuilder();</span>
	}

	public Stereotype getStereotype() {
<span class="nc" id="L1229">		return link.getStereotype();</span>
	}

	public void moveStartPoint(double dx, double dy) {
<span class="nc" id="L1233">		dotPath.moveStartPoint(dx, dy);</span>
<span class="nc" id="L1234">		dotPathInit.moveStartPoint(dx, dy);</span>
<span class="nc" id="L1235">	}</span>

	public void moveEndPoint(double dx, double dy) {
<span class="nc" id="L1238">		dotPath.moveEndPoint(dx, dy);</span>
<span class="nc" id="L1239">		dotPathInit.moveEndPoint(dx, dy);</span>
<span class="nc" id="L1240">	}</span>

	public void replaceDotPath(net.sourceforge.plantuml.klimt.shape.DotPath newPath) {
<span class="nc" id="L1243">		this.dotPath = newPath;</span>
<span class="nc" id="L1244">		this.dotPathInit = newPath.copy();</span>
<span class="nc" id="L1245">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>