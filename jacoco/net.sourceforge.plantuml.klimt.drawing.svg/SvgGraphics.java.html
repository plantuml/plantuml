<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SvgGraphics.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">plantuml</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.plantuml.klimt.drawing.svg</a> &gt; <span class="el_source">SvgGraphics.java</span></div><h1>SvgGraphics.java</h1><pre class="source lang-java linenums">/* ========================================================================
 * PlantUML : a free UML diagram generator
 * ========================================================================
 *
 * (C) Copyright 2009-2025, Arnaud Roques
 *
 * Project Info:  https://plantuml.com
 *
 * If you like this project or if you find it useful, you can support us at:
 *
 * https://plantuml.com/patreon (only 1$ per month!)
 * https://plantuml.com/paypal
 *
 * This file is part of PlantUML.
 *
 * PlantUML is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * PlantUML distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
 * License for more details.
 *
 * You should have received a copy of the GNU General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301,
 * USA.
 *
 *
 * Original Author:  Arnaud Roques
 *
 *
 */
package net.sourceforge.plantuml.klimt.drawing.svg;

import java.awt.geom.PathIterator;
import java.awt.image.BufferedImage;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Objects;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.OutputKeys;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerException;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

import net.sourceforge.plantuml.klimt.color.HColor.TransparentFillBehavior;
import org.w3c.dom.CDATASection;
import org.w3c.dom.Comment;
import org.w3c.dom.Document;
import org.w3c.dom.Element;

import net.sourceforge.plantuml.FileUtils;
import net.sourceforge.plantuml.code.TranscoderUtil;
import net.sourceforge.plantuml.klimt.UGroupType;
import net.sourceforge.plantuml.klimt.UPath;
import net.sourceforge.plantuml.klimt.color.HColor;
import net.sourceforge.plantuml.klimt.color.HColorGradient;
import net.sourceforge.plantuml.klimt.geom.USegment;
import net.sourceforge.plantuml.klimt.geom.USegmentType;
import net.sourceforge.plantuml.klimt.geom.XDimension2D;
import net.sourceforge.plantuml.klimt.shape.UImageSvg;
import net.sourceforge.plantuml.log.Logme;
import net.sourceforge.plantuml.security.SImageIO;
import net.sourceforge.plantuml.security.SecurityProfile;
import net.sourceforge.plantuml.security.SecurityUtils;
import net.sourceforge.plantuml.skin.PragmaKey;
import net.sourceforge.plantuml.utils.Base64Coder;
import net.sourceforge.plantuml.utils.Log;
import net.sourceforge.plantuml.xml.XmlFactories;

import static net.sourceforge.plantuml.klimt.color.HColor.TransparentFillBehavior.WITH_FILL_NONE;

<span class="fc" id="L90">public class SvgGraphics {</span>
	// ::remove file when __HAXE__

	// http://tutorials.jenkov.com/svg/index.html
	// http://www.svgbasics.com/
	// http://apike.ca/prog_svg_text.html
	// http://www.w3.org/TR/SVG11/shapes.html
	// http://en.wikipedia.org/wiki/Scalable_Vector_Graphics

	// Animation:
	// http://srufaculty.sru.edu/david.dailey/svg/
	// Shadow:
	// http://www.svgbasics.com/filters3.html
	// http://www.w3schools.com/svg/svg_feoffset.asp
	// http://www.adobe.com/svg/demos/samples.html

	private static final String XLINK_TITLE1 = &quot;title&quot;;
	private static final String XLINK_TITLE2 = &quot;xlink:title&quot;;
	private static final String XLINK_HREF1 = &quot;href&quot;;
	private static final String XLINK_HREF2 = &quot;xlink:href&quot;;

	final private Document document;
	final private Element root;
	final private Element defs;
	final private Element gRoot;

<span class="fc" id="L116">	private String fill = &quot;black&quot;;</span>
<span class="fc" id="L117">	private String stroke = &quot;black&quot;;</span>

	private String strokeWidth;
<span class="fc" id="L120">	private String strokeDasharray = null;</span>
	private final String backcolorString;

<span class="fc" id="L123">	private int maxX = 10;</span>
<span class="fc" id="L124">	private int maxY = 10;</span>

	private final String filterUid;
	private final String shadowId;
	private final String gradientId;

	private final SvgOption option;

	private Element pendingBackground;
<span class="fc" id="L133">	private boolean robotoAdded = false;</span>

	final protected void ensureVisible(double x, double y) {
<span class="fc bfc" id="L136" title="All 2 branches covered.">		if (x &gt; maxX)</span>
<span class="fc" id="L137">			maxX = (int) (x + 1);</span>

<span class="fc bfc" id="L139" title="All 2 branches covered.">		if (y &gt; maxY)</span>
<span class="fc" id="L140">			maxY = (int) (y + 1);</span>

<span class="fc" id="L142">	}</span>

<span class="fc" id="L144">	public SvgGraphics(long seed, SvgOption option) {</span>
		try {
<span class="fc" id="L146">			this.document = getDocument();</span>

<span class="fc" id="L148">			this.option = option;</span>
<span class="fc" id="L149">			final XDimension2D minDim = option.getMinDim();</span>
<span class="fc" id="L150">			ensureVisible(minDim.getWidth(), minDim.getHeight());</span>

<span class="fc" id="L152">			this.root = getRootNode();</span>

<span class="fc bfc" id="L154" title="All 2 branches covered.">			for (Map.Entry&lt;String, String&gt; ent : option.getRootAttributes().entrySet())</span>
<span class="fc" id="L155">				root.setAttribute(ent.getKey(), ent.getValue());</span>

			// Create a node named defs, which will be the parent
			// for a pair of linear gradient definitions.
<span class="fc" id="L159">			defs = simpleElement(&quot;defs&quot;);</span>
<span class="fc" id="L160">			gRoot = simpleElement(&quot;g&quot;);</span>
<span class="fc" id="L161">			strokeWidth = format(1);</span>
<span class="fc" id="L162">			this.filterUid = &quot;b&quot; + getSeed(seed);</span>
<span class="fc" id="L163">			this.shadowId = &quot;f&quot; + getSeed(seed);</span>
<span class="fc" id="L164">			this.gradientId = &quot;g&quot; + getSeed(seed);</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">			if (option.getHover() != null)</span>
<span class="nc" id="L166">				defs.appendChild(getPathHover(option.getHover()));</span>

<span class="pc bpc" id="L168" title="1 of 2 branches missed.">			if (option.isInteractive()) {</span>
<span class="nc" id="L169">				final Element styles = getStylesForInteractiveMode();</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">				if (styles != null)</span>
<span class="nc" id="L171">					defs.appendChild(styles);</span>

<span class="nc" id="L173">				final Element script = getScriptForInteractiveMode();</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">				if (script != null)</span>
<span class="nc" id="L175">					defs.appendChild(script);</span>
			}

<span class="fc" id="L178">			final HColor backcolor = option.getBackcolor();</span>

<span class="pc bpc" id="L180" title="1 of 2 branches missed.">			if (backcolor instanceof HColorGradient) {</span>
<span class="nc" id="L181">				this.backcolorString = null;</span>
<span class="nc" id="L182">				HColorGradient gr = (HColorGradient) backcolor;</span>
<span class="nc" id="L183">				final String id = this.createSvgGradient(gr.getColor1().toRGB(option.getColorMapper()),</span>
<span class="nc" id="L184">						gr.getColor2().toRGB(option.getColorMapper()), gr.getPolicy());</span>
<span class="nc" id="L185">				this.paintBackcolor(&quot;url(#&quot; + id + &quot;)&quot;);</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">			} else if (backcolor == null) {</span>
<span class="nc" id="L187">				this.backcolorString = null;</span>
			} else {
<span class="fc" id="L189">				this.backcolorString = backcolor.toSvg(option.getColorMapper());</span>
<span class="fc" id="L190">				final String color = backcolor.toSvg(option.getColorMapper());</span>
<span class="pc bpc" id="L191" title="1 of 4 branches missed.">				if (color.equals(&quot;#00000000&quot;) == false &amp;&amp; color.equals(&quot;#000000&quot;) == false</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">						&amp;&amp; color.equals(&quot;#FFFFFF&quot;) == false)</span>
<span class="fc" id="L193">					this.paintBackcolor(color);</span>
			}

<span class="nc" id="L196">		} catch (ParserConfigurationException e) {</span>
<span class="nc" id="L197">			Logme.error(e);</span>
<span class="nc" id="L198">			throw new IllegalStateException(e);</span>
<span class="fc" id="L199">		}</span>
<span class="fc" id="L200">	}</span>

	private void addRoboto() {
<span class="nc bnc" id="L203" title="All 2 branches missed.">		if (robotoAdded)</span>
<span class="nc" id="L204">			return;</span>
		// https://stackoverflow.com/questions/36253961/using-google-fonts-with-svg-object
<span class="nc" id="L206">		final Element style = document.createElement(&quot;style&quot;);</span>
<span class="nc" id="L207">		style.setAttribute(&quot;type&quot;, &quot;text/css&quot;);</span>
<span class="nc" id="L208">		style.setTextContent(</span>
				&quot;@import url('https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic');&quot;);
<span class="nc" id="L210">		defs.appendChild(style);</span>
<span class="nc" id="L211">		robotoAdded = true;</span>
<span class="nc" id="L212">	}</span>

	private void paintBackcolor(String back) {
<span class="fc" id="L215">		setFillColor(back);</span>
<span class="fc" id="L216">		setStrokeColor(null);</span>
<span class="fc" id="L217">		pendingBackground = createRectangleInternal(0, 0, 0, 0);</span>
<span class="fc" id="L218">		getG().appendChild(pendingBackground);</span>
<span class="fc" id="L219">	}</span>

	private Element getStylesForInteractiveMode() {
<span class="nc" id="L222">		final Element style = simpleElement(&quot;style&quot;);</span>
<span class="nc" id="L223">		final String text = getData(option.getInteractiveBaseFilename() + &quot;.css&quot;);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">		if (text == null)</span>
<span class="nc" id="L225">			return null;</span>

<span class="nc" id="L227">		final CDATASection cdata = document.createCDATASection(text);</span>
<span class="nc" id="L228">		style.setAttribute(&quot;type&quot;, &quot;text/css&quot;);</span>
<span class="nc" id="L229">		style.appendChild(cdata);</span>
<span class="nc" id="L230">		return style;</span>
	}

//	private Element getStylesForDarkness() {
//		final Element style = simpleElement(&quot;style&quot;);
//		final StringBuilder text1 = new StringBuilder();
//		final StringBuilder text2 = new StringBuilder(&quot;@media (prefers-color-scheme:dark) {&quot;);
//		final Pattern p = Pattern.compile(&quot;^(\\w)_(\\w+)_(\\w+)$&quot;);
//		for (String s : this.classesForDarkness) {
//			final Matcher m = p.matcher(s);
//			if (m.matches() == false)
//				throw new IllegalStateException();
//			final String color1 = m.group(2);
//			final String color2 = m.group(3);
//			final String type = m.group(1);
//			if (&quot;f&quot;.equals(type)) {
//				text1.append(&quot;*.&quot; + s + &quot; {fill:#&quot; + color1 + &quot;;}&quot;);
//				text2.append(&quot;*.&quot; + s + &quot; {fill:#&quot; + color2 + &quot;;}&quot;);
//			} else if (&quot;s&quot;.equals(type)) {
//				text1.append(&quot;*.&quot; + s + &quot; {stroke:#&quot; + color1 + &quot;;}&quot;);
//				text2.append(&quot;*.&quot; + s + &quot; {stroke:#&quot; + color2 + &quot;;}&quot;);
//			} else
//				throw new IllegalStateException();
//		}
//		text2.append(&quot;}&quot;);
//		final CDATASection cdata = document.createCDATASection(text1.toString() + text2.toString());
//		style.setAttribute(&quot;type&quot;, &quot;text/css&quot;);
//		style.appendChild(cdata);
//		return style;
//	}

	private Element getScriptForInteractiveMode() {
<span class="nc" id="L262">		final Element script = document.createElement(&quot;script&quot;);</span>
<span class="nc" id="L263">		final String text = getData(option.getInteractiveBaseFilename() + &quot;.js&quot;);</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">		if (text == null)</span>
<span class="nc" id="L265">			return null;</span>

<span class="nc" id="L267">		script.setTextContent(text);</span>
<span class="nc" id="L268">		return script;</span>
	}

	private static String getData(final String name) {
		try {
<span class="nc" id="L273">			final InputStream is = SvgGraphics.class.getResourceAsStream(&quot;/svg/&quot; + name);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">			if (is == null)</span>
<span class="nc" id="L275">				Log.error(&quot;Cannot retrieve &quot; + name);</span>
			else
<span class="nc" id="L277">				return FileUtils.readText(is);</span>
<span class="nc" id="L278">		} catch (IOException e) {</span>
<span class="nc" id="L279">			Logme.error(e);</span>
<span class="nc" id="L280">		}</span>
<span class="nc" id="L281">		return null;</span>
	}

	private Element getPathHover(String hover) {
<span class="nc" id="L285">		final Element style = simpleElement(&quot;style&quot;);</span>
<span class="nc" id="L286">		final CDATASection cdata = document.createCDATASection(&quot;path:hover { stroke: &quot; + hover + &quot; !important;}&quot;);</span>
<span class="nc" id="L287">		style.setAttribute(&quot;type&quot;, &quot;text/css&quot;);</span>
<span class="nc" id="L288">		style.appendChild(cdata);</span>
<span class="nc" id="L289">		return style;</span>
	}

	private static String getSeed(final long seed) {
<span class="fc" id="L293">		return Long.toString(Math.abs(seed), 36);</span>
	}

	// This method returns a reference to a simple XML
	// element node that has no attributes.
	private Element simpleElement(String type) {
<span class="fc" id="L299">		final Element theElement = document.createElement(type);</span>
<span class="fc" id="L300">		root.appendChild(theElement);</span>
<span class="fc" id="L301">		return theElement;</span>
	}

	private Document getDocument() throws ParserConfigurationException {
<span class="fc" id="L305">		final DocumentBuilder builder = XmlFactories.newDocumentBuilder();</span>
<span class="fc" id="L306">		final Document document = builder.newDocument();</span>
<span class="fc" id="L307">		document.setXmlStandalone(true);</span>
<span class="fc" id="L308">		return document;</span>
	}

	// This method returns a reference to a root node that
	// has already been appended to the document.
	private Element getRootNode() {
		// Create the root node named svg and append it to
		// the document.
<span class="fc" id="L316">		final Element svg = document.createElement(&quot;svg&quot;);</span>
<span class="fc" id="L317">		document.appendChild(svg);</span>

		// Set some attributes on the root node that are
		// required for proper rendering. Note that the
		// approach used here is somewhat different from the
		// approach used in the earlier program named Svg01,
		// particularly with regard to the style.
<span class="fc" id="L324">		svg.setAttribute(&quot;xmlns&quot;, &quot;http://www.w3.org/2000/svg&quot;);</span>
<span class="fc" id="L325">		svg.setAttribute(&quot;xmlns:xlink&quot;, &quot;http://www.w3.org/1999/xlink&quot;);</span>
<span class="fc" id="L326">		svg.setAttribute(&quot;version&quot;, &quot;1.1&quot;);</span>

<span class="fc bfc" id="L328" title="All 2 branches covered.">		if (option.getTitle() != null) {</span>
			// Create a title element and set its text
<span class="fc" id="L330">			final Element title = document.createElement(&quot;title&quot;);</span>
<span class="fc" id="L331">			title.setTextContent(option.getTitle());</span>
<span class="fc" id="L332">			svg.appendChild(title);</span>
		}

<span class="fc" id="L335">		final String desc = option.getDesc();</span>
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">		if (desc != null) {</span>
			// Create a desc element and set its text
<span class="nc" id="L338">			final Element descElement = document.createElement(&quot;desc&quot;);</span>
<span class="nc" id="L339">			descElement.setTextContent(desc);</span>
<span class="nc" id="L340">			svg.appendChild(descElement);</span>
		}
<span class="fc" id="L342">		return svg;</span>
	}

	public void svgEllipse(double x, double y, double xRadius, double yRadius, double deltaShadow) {
<span class="nc" id="L346">		manageShadow(deltaShadow);</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">		if (hidden == false) {</span>
<span class="nc" id="L348">			final Element elt = document.createElement(&quot;ellipse&quot;);</span>
<span class="nc" id="L349">			elt.setAttribute(&quot;cx&quot;, format(x));</span>
<span class="nc" id="L350">			elt.setAttribute(&quot;cy&quot;, format(y));</span>
<span class="nc" id="L351">			elt.setAttribute(&quot;rx&quot;, format(xRadius));</span>
<span class="nc" id="L352">			elt.setAttribute(&quot;ry&quot;, format(yRadius));</span>
<span class="nc" id="L353">			fillMe(elt);</span>
<span class="nc" id="L354">			styleMe(elt);</span>
<span class="nc" id="L355">			addFilterShadowId(elt, deltaShadow);</span>
<span class="nc" id="L356">			getG().appendChild(elt);</span>
		}
<span class="nc" id="L358">		ensureVisible(x + xRadius + deltaShadow * 2, y + yRadius + deltaShadow * 2);</span>
<span class="nc" id="L359">	}</span>

	public void svgArcEllipse(double rx, double ry, double x1, double y1, double x2, double y2) {
<span class="nc bnc" id="L362" title="All 2 branches missed.">		if (hidden == false) {</span>
<span class="nc" id="L363">			final String path = &quot;M&quot; + format(x1) + &quot;,&quot; + format(y1) + &quot; A&quot; + format(rx) + &quot;,&quot; + format(ry) + &quot; 0 0 0 &quot;</span>
<span class="nc" id="L364">					+ format(x2) + &quot; &quot; + format(y2);</span>
<span class="nc" id="L365">			final Element elt = document.createElement(&quot;path&quot;);</span>
<span class="nc" id="L366">			elt.setAttribute(&quot;d&quot;, path);</span>
<span class="nc" id="L367">			fillMe(elt);</span>
<span class="nc" id="L368">			styleMe(elt);</span>
<span class="nc" id="L369">			getG().appendChild(elt);</span>
		}
<span class="nc" id="L371">		ensureVisible(x1, y1);</span>
<span class="nc" id="L372">		ensureVisible(x2, y2);</span>
<span class="nc" id="L373">	}</span>

<span class="fc" id="L375">	private Map&lt;List&lt;Object&gt;, String&gt; gradients = new HashMap&lt;List&lt;Object&gt;, String&gt;();</span>

	public String createSvgGradient(String color1, String color2, char policy) {
<span class="nc" id="L378">		final List&lt;Object&gt; key = Arrays.asList((Object) color1, color2, policy);</span>
<span class="nc" id="L379">		String id = gradients.get(key);</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">		if (id == null) {</span>
<span class="nc" id="L381">			final Element elt = document.createElement(&quot;linearGradient&quot;);</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">			if (policy == '|') {</span>
<span class="nc" id="L383">				elt.setAttribute(&quot;x1&quot;, &quot;0%&quot;);</span>
<span class="nc" id="L384">				elt.setAttribute(&quot;y1&quot;, &quot;50%&quot;);</span>
<span class="nc" id="L385">				elt.setAttribute(&quot;x2&quot;, &quot;100%&quot;);</span>
<span class="nc" id="L386">				elt.setAttribute(&quot;y2&quot;, &quot;50%&quot;);</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">			} else if (policy == '\\') {</span>
<span class="nc" id="L388">				elt.setAttribute(&quot;x1&quot;, &quot;0%&quot;);</span>
<span class="nc" id="L389">				elt.setAttribute(&quot;y1&quot;, &quot;100%&quot;);</span>
<span class="nc" id="L390">				elt.setAttribute(&quot;x2&quot;, &quot;100%&quot;);</span>
<span class="nc" id="L391">				elt.setAttribute(&quot;y2&quot;, &quot;0%&quot;);</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">			} else if (policy == '-') {</span>
<span class="nc" id="L393">				elt.setAttribute(&quot;x1&quot;, &quot;50%&quot;);</span>
<span class="nc" id="L394">				elt.setAttribute(&quot;y1&quot;, &quot;0%&quot;);</span>
<span class="nc" id="L395">				elt.setAttribute(&quot;x2&quot;, &quot;50%&quot;);</span>
<span class="nc" id="L396">				elt.setAttribute(&quot;y2&quot;, &quot;100%&quot;);</span>
			} else {
<span class="nc" id="L398">				elt.setAttribute(&quot;x1&quot;, &quot;0%&quot;);</span>
<span class="nc" id="L399">				elt.setAttribute(&quot;y1&quot;, &quot;0%&quot;);</span>
<span class="nc" id="L400">				elt.setAttribute(&quot;x2&quot;, &quot;100%&quot;);</span>
<span class="nc" id="L401">				elt.setAttribute(&quot;y2&quot;, &quot;100%&quot;);</span>
			}
<span class="nc" id="L403">			id = gradientId + gradients.size();</span>
<span class="nc" id="L404">			gradients.put(key, id);</span>
<span class="nc" id="L405">			elt.setAttribute(&quot;id&quot;, id);</span>

<span class="nc" id="L407">			final Element stop1 = document.createElement(&quot;stop&quot;);</span>
<span class="nc" id="L408">			stop1.setAttribute(&quot;stop-color&quot;, color1);</span>
<span class="nc" id="L409">			stop1.setAttribute(&quot;offset&quot;, &quot;0%&quot;);</span>
<span class="nc" id="L410">			final Element stop2 = document.createElement(&quot;stop&quot;);</span>
<span class="nc" id="L411">			stop2.setAttribute(&quot;stop-color&quot;, color2);</span>
<span class="nc" id="L412">			stop2.setAttribute(&quot;offset&quot;, &quot;100%&quot;);</span>

<span class="nc" id="L414">			elt.appendChild(stop1);</span>
<span class="nc" id="L415">			elt.appendChild(stop2);</span>
<span class="nc" id="L416">			defs.appendChild(elt);</span>
		}
<span class="nc" id="L418">		return id;</span>
	}

	public final void setFillColor(String fill) {
<span class="fc" id="L422">		setFillColor(fill, WITH_FILL_NONE);</span>
<span class="fc" id="L423">	}</span>

	public final void setFillColor(String fill, TransparentFillBehavior transparentFillBehaviour) {
<span class="pc bpc" id="L426" title="1 of 3 branches missed.">		switch (transparentFillBehaviour) {</span>
		case WITH_FILL_NONE:
<span class="fc" id="L428">			this.fill = fixColor(fill);</span>
<span class="fc" id="L429">			break;</span>
		case WITH_FILL_OPACITY:
<span class="fc" id="L431">			this.fill = fill;</span>
			break;
		}
<span class="fc" id="L434">	}</span>

	public final void setStrokeColor(String stroke) {
<span class="fc" id="L437">		this.stroke = fixColor(stroke);</span>
<span class="fc" id="L438">	}</span>

	// https://forum.plantuml.net/12469/package-background-transparent-package-default-background?show=12479#c12479
	// https://github.com/plantuml/plantuml-server/issues/348#issuecomment-2581253011
	// https://github.com/plantuml/plantuml/issues/2071
	private String fixColor(String color) {
<span class="fc bfc" id="L444" title="All 4 branches covered.">		return color == null || &quot;#00000000&quot;.equals(color) ? &quot;none&quot; : color;</span>
	}

	public final void setStrokeWidth(double strokeWidth, double[] strokeDasharray) {
<span class="fc" id="L448">		this.strokeWidth = format(strokeWidth);</span>
<span class="fc bfc" id="L449" title="All 2 branches covered.">		if (strokeDasharray == null)</span>
<span class="fc" id="L450">			this.strokeDasharray = null;</span>
		else
<span class="fc" id="L452">			this.strokeDasharray = &quot;&quot; + format(strokeDasharray[0]) + &quot;,&quot; + format(strokeDasharray[1]);</span>
<span class="fc" id="L453">	}</span>

	public final Element getG() {
<span class="fc bfc" id="L456" title="All 2 branches covered.">		if (pendingElements.size() == 0)</span>
<span class="fc" id="L457">			return gRoot;</span>

<span class="fc" id="L459">		return pendingElements.get(0);</span>
	}

	public void svgRectangle(double x, double y, double width, double height, double rx, double ry, double deltaShadow
	/* , String id, String codeLine */) {
<span class="pc bpc" id="L464" title="2 of 4 branches missed.">		if (height &lt;= 0 || width &lt;= 0) {</span>
<span class="nc" id="L465">			return;</span>
			// To be restored when Teoz will be finished
			// throw new IllegalArgumentException();
		}
<span class="fc" id="L469">		manageShadow(deltaShadow);</span>
<span class="pc bpc" id="L470" title="1 of 2 branches missed.">		if (hidden == false) {</span>
<span class="fc" id="L471">			final Element elt = createRectangleInternal(x, y, width, height);</span>
<span class="fc" id="L472">			addFilterShadowId(elt, deltaShadow);</span>
<span class="pc bpc" id="L473" title="1 of 4 branches missed.">			if (rx &gt; 0 &amp;&amp; ry &gt; 0) {</span>
<span class="fc" id="L474">				elt.setAttribute(&quot;rx&quot;, format(rx));</span>
<span class="fc" id="L475">				elt.setAttribute(&quot;ry&quot;, format(ry));</span>
			}
//			if (id != null)
//				elt.setAttribute(&quot;id&quot;, id);
//
//			if (codeLine != null)
//				elt.setAttribute(&quot;codeLine&quot;, codeLine);

<span class="fc" id="L483">			getG().appendChild(elt);</span>
		}
<span class="fc" id="L485">		ensureVisible(x + width + 2 * deltaShadow, y + height + 2 * deltaShadow);</span>
<span class="fc" id="L486">	}</span>

	private Element createRectangleInternal(double x, double y, double width, double height) {
<span class="fc" id="L489">		final Element elt = document.createElement(&quot;rect&quot;);</span>
<span class="fc" id="L490">		elt.setAttribute(&quot;x&quot;, format(x));</span>
<span class="fc" id="L491">		elt.setAttribute(&quot;y&quot;, format(y));</span>
<span class="fc" id="L492">		elt.setAttribute(&quot;width&quot;, format(width));</span>
<span class="fc" id="L493">		elt.setAttribute(&quot;height&quot;, format(height));</span>
<span class="fc" id="L494">		fillMe(elt);</span>
<span class="fc" id="L495">		styleMe(elt);</span>
<span class="fc" id="L496">		return elt;</span>
	}

	public void svgLine(double x1, double y1, double x2, double y2, double deltaShadow) {
<span class="fc" id="L500">		manageShadow(deltaShadow);</span>
<span class="pc bpc" id="L501" title="1 of 2 branches missed.">		if (hidden == false) {</span>
<span class="fc" id="L502">			final Element elt = document.createElement(&quot;line&quot;);</span>
<span class="fc" id="L503">			elt.setAttribute(&quot;x1&quot;, format(x1));</span>
<span class="fc" id="L504">			elt.setAttribute(&quot;y1&quot;, format(y1));</span>
<span class="fc" id="L505">			elt.setAttribute(&quot;x2&quot;, format(x2));</span>
<span class="fc" id="L506">			elt.setAttribute(&quot;y2&quot;, format(y2));</span>
<span class="fc" id="L507">			styleMe(elt);</span>
<span class="fc" id="L508">			addFilterShadowId(elt, deltaShadow);</span>
<span class="fc" id="L509">			getG().appendChild(elt);</span>
		}
<span class="fc" id="L511">		ensureVisible(x1 + 2 * deltaShadow, y1 + 2 * deltaShadow);</span>
<span class="fc" id="L512">		ensureVisible(x2 + 2 * deltaShadow, y2 + 2 * deltaShadow);</span>
<span class="fc" id="L513">	}</span>

	private void styleMe(Element elt) {
<span class="fc bfc" id="L516" title="All 2 branches covered.">		if (strokeWidth.equals(&quot;0&quot;))</span>
<span class="fc" id="L517">			return;</span>

<span class="fc" id="L519">		final StringBuilder style = new StringBuilder();</span>

<span class="fc" id="L521">		style.append(&quot;stroke:&quot; + stroke + &quot;;&quot;);</span>
<span class="fc" id="L522">		style.append(&quot;stroke-width:&quot; + strokeWidth + &quot;;&quot;);</span>

<span class="fc bfc" id="L524" title="All 2 branches covered.">		if (strokeDasharray != null)</span>
<span class="fc" id="L525">			style.append(&quot;stroke-dasharray:&quot; + strokeDasharray + &quot;;&quot;);</span>

<span class="fc" id="L527">		elt.setAttribute(&quot;style&quot;, style.toString());</span>
<span class="fc" id="L528">	}</span>

	public void svgPolygon(double deltaShadow, double... points) {
<span class="pc bpc" id="L531" title="1 of 2 branches missed.">		assert points.length % 2 == 0;</span>
<span class="fc" id="L532">		manageShadow(deltaShadow);</span>
<span class="pc bpc" id="L533" title="1 of 2 branches missed.">		if (hidden == false) {</span>
<span class="fc" id="L534">			final Element elt = document.createElement(&quot;polygon&quot;);</span>
<span class="fc" id="L535">			final StringBuilder sb = new StringBuilder();</span>
<span class="fc bfc" id="L536" title="All 2 branches covered.">			for (double coord : points) {</span>
<span class="fc bfc" id="L537" title="All 2 branches covered.">				if (sb.length() &gt; 0)</span>
<span class="fc" id="L538">					sb.append(&quot;,&quot;);</span>

<span class="fc" id="L540">				sb.append(format(coord));</span>
			}
<span class="fc" id="L542">			elt.setAttribute(&quot;points&quot;, sb.toString());</span>
<span class="fc" id="L543">			fillMe(elt);</span>
<span class="fc" id="L544">			styleMe(elt);</span>
<span class="fc" id="L545">			addFilterShadowId(elt, deltaShadow);</span>
<span class="fc" id="L546">			getG().appendChild(elt);</span>
		}

<span class="fc bfc" id="L549" title="All 2 branches covered.">		for (int i = 0; i &lt; points.length; i += 2) {</span>
<span class="fc" id="L550">			ensureVisible(points[i] + 2 * deltaShadow, points[i + 1] + 2 * deltaShadow);</span>
		}

<span class="fc" id="L553">	}</span>

	public void text(String text, double x, double y, String fontFamily, int fontSize, String fontWeight,
			String fontStyle, String textDecoration, double textLength, Map&lt;String, String&gt; attributes,
			String textBackColor) {
<span class="pc bpc" id="L558" title="1 of 2 branches missed.">		if (hidden == false) {</span>
<span class="fc" id="L559">			final Element elt = document.createElement(&quot;text&quot;);</span>
			// required for web-kit based browsers
			// elt.setAttribute(&quot;text-rendering&quot;, &quot;geometricPrecision&quot;);
<span class="fc" id="L562">			elt.setAttribute(&quot;x&quot;, format(x));</span>
<span class="fc" id="L563">			elt.setAttribute(&quot;y&quot;, format(y));</span>
<span class="fc" id="L564">			fillMe(elt);</span>
<span class="fc" id="L565">			elt.setAttribute(&quot;font-size&quot;, format(fontSize));</span>
			// elt.setAttribute(&quot;text-anchor&quot;, &quot;middle&quot;);

//			if (option.getFont() == null) {
<span class="pc bpc" id="L569" title="1 of 2 branches missed.">			if (option.getLengthAdjust() == LengthAdjust.SPACING) {</span>
<span class="fc" id="L570">				elt.setAttribute(&quot;lengthAdjust&quot;, &quot;spacing&quot;);</span>
<span class="fc" id="L571">				elt.setAttribute(&quot;textLength&quot;, format(textLength));</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">			} else if (option.getLengthAdjust() == LengthAdjust.SPACING_AND_GLYPHS) {</span>
<span class="nc" id="L573">				elt.setAttribute(&quot;lengthAdjust&quot;, &quot;spacingAndGlyphs&quot;);</span>
<span class="nc" id="L574">				elt.setAttribute(&quot;textLength&quot;, format(textLength));</span>
			}
//			}

<span class="fc bfc" id="L578" title="All 2 branches covered.">			if (fontWeight != null)</span>
<span class="fc" id="L579">				elt.setAttribute(&quot;font-weight&quot;, fontWeight);</span>

<span class="fc bfc" id="L581" title="All 2 branches covered.">			if (fontStyle != null)</span>
<span class="fc" id="L582">				elt.setAttribute(&quot;font-style&quot;, fontStyle);</span>

<span class="fc bfc" id="L584" title="All 2 branches covered.">			if (textDecoration != null)</span>
<span class="fc" id="L585">				elt.setAttribute(&quot;text-decoration&quot;, textDecoration);</span>

<span class="pc bpc" id="L587" title="1 of 2 branches missed.">			if (fontFamily != null) {</span>

<span class="pc bpc" id="L589" title="1 of 2 branches missed.">				if (&quot;roboto&quot;.equalsIgnoreCase(fontFamily))</span>
<span class="nc" id="L590">					addRoboto();</span>

				// http://plantuml.sourceforge.net/qa/?qa=5432/svg-monospace-output-has-wrong-font-family
<span class="fc bfc" id="L593" title="All 2 branches covered.">				if (&quot;monospaced&quot;.equalsIgnoreCase(fontFamily))</span>
<span class="fc" id="L594">					fontFamily = &quot;monospace&quot;;</span>

<span class="fc" id="L596">				elt.setAttribute(&quot;font-family&quot;, fontFamily);</span>

<span class="pc bpc" id="L598" title="1 of 4 branches missed.">				if (fontFamily.equalsIgnoreCase(&quot;monospace&quot;) || fontFamily.equalsIgnoreCase(&quot;courier&quot;))</span>
<span class="fc" id="L599">					text = text.replace(' ', (char) 160);</span>

			}
<span class="pc bpc" id="L602" title="1 of 2 branches missed.">			if (textBackColor != null) {</span>
<span class="nc" id="L603">				final String backFilterId = getFilterBackColor(textBackColor);</span>
<span class="nc" id="L604">				elt.setAttribute(&quot;filter&quot;, &quot;url(#&quot; + backFilterId + &quot;)&quot;);</span>
			}
<span class="pc bpc" id="L606" title="1 of 2 branches missed.">			for (Map.Entry&lt;String, String&gt; ent : attributes.entrySet())</span>
<span class="nc" id="L607">				elt.setAttribute(ent.getKey(), ent.getValue());</span>

<span class="fc" id="L609">			elt.setTextContent(text);</span>
			// elt.appendChild(document.createCDATASection(text));
<span class="fc" id="L611">			getG().appendChild(elt);</span>

			// http://forum.plantuml.net/9158/hyperlink-without-underline
			// if (textDecoration != null &amp;&amp; textDecoration.contains(&quot;underline&quot;)) {
			// final double delta = 2;
			// final Element elt2 = document.createElement(&quot;line&quot;);
			// elt2.setAttribute(&quot;x1&quot;, format(x));
			// elt2.setAttribute(&quot;y1&quot;, format(y + delta));
			// elt2.setAttribute(&quot;x2&quot;, format(x + textLength));
			// elt2.setAttribute(&quot;y2&quot;, format(y + delta));
			// elt2.setAttribute(&quot;style&quot;, getStyleInternal(fill, &quot;1.0&quot;, null));
			// getG().appendChild(elt2);
			// }

		}
<span class="fc" id="L626">		ensureVisible(x, y);</span>
<span class="fc" id="L627">		ensureVisible(x + textLength, y);</span>
<span class="fc" id="L628">	}</span>

<span class="fc" id="L630">	private final Map&lt;String, String&gt; filterBackColor = new HashMap&lt;String, String&gt;();</span>

	private String getIdFilterBackColor(String color) {
<span class="nc" id="L633">		String result = filterBackColor.get(color);</span>
<span class="nc bnc" id="L634" title="All 2 branches missed.">		if (result == null) {</span>
<span class="nc" id="L635">			result = filterUid + filterBackColor.size();</span>
<span class="nc" id="L636">			filterBackColor.put(color, result);</span>
		}
<span class="nc" id="L638">		return result;</span>
	}

	private String getFilterBackColor(String color) {
<span class="nc" id="L642">		String id = filterBackColor.get(color);</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">		if (id != null)</span>
<span class="nc" id="L644">			return id;</span>

<span class="nc" id="L646">		id = getIdFilterBackColor(color);</span>
<span class="nc" id="L647">		final Element filter = document.createElement(&quot;filter&quot;);</span>
<span class="nc" id="L648">		filter.setAttribute(&quot;id&quot;, id);</span>
<span class="nc" id="L649">		filter.setAttribute(&quot;x&quot;, &quot;0&quot;);</span>
<span class="nc" id="L650">		filter.setAttribute(&quot;y&quot;, &quot;0&quot;);</span>
<span class="nc" id="L651">		filter.setAttribute(&quot;width&quot;, &quot;1&quot;);</span>
<span class="nc" id="L652">		filter.setAttribute(&quot;height&quot;, &quot;1&quot;);</span>
<span class="nc" id="L653">		addFilter(filter, &quot;feFlood&quot;, &quot;flood-color&quot;, color, &quot;result&quot;, &quot;flood&quot;);</span>
<span class="nc" id="L654">		addFilter(filter, &quot;feComposite&quot;, &quot;in&quot;, &quot;SourceGraphic&quot;, &quot;in2&quot;, &quot;flood&quot;, &quot;operator&quot;, &quot;over&quot;);</span>
<span class="nc" id="L655">		defs.appendChild(filter);</span>
<span class="nc" id="L656">		return id;</span>
	}

	private Transformer getTransformer() throws TransformerException {
<span class="fc" id="L660">		final Transformer transformer = XmlFactories.newTransformer();</span>
<span class="fc" id="L661">		Log.info(() -&gt; &quot;Transformer=&quot; + transformer.getClass());</span>

		// // Sets the standalone property in the first line of
		// // the output file.
<span class="fc" id="L665">		transformer.setOutputProperty(OutputKeys.STANDALONE, &quot;no&quot;);</span>
<span class="fc" id="L666">		transformer.setOutputProperty(OutputKeys.ENCODING, &quot;us-ascii&quot;);</span>
		// transformer.setOutputProperty(OutputKeys.DOCTYPE_PUBLIC, &quot;SVG 1.1&quot;);
		// transformer.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, &quot;no&quot;);

<span class="fc" id="L670">		return transformer;</span>
	}

	public void createXml(OutputStream os) throws TransformerException, IOException {
<span class="fc" id="L674">		final ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="fc" id="L675">		createXmlInternal(baos);</span>
<span class="fc" id="L676">		String s = new String(baos.toByteArray());</span>
<span class="pc bpc" id="L677" title="1 of 2 branches missed.">		for (Map.Entry&lt;String, String&gt; ent : images.entrySet()) {</span>
<span class="nc" id="L678">			final String k = &quot;&lt;&quot; + ent.getKey() + &quot;/&gt;&quot;;</span>
<span class="nc" id="L679">			s = s.replace(k, ent.getValue());</span>
<span class="nc" id="L680">		}</span>
<span class="fc" id="L681">		s = removeXmlHeader(s);</span>
		// s = s.replace(&quot;&lt;&quot;, &quot;\n&lt;&quot;).replace(&quot;&gt;&quot;, &quot;&gt;\n&quot;);
<span class="fc" id="L683">		os.write(s.getBytes());</span>
<span class="fc" id="L684">	}</span>

	private String removeXmlHeader(String s) {
<span class="fc" id="L687">		s = s.replaceFirst(&quot;^&lt;\\?xml [^&lt;&gt;]+?\\&gt;&quot;, &quot;&quot;);</span>
<span class="fc" id="L688">		return s;</span>
	}

	private void createXmlInternal(OutputStream os) throws TransformerException {
		// Get a DOMSource object that represents the
		// Document object
<span class="fc" id="L694">		final DOMSource source = new DOMSource(document);</span>

<span class="fc" id="L696">		final int maxXscaled = (int) (maxX * option.getScale());</span>
<span class="fc" id="L697">		final int maxYscaled = (int) (maxY * option.getScale());</span>
<span class="fc" id="L698">		String style = &quot;width:&quot; + maxXscaled + &quot;px;height:&quot; + maxYscaled + &quot;px;&quot;;</span>

<span class="pc bpc" id="L700" title="2 of 4 branches missed.">		if (backcolorString != null &amp;&amp; &quot;#00000000&quot;.equals(backcolorString) == false)</span>
<span class="fc" id="L701">			style += &quot;background:&quot; + backcolorString + &quot;;&quot;;</span>

<span class="pc bpc" id="L703" title="1 of 2 branches missed.">		if (option.getSvgDimensionStyle()) {</span>
<span class="fc" id="L704">			root.setAttribute(&quot;style&quot;, style);</span>
<span class="fc" id="L705">			root.setAttribute(&quot;width&quot;, format(maxX) + &quot;px&quot;);</span>
<span class="fc" id="L706">			root.setAttribute(&quot;height&quot;, format(maxY) + &quot;px&quot;);</span>
		}
<span class="fc" id="L708">		root.setAttribute(&quot;viewBox&quot;, &quot;0 0 &quot; + maxXscaled + &quot; &quot; + maxYscaled);</span>
<span class="fc" id="L709">		root.setAttribute(&quot;zoomAndPan&quot;, &quot;magnify&quot;);</span>
<span class="fc" id="L710">		root.setAttribute(&quot;preserveAspectRatio&quot;, option.getPreserveAspectRatio());</span>
		// root.setAttribute(&quot;contentScriptType&quot;, &quot;application/ecmascript&quot;);
<span class="fc" id="L712">		root.setAttribute(&quot;contentStyleType&quot;, &quot;text/css&quot;);</span>

<span class="fc bfc" id="L714" title="All 2 branches covered.">		if (pendingBackground != null) {</span>
<span class="fc" id="L715">			pendingBackground.setAttribute(&quot;width&quot;, format(maxX));</span>
<span class="fc" id="L716">			pendingBackground.setAttribute(&quot;height&quot;, format(maxY));</span>
		}

		// Get a StreamResult object that points to the
		// screen. Then transform the DOM sending XML to
		// the screen.
<span class="fc" id="L722">		final StreamResult scrResult = new StreamResult(os);</span>
<span class="fc" id="L723">		getTransformer().transform(source, scrResult);</span>
<span class="fc" id="L724">	}</span>

	public void svgPath(double x, double y, UPath path, double deltaShadow) {
<span class="nc" id="L727">		manageShadow(deltaShadow);</span>
<span class="nc" id="L728">		ensureVisible(x, y);</span>
<span class="nc" id="L729">		final StringBuilder sb = new StringBuilder(path.size() * 12);</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">		for (USegment seg : path) {</span>
<span class="nc" id="L731">			final USegmentType type = seg.getSegmentType();</span>
<span class="nc" id="L732">			final double coord[] = seg.getCoord();</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">			if (type == USegmentType.SEG_MOVETO) {</span>
<span class="nc" id="L734">				sb.append(&quot;M&quot; + format(coord[0] + x) + &quot;,&quot; + format(coord[1] + y) + &quot; &quot;);</span>
<span class="nc" id="L735">				ensureVisible(coord[0] + x + 2 * deltaShadow, coord[1] + y + 2 * deltaShadow);</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">			} else if (type == USegmentType.SEG_LINETO) {</span>
<span class="nc" id="L737">				sb.append(&quot;L&quot; + format(coord[0] + x) + &quot;,&quot; + format(coord[1] + y) + &quot; &quot;);</span>
<span class="nc" id="L738">				ensureVisible(coord[0] + x + 2 * deltaShadow, coord[1] + y + 2 * deltaShadow);</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">			} else if (type == USegmentType.SEG_QUADTO) {</span>
<span class="nc" id="L740">				sb.append(&quot;Q&quot; + format(coord[0] + x) + &quot;,&quot; + format(coord[1] + y) + &quot; &quot; + format(coord[2] + x) + &quot;,&quot;</span>
<span class="nc" id="L741">						+ format(coord[3] + y) + &quot; &quot;);</span>
<span class="nc" id="L742">				ensureVisible(coord[0] + x + 2 * deltaShadow, coord[1] + y + 2 * deltaShadow);</span>
<span class="nc" id="L743">				ensureVisible(coord[2] + x + 2 * deltaShadow, coord[3] + y + 2 * deltaShadow);</span>
<span class="nc bnc" id="L744" title="All 2 branches missed.">			} else if (type == USegmentType.SEG_CUBICTO) {</span>
<span class="nc" id="L745">				sb.append(&quot;C&quot; + format(coord[0] + x) + &quot;,&quot; + format(coord[1] + y) + &quot; &quot; + format(coord[2] + x) + &quot;,&quot;</span>
<span class="nc" id="L746">						+ format(coord[3] + y) + &quot; &quot; + format(coord[4] + x) + &quot;,&quot; + format(coord[5] + y) + &quot; &quot;);</span>
<span class="nc" id="L747">				ensureVisible(coord[0] + x + 2 * deltaShadow, coord[1] + y + 2 * deltaShadow);</span>
<span class="nc" id="L748">				ensureVisible(coord[2] + x + 2 * deltaShadow, coord[3] + y + 2 * deltaShadow);</span>
<span class="nc" id="L749">				ensureVisible(coord[4] + x + 2 * deltaShadow, coord[5] + y + 2 * deltaShadow);</span>
<span class="nc bnc" id="L750" title="All 2 branches missed.">			} else if (type == USegmentType.SEG_ARCTO) {</span>
				// A25,25 0,0 5,395,40
<span class="nc" id="L752">				sb.append(&quot;A&quot; + format(coord[0]) + &quot;,&quot; + format(coord[1]) + &quot; &quot; + format(coord[2]) + &quot; &quot;</span>
<span class="nc" id="L753">						+ formatBoolean(coord[3]) + &quot; &quot; + formatBoolean(coord[4]) + &quot; &quot; + format(coord[5] + x) + &quot;,&quot;</span>
<span class="nc" id="L754">						+ format(coord[6] + y) + &quot; &quot;);</span>
<span class="nc" id="L755">				ensureVisible(coord[5] + coord[0] + x + 2 * deltaShadow, coord[6] + coord[1] + y + 2 * deltaShadow);</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">			} else if (type == USegmentType.SEG_CLOSE) {</span>
				// Nothing
			} else {
<span class="nc" id="L759">				Log.println(&quot;unknown3 &quot; + seg);</span>
			}

<span class="nc" id="L762">		}</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">		if (hidden == false) {</span>
<span class="nc" id="L764">			final Element elt = document.createElement(&quot;path&quot;);</span>
<span class="nc" id="L765">			elt.setAttribute(&quot;d&quot;, sb.toString().trim());</span>
<span class="nc" id="L766">			styleMe(elt);</span>
<span class="nc" id="L767">			fillMe(elt);</span>
<span class="nc" id="L768">			final String id = path.getComment();</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">			if (id != null)</span>
<span class="nc" id="L770">				elt.setAttribute(&quot;id&quot;, id);</span>

<span class="nc" id="L772">			final String codeLine = path.getCodeLine();</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">			if (codeLine != null)</span>
<span class="nc" id="L774">				elt.setAttribute(&quot;codeLine&quot;, codeLine);</span>

<span class="nc" id="L776">			addFilterShadowId(elt, deltaShadow);</span>
<span class="nc" id="L777">			getG().appendChild(elt);</span>
		}
<span class="nc" id="L779">	}</span>

	private void fillMe(Element elt) {
<span class="fc bfc" id="L782" title="All 2 branches covered.">		if (fill.matches(&quot;#[0-9A-Fa-f]{8}&quot;)) {</span>
<span class="fc" id="L783">			elt.setAttribute(&quot;fill&quot;, fill.substring(0, 7));</span>
<span class="fc" id="L784">			final double opacity = Integer.parseInt(fill.substring(7), 16) / 255.0;</span>
<span class="fc" id="L785">			elt.setAttribute(&quot;fill-opacity&quot;, String.format(Locale.US, &quot;%1.5f&quot;, opacity));</span>
<span class="fc" id="L786">		} else {</span>
<span class="fc" id="L787">			elt.setAttribute(&quot;fill&quot;, fill);</span>
		}
<span class="fc" id="L789">	}</span>

	private void addFilterShadowId(final Element elt, double deltaShadow) {
<span class="pc bpc" id="L792" title="1 of 2 branches missed.">		if (deltaShadow &gt; 0)</span>
<span class="nc" id="L793">			elt.setAttribute(&quot;filter&quot;, &quot;url(#&quot; + shadowId + &quot;)&quot;);</span>

<span class="fc" id="L795">	}</span>

<span class="fc" id="L797">	private StringBuilder currentPath = null;</span>

	public void newpath() {
<span class="nc" id="L800">		currentPath = new StringBuilder();</span>

<span class="nc" id="L802">	}</span>

	public void moveto(double x, double y) {
<span class="nc" id="L805">		currentPath.append(&quot;M&quot; + format(x) + &quot;,&quot; + format(y) + &quot; &quot;);</span>
<span class="nc" id="L806">		ensureVisible(x, y);</span>
<span class="nc" id="L807">	}</span>

	public void lineto(double x, double y) {
<span class="nc" id="L810">		currentPath.append(&quot;L&quot; + format(x) + &quot;,&quot; + format(y) + &quot; &quot;);</span>
<span class="nc" id="L811">		ensureVisible(x, y);</span>
<span class="nc" id="L812">	}</span>

	public void closepath() {
<span class="nc" id="L815">		currentPath.append(&quot;Z &quot;);</span>

<span class="nc" id="L817">	}</span>

	public void curveto(double x1, double y1, double x2, double y2, double x3, double y3) {
<span class="nc" id="L820">		currentPath.append(&quot;C&quot; + format(x1) + &quot;,&quot; + format(y1) + &quot; &quot; + format(x2) + &quot;,&quot; + format(y2) + &quot; &quot; + format(x3)</span>
<span class="nc" id="L821">				+ &quot;,&quot; + format(y3) + &quot; &quot;);</span>
<span class="nc" id="L822">		ensureVisible(x1, y1);</span>
<span class="nc" id="L823">		ensureVisible(x2, y2);</span>
<span class="nc" id="L824">		ensureVisible(x3, y3);</span>

<span class="nc" id="L826">	}</span>

	public void quadto(double x1, double y1, double x2, double y2) {
<span class="nc" id="L829">		currentPath.append(&quot;Q&quot; + format(x1) + &quot;,&quot; + format(y1) + &quot; &quot; + format(x2) + &quot;,&quot; + format(y2) + &quot; &quot;);</span>
<span class="nc" id="L830">		ensureVisible(x1, y1);</span>
<span class="nc" id="L831">		ensureVisible(x2, y2);</span>
<span class="nc" id="L832">	}</span>

	private String format(double xx) {
<span class="fc" id="L835">		final double x = xx * option.getScale();</span>
<span class="fc bfc" id="L836" title="All 2 branches covered.">		if (x == 0.0)</span>
<span class="fc" id="L837">			return &quot;0&quot;;</span>

<span class="fc" id="L839">		String s = String.format(Locale.US, &quot;%.4f&quot;, x);</span>

<span class="fc" id="L841">		final int dot = s.indexOf('.');</span>
<span class="pc bpc" id="L842" title="1 of 2 branches missed.">		if (dot &gt;= 0) {</span>
<span class="fc" id="L843">			int end = s.length() - 1;</span>
<span class="fc bfc" id="L844" title="All 4 branches covered.">			while (end &gt; dot &amp;&amp; s.charAt(end) == '0')</span>
<span class="fc" id="L845">				end--;</span>

<span class="fc bfc" id="L847" title="All 2 branches covered.">			if (end == dot)</span>
<span class="fc" id="L848">				end--;</span>

<span class="fc" id="L850">			s = s.substring(0, end + 1);</span>
		}
<span class="fc" id="L852">		return s;</span>
	}

	private String formatBoolean(double x) {
<span class="nc bnc" id="L856" title="All 2 branches missed.">		return x == 0 ? &quot;0&quot; : &quot;1&quot;;</span>
	}

	public void fill(int windingRule) {
<span class="nc bnc" id="L860" title="All 2 branches missed.">		if (hidden == false) {</span>
<span class="nc" id="L861">			final Element elt = document.createElement(&quot;path&quot;);</span>
<span class="nc" id="L862">			elt.setAttribute(&quot;d&quot;, currentPath.toString());</span>
<span class="nc" id="L863">			fillMe(elt);</span>
<span class="nc" id="L864">			getG().appendChild(elt);</span>
		}
<span class="nc" id="L866">		currentPath = null;</span>

<span class="nc" id="L868">	}</span>

	public void drawPathIterator(double x, double y, PathIterator path) {

<span class="nc" id="L872">		this.newpath();</span>
<span class="nc" id="L873">		final double coord[] = new double[6];</span>
<span class="nc bnc" id="L874" title="All 2 branches missed.">		while (path.isDone() == false) {</span>
<span class="nc" id="L875">			final int code = path.currentSegment(coord);</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">			if (code == PathIterator.SEG_MOVETO)</span>
<span class="nc" id="L877">				this.moveto(coord[0] + x, coord[1] + y);</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">			else if (code == PathIterator.SEG_LINETO)</span>
<span class="nc" id="L879">				this.lineto(coord[0] + x, coord[1] + y);</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">			else if (code == PathIterator.SEG_CLOSE)</span>
<span class="nc" id="L881">				this.closepath();</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">			else if (code == PathIterator.SEG_CUBICTO)</span>
<span class="nc" id="L883">				this.curveto(coord[0] + x, coord[1] + y, coord[2] + x, coord[3] + y, coord[4] + x, coord[5] + y);</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">			else if (code == PathIterator.SEG_QUADTO)</span>
<span class="nc" id="L885">				this.quadto(coord[0] + x, coord[1] + y, coord[2] + x, coord[3] + y);</span>
			else
<span class="nc" id="L887">				throw new UnsupportedOperationException(&quot;code=&quot; + code);</span>

<span class="nc" id="L889">			path.next();</span>
<span class="nc" id="L890">		}</span>

<span class="nc" id="L892">		this.fill(path.getWindingRule());</span>

<span class="nc" id="L894">	}</span>

	public void svgImage(BufferedImage image, double x, double y) throws IOException {
<span class="pc bpc" id="L897" title="1 of 2 branches missed.">		if (hidden == false) {</span>
<span class="fc" id="L898">			final Element elt = document.createElement(&quot;image&quot;);</span>
<span class="fc" id="L899">			elt.setAttribute(&quot;width&quot;, format(image.getWidth()));</span>
<span class="fc" id="L900">			elt.setAttribute(&quot;height&quot;, format(image.getHeight()));</span>
<span class="fc" id="L901">			elt.setAttribute(&quot;x&quot;, format(x));</span>
<span class="fc" id="L902">			elt.setAttribute(&quot;y&quot;, format(y));</span>
<span class="fc" id="L903">			final String s = toBase64(image);</span>
<span class="fc" id="L904">			elt.setAttribute(&quot;xlink:href&quot;, &quot;data:image/png;base64,&quot; + s);</span>
<span class="fc" id="L905">			getG().appendChild(elt);</span>
		}
<span class="fc" id="L907">		ensureVisible(x, y);</span>
<span class="fc" id="L908">		ensureVisible(x + image.getWidth(), y + image.getHeight());</span>
<span class="fc" id="L909">	}</span>

<span class="fc" id="L911">	private final Map&lt;String, String&gt; images = new HashMap&lt;String, String&gt;();</span>

	private void svgImageUnsecure(UImageSvg image, double x, double y) {
<span class="nc bnc" id="L914" title="All 2 branches missed.">		if (hidden == false) {</span>
<span class="nc" id="L915">			String svg = manageScale(image);</span>
<span class="nc" id="L916">			final String pos = &quot;&lt;svg x=\&quot;&quot; + format(x) + &quot;\&quot; y=\&quot;&quot; + format(y) + &quot;\&quot;&gt;&quot;;</span>
<span class="nc" id="L917">			svg = pos + svg.substring(5);</span>
<span class="nc" id="L918">			final String key = &quot;imagesvginlined&quot; + image.getMD5Hex() + images.size();</span>
<span class="nc" id="L919">			final Element elt = document.createElement(key);</span>
<span class="nc" id="L920">			getG().appendChild(elt);</span>
<span class="nc" id="L921">			images.put(key, svg);</span>
		}
<span class="nc" id="L923">		ensureVisible(x, y);</span>
<span class="nc" id="L924">		ensureVisible(x + image.getData(&quot;width&quot;), y + image.getData(&quot;height&quot;));</span>
<span class="nc" id="L925">	}</span>

	public void svgImage(UImageSvg image, double x, double y) {
<span class="nc bnc" id="L928" title="All 2 branches missed.">		if (SecurityUtils.getSecurityProfile() == SecurityProfile.UNSECURE) {</span>
<span class="nc" id="L929">			svgImageUnsecure(image, x, y);</span>
<span class="nc" id="L930">			return;</span>
		}

		// https://developer.mozilla.org/fr/docs/Web/SVG/Element/image
<span class="nc bnc" id="L934" title="All 2 branches missed.">		if (hidden == false) {</span>
<span class="nc" id="L935">			final Element elt = document.createElement(&quot;image&quot;);</span>
<span class="nc" id="L936">			elt.setAttribute(&quot;width&quot;, format(image.getWidth()));</span>
<span class="nc" id="L937">			elt.setAttribute(&quot;height&quot;, format(image.getHeight()));</span>
<span class="nc" id="L938">			elt.setAttribute(&quot;x&quot;, format(x));</span>
<span class="nc" id="L939">			elt.setAttribute(&quot;y&quot;, format(y));</span>

<span class="nc" id="L941">			String svg = manageScale(image);</span>

			final String svgHeader;
<span class="nc bnc" id="L944" title="All 2 branches missed.">			if (image.containsXlink())</span>
<span class="nc" id="L945">				svgHeader = &quot;&lt;svg height=\&quot;&quot; + (int) (image.getHeight() * option.getScale()) + &quot;\&quot; width=\&quot;&quot;</span>
<span class="nc" id="L946">						+ (int) (image.getWidth() * option.getScale())</span>
						+ &quot;\&quot; xmlns:xlink=\&quot;http://www.w3.org/1999/xlink\&quot; xmlns=\&quot;http://www.w3.org/2000/svg\&quot; &gt;&quot;;
			else
<span class="nc" id="L949">				svgHeader = &quot;&lt;svg height=\&quot;&quot; + (int) (image.getHeight() * option.getScale()) + &quot;\&quot; width=\&quot;&quot;</span>
<span class="nc" id="L950">						+ (int) (image.getWidth() * option.getScale()) + &quot;\&quot; xmlns=\&quot;http://www.w3.org/2000/svg\&quot; &gt;&quot;;</span>

<span class="nc" id="L952">			svg = svgHeader + svg.substring(5);</span>

<span class="nc" id="L954">			final String s = toBase64(svg);</span>
<span class="nc" id="L955">			elt.setAttribute(&quot;xlink:href&quot;, &quot;data:image/svg+xml;base64,&quot; + s);</span>

<span class="nc" id="L957">			getG().appendChild(elt);</span>
		}
<span class="nc" id="L959">		ensureVisible(x, y);</span>
<span class="nc" id="L960">		ensureVisible(x + image.getData(&quot;width&quot;), y + image.getData(&quot;height&quot;));</span>
<span class="nc" id="L961">	}</span>

	private String manageScale(UImageSvg svgImage) {
<span class="nc" id="L964">		final double svgScale = svgImage.getScale();</span>
<span class="nc" id="L965">		String svg = svgImage.getSvg(false);</span>
<span class="nc bnc" id="L966" title="All 2 branches missed.">		if (svgScale * option.getScale() == 1)</span>
<span class="nc" id="L967">			return svg;</span>

<span class="nc" id="L969">		final String svg2 = svg.replace('\n', ' ').replace('\r', ' ');</span>
<span class="nc bnc" id="L970" title="All 4 branches missed.">		if (svg2.contains(&quot;&lt;g &quot;) == false &amp;&amp; svg2.contains(&quot;&lt;g&gt;&quot;) == false) {</span>
<span class="nc" id="L971">			svg = svg.replaceFirst(&quot;\\&lt;svg\\&gt;&quot;, &quot;&lt;svg&gt;&lt;g&gt;&quot;);</span>
<span class="nc" id="L972">			svg = svg.replaceFirst(&quot;\\&lt;/svg\\&gt;&quot;, &quot;&lt;/g&gt;&lt;/svg&gt;&quot;);</span>
		}
<span class="nc" id="L974">		final String factor = format(svgScale);</span>
<span class="nc" id="L975">		final String s1 = &quot;\\&lt;g\\b&quot;;</span>
<span class="nc" id="L976">		final String s2 = &quot;&lt;g transform=\&quot;scale(&quot; + factor + &quot;,&quot; + factor + &quot;)\&quot; &quot;;</span>
<span class="nc" id="L977">		svg = svg.replaceFirst(s1, s2);</span>
<span class="nc" id="L978">		return svg;</span>
	}

	private String toBase64(BufferedImage image) throws IOException {
<span class="fc" id="L982">		final ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="fc" id="L983">		SImageIO.write(image, &quot;png&quot;, baos);</span>
<span class="fc" id="L984">		final byte data[] = baos.toByteArray();</span>
<span class="fc" id="L985">		return new String(Base64Coder.encode(data));</span>
	}

	private String toBase64(String s) {
<span class="nc" id="L989">		final byte data[] = s.getBytes(Charset.forName(&quot;UTF8&quot;));</span>
<span class="nc" id="L990">		return new String(Base64Coder.encode(data));</span>
	}

	// Shadow

<span class="fc" id="L995">	private boolean withShadow = false;</span>

	private void manageShadow(double deltaShadow) {
<span class="pc bpc" id="L998" title="1 of 2 branches missed.">		if (deltaShadow != 0) {</span>
<span class="nc bnc" id="L999" title="All 2 branches missed.">			if (withShadow == false) {</span>
				// &lt;filter id=&quot;f1&quot; x=&quot;0&quot; y=&quot;0&quot; width=&quot;120%&quot; height=&quot;120%&quot;&gt;
<span class="nc" id="L1001">				final Element filter = document.createElement(&quot;filter&quot;);</span>
<span class="nc" id="L1002">				filter.setAttribute(&quot;id&quot;, shadowId);</span>
<span class="nc" id="L1003">				filter.setAttribute(&quot;x&quot;, &quot;-1&quot;);</span>
<span class="nc" id="L1004">				filter.setAttribute(&quot;y&quot;, &quot;-1&quot;);</span>
<span class="nc" id="L1005">				filter.setAttribute(&quot;width&quot;, &quot;300%&quot;);</span>
<span class="nc" id="L1006">				filter.setAttribute(&quot;height&quot;, &quot;300%&quot;);</span>
<span class="nc" id="L1007">				addFilter(filter, &quot;feGaussianBlur&quot;, &quot;result&quot;, &quot;blurOut&quot;, &quot;stdDeviation&quot;, format(2));</span>
<span class="nc" id="L1008">				addFilter(filter, &quot;feColorMatrix&quot;, &quot;type&quot;, &quot;matrix&quot;, &quot;in&quot;, &quot;blurOut&quot;, &quot;result&quot;, &quot;blurOut2&quot;, &quot;values&quot;,</span>
						&quot;0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0&quot;);
<span class="nc" id="L1010">				addFilter(filter, &quot;feOffset&quot;, &quot;result&quot;, &quot;blurOut3&quot;, &quot;in&quot;, &quot;blurOut2&quot;, &quot;dx&quot;, format(4), &quot;dy&quot;, format(4));</span>
<span class="nc" id="L1011">				addFilter(filter, &quot;feBlend&quot;, &quot;in&quot;, &quot;SourceGraphic&quot;, &quot;in2&quot;, &quot;blurOut3&quot;, &quot;mode&quot;, &quot;normal&quot;);</span>
<span class="nc" id="L1012">				defs.appendChild(filter);</span>

			}
<span class="nc" id="L1015">			withShadow = true;</span>
		}
<span class="fc" id="L1017">	}</span>

	private void addFilter(Element filter, String name, String... data) {
<span class="nc bnc" id="L1020" title="All 2 branches missed.">		assert data.length % 2 == 0;</span>
<span class="nc" id="L1021">		final Element elt = document.createElement(name);</span>
<span class="nc bnc" id="L1022" title="All 2 branches missed.">		for (int i = 0; i &lt; data.length; i += 2)</span>
<span class="nc" id="L1023">			elt.setAttribute(data[i], data[i + 1]);</span>

<span class="nc" id="L1025">		filter.appendChild(elt);</span>
<span class="nc" id="L1026">	}</span>

	private boolean hidden;

	public void setHidden(boolean hidden) {
<span class="fc" id="L1031">		this.hidden = hidden;</span>
<span class="fc" id="L1032">	}</span>

	// ::comment when __CORE__
	public static final String META_HEADER = &quot;&lt;!--SRC=[&quot;;

	public static String getMetadataHex(String comment) {
		try {
<span class="fc" id="L1039">			final String encoded = TranscoderUtil.getDefaultTranscoderProtected().encode(comment);</span>
<span class="fc" id="L1040">			return encoded;</span>
<span class="nc" id="L1041">		} catch (IOException e) {</span>
<span class="nc" id="L1042">			return &quot;ERROR42&quot;;</span>
		}
	}
	// ::done

	public void addCommentMetadata(String metadata) {
		// ::comment when __CORE__
<span class="fc" id="L1049">		final String signature = getMetadataHex(metadata).replace(&quot;--&quot;, &quot;- -&quot;);</span>
<span class="fc" id="L1050">		final String comment = &quot;SRC=[&quot; + signature + &quot;]&quot;;</span>
<span class="fc" id="L1051">		final Comment commentElement = document.createComment(comment);</span>
<span class="fc" id="L1052">		getG().appendChild(commentElement);</span>
		// ::done
<span class="fc" id="L1054">	}</span>

	public void addComment(String comment) {
<span class="nc" id="L1057">		final Comment commentElement = document.createComment(comment);</span>
<span class="nc" id="L1058">		getG().appendChild(commentElement);</span>
<span class="nc" id="L1059">	}</span>

	private static class LinkData {
		private final String url;
		private final String title;
		private final String target;

<span class="nc" id="L1066">		public LinkData(String url, String title, String target) {</span>
			// javascript: security issue
<span class="nc bnc" id="L1068" title="All 2 branches missed.">			if (SecurityUtils.ignoreThisLink(Objects.requireNonNull(url)))</span>
<span class="nc" id="L1069">				this.url = &quot;&quot;;</span>
			else
<span class="nc" id="L1071">				this.url = url;</span>
<span class="nc" id="L1072">			this.title = title;</span>
<span class="nc" id="L1073">			this.target = target;</span>
<span class="nc" id="L1074">		}</span>

<span class="nc" id="L1076">		private static final Pattern p = Pattern.compile(&quot;\\&lt;U\\+([0-9A-Fa-f]+)\\&gt;&quot;);</span>

		String getXlinkTitle() {
<span class="nc bnc" id="L1079" title="All 2 branches missed.">			if (title == null)</span>
<span class="nc" id="L1080">				return url;</span>

<span class="nc" id="L1082">			final Matcher m = p.matcher(title);</span>
<span class="nc" id="L1083">			final StringBuffer sb = new StringBuffer(); // Can't be switched to StringBuilder in order to support Java 8</span>
<span class="nc bnc" id="L1084" title="All 2 branches missed.">			while (m.find()) {</span>
<span class="nc" id="L1085">				final String num = m.group(1);</span>
<span class="nc" id="L1086">				final char c = (char) Integer.parseInt(num, 16);</span>
<span class="nc" id="L1087">				m.appendReplacement(sb, &quot;&quot; + c);</span>
<span class="nc" id="L1088">			}</span>
<span class="nc" id="L1089">			m.appendTail(sb);</span>

<span class="nc" id="L1091">			return sb.toString().replaceAll(&quot;\\\\n&quot;, &quot;\n&quot;);</span>
		}

		public void updateAttributesOf(Element element) {
<span class="nc" id="L1095">			element.setAttribute(&quot;target&quot;, target);</span>
<span class="nc" id="L1096">			element.setAttribute(XLINK_HREF1, url);</span>
<span class="nc" id="L1097">			element.setAttribute(XLINK_HREF2, url);</span>
<span class="nc" id="L1098">			element.setAttribute(&quot;xlink:type&quot;, &quot;simple&quot;);</span>
<span class="nc" id="L1099">			element.setAttribute(&quot;xlink:actuate&quot;, &quot;onRequest&quot;);</span>
<span class="nc" id="L1100">			element.setAttribute(&quot;xlink:show&quot;, &quot;new&quot;);</span>
<span class="nc" id="L1101">			final String title = getXlinkTitle();</span>
<span class="nc" id="L1102">			element.setAttribute(XLINK_TITLE1, title);</span>
<span class="nc" id="L1103">			element.setAttribute(XLINK_TITLE2, title);</span>

<span class="nc" id="L1105">		}</span>
	}

<span class="fc" id="L1108">	private final List&lt;Element&gt; pendingElements = new ArrayList&lt;&gt;();</span>

	/*
	 * Note: SVG does not support nested links (&lt;a&gt; within &lt;a&gt;). Thus, we manage
	 * link openings carefully to ensure only the topmost link remains active at any
	 * given time.
	 */
<span class="fc" id="L1115">	private final List&lt;LinkData&gt; activeLinks = new ArrayList&lt;&gt;();</span>

	/**
	 * Moves the first pending element (typically a link or group) to the document's
	 * SVG group.
	 */
	private void closeTopPendingElement() {
<span class="fc" id="L1122">		final Element element = pendingElements.get(0);</span>
<span class="fc" id="L1123">		pendingElements.remove(0);</span>
<span class="fc bfc" id="L1124" title="All 2 branches covered.">		if (element.getFirstChild() != null)</span>
<span class="fc" id="L1125">			getG().appendChild(element);</span>
<span class="fc" id="L1126">	}</span>

	/**
	 * Closes the most recently opened link if necessary.
	 *
	 * Validates state to ensure no nested or invalid link closures occur.
	 */
	private void closeTopActiveLinkIfNeeded() {
<span class="pc bpc" id="L1134" title="1 of 2 branches missed.">		if (activeLinks.size() &gt; 0) {</span>
<span class="nc bnc" id="L1135" title="All 2 branches missed.">			if (pendingElements.get(0).getTagName().equals(&quot;a&quot;) == false)</span>
<span class="nc" id="L1136">				throw new IllegalStateException(&quot;Expected top pending element to be a link.&quot;);</span>
			// Move active link element to document since it's being closed
<span class="nc" id="L1138">			closeTopPendingElement();</span>
		}

		// Check for invalid state: no links should remain pending
<span class="fc bfc" id="L1142" title="All 2 branches covered.">		for (Element elt : pendingElements)</span>
<span class="pc bpc" id="L1143" title="1 of 2 branches missed.">			if (elt.getTagName().equals(&quot;a&quot;))</span>
<span class="nc" id="L1144">				throw new IllegalStateException();</span>

<span class="fc" id="L1146">	}</span>

	private void addTopOpenedLinkIfNeeded() {
<span class="pc bpc" id="L1149" title="1 of 2 branches missed.">		if (activeLinks.size() &gt; 0) {</span>
<span class="nc" id="L1150">			final LinkData link = activeLinks.get(0);</span>
<span class="nc" id="L1151">			pendingElements.add(0, document.createElement(&quot;a&quot;));</span>
<span class="nc" id="L1152">			link.updateAttributesOf(pendingElements.get(0));</span>
		}
<span class="fc" id="L1154">	}</span>

	/**
	 * Opens a new link and adds it to the list of active links.
	 */
	public void openLink(String url, String title, String target) {
		// References for related issue fixes:
		// https://github.com/plantuml/plantuml/issues/1951
		// https://github.com/plantuml/plantuml/issues/2069
		// https://github.com/plantuml/plantuml/issues/2148

		// Ensure previous active link is closed before opening a new one
<span class="nc" id="L1166">		closeTopActiveLinkIfNeeded();</span>
<span class="nc" id="L1167">		activeLinks.add(0, new LinkData(url, title, target));</span>

		// Create a new pending link element based on provided details
<span class="nc" id="L1170">		addTopOpenedLinkIfNeeded();</span>
<span class="nc" id="L1171">	}</span>

	/**
	 * Closes the currently active link and updates the pending elements
	 * accordingly.
	 */
	public void closeLink() {
<span class="nc bnc" id="L1178" title="All 4 branches missed.">		if (pendingElements.size() == 0 || activeLinks.size() == 0</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">				|| pendingElements.get(0).getTagName().equals(&quot;a&quot;) == false)</span>
<span class="nc" id="L1180">			throw new IllegalStateException(&quot;Attempting to close a link in an invalid state.&quot;);</span>

		// Close active link properly
<span class="nc" id="L1183">		closeTopActiveLinkIfNeeded();</span>
<span class="nc" id="L1184">		activeLinks.remove(0);</span>

		// Re-create pending link element if necessary
<span class="nc" id="L1187">		addTopOpenedLinkIfNeeded();</span>

<span class="nc" id="L1189">	}</span>

	/**
	 * Closes the current SVG group element.
	 */
	public void closeGroup() {
<span class="pc bpc" id="L1195" title="1 of 2 branches missed.">		if (pendingElements.size() == 0)</span>
<span class="nc" id="L1196">			throw new IllegalStateException();</span>

		// Ensure any active links are closed first
<span class="fc" id="L1199">		closeTopActiveLinkIfNeeded();</span>

<span class="fc" id="L1201">		closeTopPendingElement();</span>

		// Restore link state after closing group if needed
<span class="fc" id="L1204">		addTopOpenedLinkIfNeeded();</span>
<span class="fc" id="L1205">	}</span>

	public void startGroup(Map&lt;UGroupType, String&gt; typeIdents) {
<span class="pc bpc" id="L1208" title="1 of 2 branches missed.">		if (typeIdents.isEmpty())</span>
<span class="nc" id="L1209">			throw new IllegalArgumentException();</span>

		// Close any active link before starting a new group
<span class="fc" id="L1212">		closeTopActiveLinkIfNeeded();</span>

<span class="fc" id="L1214">		pendingElements.add(0, document.createElement(&quot;g&quot;));</span>

		// Sorry for the code duplication: but this Pragma will be removed
		// So we will simplify and refactor the code at that time.
<span class="pc bpc" id="L1218" title="1 of 2 branches missed.">		if (option.pragma.isTrue(PragmaKey.SVGNEWDATA)) {</span>

<span class="nc bnc" id="L1220" title="All 2 branches missed.">			for (Map.Entry&lt;UGroupType, String&gt; typeIdent : typeIdents.entrySet()) {</span>
<span class="nc bnc" id="L1221" title="All 2 branches missed.">				if (typeIdent.getKey() == UGroupType.TITLE) {</span>
<span class="nc" id="L1222">					Element title = document.createElement(UGroupType.TITLE.getSvgKeyAttributeName());</span>
<span class="nc" id="L1223">					title.setTextContent(typeIdent.getValue());</span>
<span class="nc" id="L1224">					pendingElements.get(0).appendChild(title);</span>
				}

<span class="nc bnc" id="L1227" title="All 6 branches missed.">				switch (typeIdent.getKey()) {</span>
				case ID:
					// ignored
<span class="nc" id="L1230">					break;</span>
				case DATA_UID:
					// DATA_UID *will* be rename to ID, but right now, we do some hack
<span class="nc" id="L1233">					pendingElements.get(0).setAttribute(&quot;id&quot;, typeIdent.getValue());</span>
<span class="nc" id="L1234">					break;</span>

				// I also suggest that we rename &quot;data-participant-1&quot; to &quot;data-entity-1&quot; and
				// &quot;data-participant-2&quot; to &quot;data-entity-2&quot;

				case DATA_PARTICIPANT_1:
				case DATA_ENTITY_1_UID:
<span class="nc" id="L1241">					pendingElements.get(0).setAttribute(&quot;data-entity-1&quot;, typeIdent.getValue());</span>
<span class="nc" id="L1242">					break;</span>
				case DATA_PARTICIPANT_2:
				case DATA_ENTITY_2_UID:
<span class="nc" id="L1245">					pendingElements.get(0).setAttribute(&quot;data-entity-2&quot;, typeIdent.getValue());</span>
<span class="nc" id="L1246">					break;</span>

				case CLASS:
				case DATA_SOURCE_LINE:
				case DATA_QUALIFIED_NAME:
				case DATA_ENTITY_UID:
<span class="nc" id="L1252">					pendingElements.get(0).setAttribute(typeIdent.getKey().getSvgKeyAttributeName(),</span>
<span class="nc" id="L1253">							typeIdent.getValue());</span>

				}
<span class="nc" id="L1256">			}</span>
		} else {
<span class="fc bfc" id="L1258" title="All 2 branches covered.">			for (Map.Entry&lt;UGroupType, String&gt; typeIdent : typeIdents.entrySet()) {</span>
<span class="fc bfc" id="L1259" title="All 2 branches covered.">				if (typeIdent.getKey() == UGroupType.TITLE) {</span>
<span class="fc" id="L1260">					Element title = document.createElement(UGroupType.TITLE.getSvgKeyAttributeName());</span>
<span class="fc" id="L1261">					title.setTextContent(typeIdent.getValue());</span>
<span class="fc" id="L1262">					pendingElements.get(0).appendChild(title);</span>
				}

<span class="pc bpc" id="L1265" title="1 of 2 branches missed.">				switch (typeIdent.getKey()) {</span>
				case DATA_UID:
				case ID:
				case DATA_SOURCE_LINE:
<span class="nc" id="L1269">					pendingElements.get(0).setAttribute(typeIdent.getKey().getSvgKeyAttributeName(),</span>
<span class="nc" id="L1270">							typeIdent.getValue());</span>
				}

				// if (option.isInteractive())
<span class="fc bfc" id="L1274" title="All 2 branches covered.">				switch (typeIdent.getKey()) {</span>
				case CLASS:
				case DATA_ENTITY:
				case DATA_ENTITY_1:
				case DATA_ENTITY_2:
				case DATA_PARTICIPANT:
				case DATA_PARTICIPANT_1:
				case DATA_PARTICIPANT_2:
<span class="fc" id="L1282">					pendingElements.get(0).setAttribute(typeIdent.getKey().getSvgKeyAttributeName(),</span>
<span class="fc" id="L1283">							typeIdent.getValue());</span>
				}
<span class="fc" id="L1285">			}</span>

		}

		// Restore link state after group creation if needed
<span class="fc" id="L1290">		addTopOpenedLinkIfNeeded();</span>

<span class="fc" id="L1292">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>