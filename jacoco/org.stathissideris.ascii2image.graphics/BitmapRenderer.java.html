<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BitmapRenderer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">plantuml</a> &gt; <a href="index.source.html" class="el_package">org.stathissideris.ascii2image.graphics</a> &gt; <span class="el_source">BitmapRenderer.java</span></div><h1>BitmapRenderer.java</h1><pre class="source lang-java linenums">/**
 * ditaa - Diagrams Through Ascii Art
 * 
 * Copyright (C) 2004-2011 Efstathios Sideris
 *
 * ditaa is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as 
 * published by the Free Software Foundation, either version 3 of
 * the License, or (at your option) any later version.
 *
 * ditaa is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with ditaa.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 *   
 */
package org.stathissideris.ascii2image.graphics;

import java.awt.BasicStroke;
import java.awt.Canvas;
import java.awt.Color;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.Image;
import java.awt.Rectangle;
import java.awt.RenderingHints;
import java.awt.Stroke;
import java.awt.geom.AffineTransform;
import java.awt.geom.GeneralPath;
import java.awt.image.BufferedImage;
import java.awt.image.ConvolveOp;
import java.awt.image.Kernel;
import java.awt.image.RenderedImage;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;

import org.stathissideris.ascii2image.core.RenderingOptions;
import org.stathissideris.ascii2image.core.Shape3DOrderingComparator;
import org.stathissideris.ascii2image.core.ShapeAreaComparator;

/**
 * 
 * @author Efstathios Sideris
 */
<span class="nc" id="L49">public class BitmapRenderer {</span>
	// ::remove folder when __CORE__

	private static final boolean DEBUG = false;
	private static final boolean DEBUG_LINES = false;

	private static final String IDREGEX = &quot;^.+_vfill$&quot;;
	
	Stroke normalStroke;
	Stroke dashStroke; 
	
//	private boolean renderToPNG(Diagram diagram, String filename, RenderingOptions options){	
//		RenderedImage image = renderToImage(diagram, options);
//		
//		try {
//			File file = new File(filename);
//			ImageIO.write(image, &quot;png&quot;, file);
//		} catch (IOException e) {
//			//e.printStackTrace();
//			System.err.println(&quot;Error: Cannot write to file &quot;+filename);
//			return false;
//		}
//		return true;
//	}
	
	public RenderedImage renderToImage(Diagram diagram, RenderingOptions options){
		BufferedImage image;
<span class="nc bnc" id="L76" title="All 2 branches missed.">		if(options.needsTransparency()) {</span>
<span class="nc" id="L77">			image = new BufferedImage(</span>
<span class="nc" id="L78">					diagram.getWidth(),</span>
<span class="nc" id="L79">					diagram.getHeight(),</span>
					BufferedImage.TYPE_INT_ARGB);
		} else {
<span class="nc" id="L82">			image = new BufferedImage(</span>
<span class="nc" id="L83">					diagram.getWidth(),</span>
<span class="nc" id="L84">					diagram.getHeight(),</span>
					BufferedImage.TYPE_INT_RGB);
		}
		
<span class="nc" id="L88">		return render(diagram, image, options);</span>
	}
	
	public RenderedImage render(Diagram diagram, BufferedImage image,  RenderingOptions options){
<span class="nc" id="L92">		RenderedImage renderedImage = image;</span>
<span class="nc" id="L93">		Graphics2D g2 = image.createGraphics();</span>

<span class="nc" id="L95">		Object antialiasSetting = RenderingHints.VALUE_ANTIALIAS_OFF;</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">		if(options.performAntialias())</span>
<span class="nc" id="L97">			antialiasSetting = RenderingHints.VALUE_ANTIALIAS_ON;</span>
		
<span class="nc" id="L99">		g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, antialiasSetting);</span>

<span class="nc" id="L101">		g2.setColor(options.getBackgroundColor());</span>
		//TODO: find out why the next line does not work
<span class="nc" id="L103">		g2.fillRect(0, 0, image.getWidth()+10, image.getHeight()+10);</span>
		/*for(int y = 0; y &lt; diagram.getHeight(); y ++)
			g2.drawLine(0, y, diagram.getWidth(), y);*/
		
<span class="nc" id="L107">		g2.setStroke(new BasicStroke(1, BasicStroke.CAP_SQUARE, BasicStroke.JOIN_ROUND));</span>

<span class="nc" id="L109">		ArrayList&lt;DiagramShape&gt; shapes = diagram.getAllDiagramShapes();</span>

		if(DEBUG) System.out.println(&quot;Rendering &quot;+shapes.size()+&quot; shapes (groups flattened)&quot;);

		Iterator&lt;DiagramShape&gt; shapesIt;
<span class="nc bnc" id="L114" title="All 2 branches missed.">		if(options.dropShadows()){</span>
			//render shadows
<span class="nc" id="L116">			shapesIt = shapes.iterator();</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">			while(shapesIt.hasNext()){</span>
<span class="nc" id="L118">				DiagramShape shape = shapesIt.next();</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">				if(shape.getPoints().isEmpty()) continue;</span>

				//GeneralPath path = shape.makeIntoPath();
				GeneralPath path;
<span class="nc" id="L124">				path = shape.makeIntoRenderPath(diagram, options);			</span>
							
<span class="nc" id="L126">				float offset = diagram.getMinimumOfCellDimension() / 3.333f;</span>
			
<span class="nc bnc" id="L128" title="All 2 branches missed.">				if(path != null</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">						&amp;&amp; shape.dropsShadow()</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">						&amp;&amp; shape.getType() != DiagramShape.TYPE_CUSTOM){</span>
<span class="nc" id="L131">					GeneralPath shadow = new GeneralPath(path);</span>
<span class="nc" id="L132">					AffineTransform translate = new AffineTransform();</span>
<span class="nc" id="L133">					translate.setToTranslation(offset, offset);</span>
<span class="nc" id="L134">					shadow.transform(translate);</span>
<span class="nc" id="L135">					g2.setColor(new Color(150,150,150));</span>
<span class="nc" id="L136">					g2.fill(shadow);</span>
				
				}
<span class="nc" id="L139">			}</span>

		
			//blur shadows
		
			if(true) {
<span class="nc" id="L145">				int blurRadius = 6;</span>
<span class="nc" id="L146">				int blurRadius2 = blurRadius * blurRadius;</span>
<span class="nc" id="L147">				float blurRadius2F = blurRadius2;</span>
<span class="nc" id="L148">				float weight = 1.0f / blurRadius2F;</span>
<span class="nc" id="L149">				float[] elements = new float[blurRadius2];</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">				for (int k = 0; k &lt; blurRadius2; k++)</span>
<span class="nc" id="L151">					elements[k] = weight;</span>
<span class="nc" id="L152">				Kernel myKernel = new Kernel(blurRadius, blurRadius, elements);</span>

				//if EDGE_NO_OP is not selected, EDGE_ZERO_FILL is the default which creates a black border 
<span class="nc" id="L155">				ConvolveOp simpleBlur =</span>
					new ConvolveOp(myKernel, ConvolveOp.EDGE_NO_OP, null);
								
<span class="nc" id="L158">				BufferedImage destination =</span>
					new BufferedImage(
<span class="nc" id="L160">						image.getWidth(),</span>
<span class="nc" id="L161">						image.getHeight(),</span>
<span class="nc" id="L162">						image.getType());</span>

<span class="nc" id="L164">				simpleBlur.filter(image, (BufferedImage) destination);</span>

				//destination = destination.getSubimage(blurRadius/2, blurRadius/2, image.getWidth(), image.getHeight()); 
<span class="nc" id="L167">				g2 = (Graphics2D) destination.getGraphics();</span>
<span class="nc" id="L168">				g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, antialiasSetting);</span>
<span class="nc" id="L169">				renderedImage = (RenderedImage) destination;</span>
			}
		}

		
		//fill and stroke
		
<span class="nc" id="L176">		float dashInterval = Math.min(diagram.getCellWidth(), diagram.getCellHeight()) / 2;</span>
		//Stroke normalStroke = g2.getStroke();
		
<span class="nc" id="L179">		float strokeWeight = diagram.getMinimumOfCellDimension() / 10;</span>
		
<span class="nc" id="L181">		normalStroke =</span>
		  new BasicStroke(
			strokeWeight,
			//10,
			BasicStroke.CAP_ROUND,
			BasicStroke.JOIN_ROUND
		  );

<span class="nc" id="L189">		dashStroke = </span>
		  new BasicStroke(
			strokeWeight,
			BasicStroke.CAP_BUTT,
			BasicStroke.JOIN_ROUND,
			0,
			new float[] {dashInterval}, 
			0
		  );
		
		//TODO: at this stage we should draw the open shapes first in order to make sure they are at the bottom (this is useful for the {mo} shape) 
		
		
		//find storage shapes
<span class="nc" id="L203">		ArrayList&lt;DiagramShape&gt; storageShapes = new ArrayList&lt;DiagramShape&gt;();</span>
<span class="nc" id="L204">		shapesIt = shapes.iterator();</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">		while(shapesIt.hasNext()){</span>
<span class="nc" id="L206">			DiagramShape shape = (DiagramShape) shapesIt.next();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">			if(shape.getType() == DiagramShape.TYPE_STORAGE) {</span>
<span class="nc" id="L208">				storageShapes.add(shape);</span>
<span class="nc" id="L209">				continue;</span>
			} 
<span class="nc" id="L211">		}</span>

		//render storage shapes
		//special case since they are '3d' and should be
		//rendered bottom to top
		//TODO: known bug: if a storage object is within a bigger normal box, it will be overwritten in the main drawing loop
		//(BUT this is not possible since tags are applied to all shapes overlaping shapes)

		
<span class="nc" id="L220">		Collections.sort(storageShapes, new Shape3DOrderingComparator());</span>
		
<span class="nc" id="L222">		g2.setStroke(normalStroke);</span>
<span class="nc" id="L223">		shapesIt = storageShapes.iterator();</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">		while(shapesIt.hasNext()){</span>
<span class="nc" id="L225">			DiagramShape shape = (DiagramShape) shapesIt.next();</span>

			GeneralPath path;
<span class="nc" id="L228">			path = shape.makeIntoRenderPath(diagram, options);</span>
			
<span class="nc bnc" id="L230" title="All 2 branches missed.">			if(!shape.isStrokeDashed()) {</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">				if(shape.getFillColor() != null)</span>
<span class="nc" id="L232">					g2.setColor(shape.getFillColor());</span>
				else
<span class="nc" id="L234">					g2.setColor(Color.white);</span>
<span class="nc" id="L235">				g2.fill(path);</span>
			}

<span class="nc bnc" id="L238" title="All 2 branches missed.">			if(shape.isStrokeDashed())</span>
<span class="nc" id="L239">				g2.setStroke(dashStroke);</span>
			else
<span class="nc" id="L241">				g2.setStroke(normalStroke);</span>
<span class="nc" id="L242">			g2.setColor(shape.getStrokeColor());</span>
<span class="nc" id="L243">			g2.draw(path);</span>
<span class="nc" id="L244">		}</span>

		//sort so that the largest shapes are rendered first
<span class="nc" id="L247">		Collections.sort(shapes, new ShapeAreaComparator());</span>
		
		//render the rest of the shapes
<span class="nc" id="L250">		ArrayList&lt;DiagramShape&gt; pointMarkers = new ArrayList&lt;DiagramShape&gt;();</span>
<span class="nc" id="L251">		shapesIt = shapes.iterator();</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">		while(shapesIt.hasNext()){</span>
<span class="nc" id="L253">			DiagramShape shape = (DiagramShape) shapesIt.next();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">			if(shape.getType() == DiagramShape.TYPE_POINT_MARKER) {</span>
<span class="nc" id="L255">				pointMarkers.add(shape);</span>
<span class="nc" id="L256">				continue;</span>
			} 
<span class="nc bnc" id="L258" title="All 2 branches missed.">			if(shape.getType() == DiagramShape.TYPE_STORAGE) {</span>
<span class="nc" id="L259">				continue;</span>
			} 
<span class="nc bnc" id="L261" title="All 2 branches missed.">			if(shape.getType() == DiagramShape.TYPE_CUSTOM){</span>
<span class="nc" id="L262">				renderCustomShape(shape, g2);</span>
<span class="nc" id="L263">				continue;</span>
			}

<span class="nc bnc" id="L266" title="All 2 branches missed.">			if(shape.getPoints().isEmpty()) continue;</span>

<span class="nc" id="L268">			int size = shape.getPoints().size();</span>
			
			GeneralPath path;
<span class="nc" id="L271">			path = shape.makeIntoRenderPath(diagram, options);</span>
			
			//fill
<span class="nc bnc" id="L274" title="All 6 branches missed.">			if(path != null &amp;&amp; shape.isClosed() &amp;&amp; !shape.isStrokeDashed()){</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">				if(shape.getFillColor() != null)</span>
<span class="nc" id="L276">					g2.setColor(shape.getFillColor());</span>
				else
<span class="nc" id="L278">					g2.setColor(Color.white);</span>
<span class="nc" id="L279">				g2.fill(path);</span>
			}
			
			//draw
<span class="nc bnc" id="L283" title="All 2 branches missed.">			if(shape.getType() != DiagramShape.TYPE_ARROWHEAD){</span>
<span class="nc" id="L284">				g2.setColor(shape.getStrokeColor());</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">				if(shape.isStrokeDashed())</span>
<span class="nc" id="L286">					g2.setStroke(dashStroke);</span>
				else
<span class="nc" id="L288">					g2.setStroke(normalStroke);</span>
<span class="nc" id="L289">				g2.draw(path);</span>
			}
<span class="nc" id="L291">		}</span>
		
		//render point markers
		
<span class="nc" id="L295">		g2.setStroke(normalStroke);</span>
<span class="nc" id="L296">		shapesIt = pointMarkers.iterator();</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">		while(shapesIt.hasNext()){</span>
<span class="nc" id="L298">			DiagramShape shape = (DiagramShape) shapesIt.next();</span>
			//if(shape.getType() != DiagramShape.TYPE_POINT_MARKER) continue;

			GeneralPath path;
<span class="nc" id="L302">			path = shape.makeIntoRenderPath(diagram, options);</span>
			
<span class="nc" id="L304">			g2.setColor(Color.white);</span>
<span class="nc" id="L305">			g2.fill(path);</span>
<span class="nc" id="L306">			g2.setColor(shape.getStrokeColor());</span>
<span class="nc" id="L307">			g2.draw(path);</span>
<span class="nc" id="L308">		}		</span>
		
		//handle text
		//g2.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
		//renderTextLayer(diagram.getTextObjects().iterator());
		
<span class="nc" id="L314">		Iterator&lt;DiagramText&gt; textIt = diagram.getTextObjects().iterator();</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">		while(textIt.hasNext()){</span>
<span class="nc" id="L316">			DiagramText text = textIt.next();</span>
<span class="nc" id="L317">			g2.setFont(text.getFont());</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">			if(text.hasOutline()){</span>
<span class="nc" id="L319">				g2.setColor(text.getOutlineColor());</span>
<span class="nc" id="L320">				g2.drawString(text.getText(), text.getXPos() + 1, text.getYPos());</span>
<span class="nc" id="L321">				g2.drawString(text.getText(), text.getXPos() - 1, text.getYPos());</span>
<span class="nc" id="L322">				g2.drawString(text.getText(), text.getXPos(), text.getYPos() + 1);</span>
<span class="nc" id="L323">				g2.drawString(text.getText(), text.getXPos(), text.getYPos() - 1);</span>
			}
<span class="nc" id="L325">			g2.setColor(text.getColor());</span>
<span class="nc" id="L326">			g2.drawString(text.getText(), text.getXPos(), text.getYPos());</span>
<span class="nc" id="L327">		}</span>
		
<span class="nc bnc" id="L329" title="All 2 branches missed.">		if(options.renderDebugLines() || DEBUG_LINES){</span>
<span class="nc" id="L330">			Stroke debugStroke =</span>
			  new BasicStroke(
				1,
				BasicStroke.CAP_ROUND,
				BasicStroke.JOIN_ROUND
			  );
<span class="nc" id="L336">			g2.setStroke(debugStroke);</span>
<span class="nc" id="L337">			g2.setColor(new Color(170, 170, 170));</span>
<span class="nc" id="L338">			g2.setXORMode(Color.white);</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">			for(int x = 0; x &lt; diagram.getWidth(); x += diagram.getCellWidth())</span>
<span class="nc" id="L340">				g2.drawLine(x, 0, x, diagram.getHeight());</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">			for(int y = 0; y &lt; diagram.getHeight(); y += diagram.getCellHeight())</span>
<span class="nc" id="L342">				g2.drawLine(0, y, diagram.getWidth(), y);</span>
		}
		

<span class="nc" id="L346">		g2.dispose();</span>
		
<span class="nc" id="L348">		return renderedImage;</span>
	}
	
	private RenderedImage renderTextLayer(ArrayList&lt;DiagramText&gt; textObjects, int width, int height){
<span class="nc" id="L352">		TextCanvas canvas = new TextCanvas(textObjects);</span>
<span class="nc" id="L353">		Image image = canvas.createImage(width, height);</span>
<span class="nc" id="L354">		Graphics g = image.getGraphics();</span>
<span class="nc" id="L355">		canvas.paint(g);</span>
<span class="nc" id="L356">		return (RenderedImage) image;</span>
	}
	
	private class TextCanvas extends Canvas {
		ArrayList&lt;DiagramText&gt; textObjects;
		
<span class="nc" id="L362">		public TextCanvas(ArrayList&lt;DiagramText&gt; textObjects){</span>
<span class="nc" id="L363">			this.textObjects = textObjects;</span>
<span class="nc" id="L364">		}</span>
		
		public void paint(Graphics g){
<span class="nc" id="L367">			Graphics g2 = (Graphics2D) g;</span>
<span class="nc" id="L368">			Iterator&lt;DiagramText&gt; textIt = textObjects.iterator();</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">			while(textIt.hasNext()){</span>
<span class="nc" id="L370">				DiagramText text = (DiagramText) textIt.next();</span>
<span class="nc" id="L371">				g2.setFont(text.getFont());</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">				if(text.hasOutline()){</span>
<span class="nc" id="L373">					g2.setColor(text.getOutlineColor());</span>
<span class="nc" id="L374">					g2.drawString(text.getText(), text.getXPos() + 1, text.getYPos());</span>
<span class="nc" id="L375">					g2.drawString(text.getText(), text.getXPos() - 1, text.getYPos());</span>
<span class="nc" id="L376">					g2.drawString(text.getText(), text.getXPos(), text.getYPos() + 1);</span>
<span class="nc" id="L377">					g2.drawString(text.getText(), text.getXPos(), text.getYPos() - 1);</span>
				}
<span class="nc" id="L379">				g2.setColor(text.getColor());</span>
<span class="nc" id="L380">				g2.drawString(text.getText(), text.getXPos(), text.getYPos());</span>
<span class="nc" id="L381">			}</span>
<span class="nc" id="L382">		}</span>
	}
	
	private void renderCustomShape(DiagramShape shape, Graphics2D g2){
<span class="nc" id="L386">		CustomShapeDefinition definition = shape.getDefinition();</span>
		
<span class="nc" id="L388">		Rectangle bounds = shape.getBounds();</span>
		
<span class="nc bnc" id="L390" title="All 2 branches missed.">		if(definition.hasBorder()){</span>
<span class="nc" id="L391">			g2.setColor(shape.getStrokeColor());</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">			if(shape.isStrokeDashed())</span>
<span class="nc" id="L393">				g2.setStroke(dashStroke);</span>
			else
<span class="nc" id="L395">				g2.setStroke(normalStroke);</span>
<span class="nc" id="L396">			g2.drawLine(bounds.x, bounds.y, bounds.x + bounds.width, bounds.y);</span>
<span class="nc" id="L397">			g2.drawLine(bounds.x + bounds.width, bounds.y, bounds.x + bounds.width, bounds.y + bounds.height);</span>
<span class="nc" id="L398">			g2.drawLine(bounds.x, bounds.y + bounds.height, bounds.x + bounds.width, bounds.y + bounds.height);</span>
<span class="nc" id="L399">			g2.drawLine(bounds.x, bounds.y, bounds.x, bounds.y + bounds.height);</span>
			
//			g2.drawRect(bounds.x, bounds.y, bounds.width, bounds.height); //looks different!			
		}
		
		//TODO: custom shape distinction relies on filename extension. Make this more intelligent
<span class="nc bnc" id="L405" title="All 2 branches missed.">		if(definition.getFilename().endsWith(&quot;.png&quot;)){</span>
<span class="nc" id="L406">			renderCustomPNGShape(shape, g2);</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">		} else if(definition.getFilename().endsWith(&quot;.svg&quot;)){</span>
			// renderCustomSVGShape(shape, g2);
<span class="nc" id="L409">			throw new UnsupportedOperationException();</span>
		}
<span class="nc" id="L411">	}</span>
	
//	private void renderCustomSVGShape(DiagramShape shape, Graphics2D g2){
//		CustomShapeDefinition definition = shape.getDefinition();
//		Rectangle bounds = shape.getBounds();
//		Image graphic;
//		try {
//			if(shape.getFillColor() == null) {
//				graphic = ImageHandler.instance().renderSVG(
//						definition.getFilename(), bounds.width, bounds.height, definition.stretches());
//			} else {
//				graphic = ImageHandler.instance().renderSVG(
//						definition.getFilename(), bounds.width, bounds.height, definition.stretches(), IDREGEX, shape.getFillColor());				
//			}
//			g2.drawImage(graphic, bounds.x, bounds.y, null);
//		} catch (IOException e) {
//			e.printStackTrace();
//		}
//	}
	
	private void renderCustomPNGShape(DiagramShape shape, Graphics2D g2){
<span class="nc" id="L432">		CustomShapeDefinition definition = shape.getDefinition();</span>
<span class="nc" id="L433">		Rectangle bounds = shape.getBounds();</span>
<span class="nc" id="L434">		Image graphic = ImageHandler.instance().loadImage(definition.getFilename());</span>
		
		int xPos, yPos, width, height;
		
<span class="nc bnc" id="L438" title="All 2 branches missed.">		if(definition.stretches()){ //occupy all available space</span>
<span class="nc" id="L439">			xPos = bounds.x; yPos = bounds.y;</span>
<span class="nc" id="L440">			width = bounds.width; height = bounds.height;</span>
		} else { //decide how to fit
<span class="nc" id="L442">			int newHeight = bounds.width * graphic.getHeight(null) / graphic.getWidth(null);</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">			if(newHeight &lt; bounds.height){ //expand to fit width</span>
<span class="nc" id="L444">				height = newHeight;</span>
<span class="nc" id="L445">				width = bounds.width;</span>
<span class="nc" id="L446">				xPos = bounds.x;</span>
<span class="nc" id="L447">				yPos = bounds.y + bounds.height / 2 - graphic.getHeight(null) / 2;</span>
			} else { //expand to fit height
<span class="nc" id="L449">				width = graphic.getWidth(null) * bounds.height / graphic.getHeight(null);</span>
<span class="nc" id="L450">				height = bounds.height;</span>
<span class="nc" id="L451">				xPos = bounds.x + bounds.width / 2 - graphic.getWidth(null) / 2;</span>
<span class="nc" id="L452">				yPos = bounds.y;</span>
			}
		}
		
<span class="nc" id="L456">		g2.drawImage(graphic, xPos, yPos, width, height, null);		</span>
<span class="nc" id="L457">	}</span>
	
	public static boolean isColorDark(Color color){
<span class="nc" id="L460">		int brightness = Math.max(color.getRed(), color.getGreen());</span>
<span class="nc" id="L461">		brightness = Math.max(color.getBlue(), brightness);</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">		if(brightness &lt; 200) {</span>
			if(DEBUG) System.out.println(&quot;Color &quot;+color+&quot; is dark&quot;);
<span class="nc" id="L464">			return true;</span>
		}
		if(DEBUG) System.out.println(&quot;Color &quot;+color+&quot; is not dark&quot;);
<span class="nc" id="L467">		return false;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>