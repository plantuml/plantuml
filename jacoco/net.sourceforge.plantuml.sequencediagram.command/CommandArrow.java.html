<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommandArrow.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">plantuml</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.plantuml.sequencediagram.command</a> &gt; <span class="el_source">CommandArrow.java</span></div><h1>CommandArrow.java</h1><pre class="source lang-java linenums">/* ========================================================================
 * PlantUML : a free UML diagram generator
 * ========================================================================
 *
 * (C) Copyright 2009-2024, Arnaud Roques
 *
 * Project Info:  https://plantuml.com
 * 
 * If you like this project or if you find it useful, you can support us at:
 * 
 * https://plantuml.com/patreon (only 1$ per month!)
 * https://plantuml.com/paypal
 * 
 * This file is part of PlantUML.
 *
 * PlantUML is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * PlantUML distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
 * License for more details.
 *
 * You should have received a copy of the GNU General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301,
 * USA.
 *
 *
 * Original Author:  Arnaud Roques
 * 
 *
 */
package net.sourceforge.plantuml.sequencediagram.command;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.StringTokenizer;

import net.sourceforge.plantuml.StringUtils;
import net.sourceforge.plantuml.classdiagram.command.CommandLinkClass;
import net.sourceforge.plantuml.command.CommandExecutionResult;
import net.sourceforge.plantuml.command.ParserPass;
import net.sourceforge.plantuml.command.SingleLineCommand2;
import net.sourceforge.plantuml.descdiagram.command.CommandLinkElement;
import net.sourceforge.plantuml.klimt.color.HColor;
import net.sourceforge.plantuml.klimt.color.HColorSet;
import net.sourceforge.plantuml.klimt.color.NoSuchColorException;
import net.sourceforge.plantuml.klimt.creole.Display;
import net.sourceforge.plantuml.regex.IRegex;
import net.sourceforge.plantuml.regex.RegexConcat;
import net.sourceforge.plantuml.regex.RegexLeaf;
import net.sourceforge.plantuml.regex.RegexOptional;
import net.sourceforge.plantuml.regex.RegexOr;
import net.sourceforge.plantuml.regex.RegexResult;
import net.sourceforge.plantuml.sequencediagram.LifeEventType;
import net.sourceforge.plantuml.sequencediagram.Message;
import net.sourceforge.plantuml.sequencediagram.Participant;
import net.sourceforge.plantuml.sequencediagram.SequenceDiagram;
import net.sourceforge.plantuml.skin.ArrowBody;
import net.sourceforge.plantuml.skin.ArrowConfiguration;
import net.sourceforge.plantuml.skin.ArrowDecoration;
import net.sourceforge.plantuml.skin.ArrowHead;
import net.sourceforge.plantuml.skin.ArrowPart;
import net.sourceforge.plantuml.stereo.Stereotype;
import net.sourceforge.plantuml.stereo.StereotypePattern;
import net.sourceforge.plantuml.url.Url;
import net.sourceforge.plantuml.url.UrlBuilder;
import net.sourceforge.plantuml.url.UrlMode;
import net.sourceforge.plantuml.utils.LineLocation;

public class CommandArrow extends SingleLineCommand2&lt;SequenceDiagram&gt; {

	static final String ANCHOR = &quot;(\\{([%pLN_]+)\\}[%s]+)?&quot;;

	public CommandArrow() {
<span class="fc" id="L80">		super(getRegexConcat());</span>
<span class="fc" id="L81">	}</span>

	public static String getColorOrStylePattern() {
<span class="fc" id="L84">		return &quot;(?:\\[(&quot; + CommandLinkElement.LINE_STYLE + &quot;)\\])?&quot;;</span>
	}

	static IRegex getRegexConcat() {
<span class="fc" id="L88">		return RegexConcat.build(CommandArrow.class.getName(), RegexLeaf.start(), //</span>
				new RegexLeaf(1, &quot;PARALLEL&quot;, &quot;(&amp;[%s]*)?&quot;), //
				new RegexLeaf(2, &quot;ANCHOR&quot;, ANCHOR), //
				new RegexOr(&quot;PART1&quot;, //
						new RegexLeaf(1, &quot;PART1CODE&quot;, &quot;([%pLN_.@]+)&quot;), //
						new RegexLeaf(1, &quot;PART1LONG&quot;, &quot;[%g]([^%g]+)[%g]&quot;), //
						new RegexLeaf(2, &quot;PART1LONGCODE&quot;, &quot;[%g]([^%g]+)[%g][%s]*as[%s]+([%pLN_.@]+)&quot;), //
						new RegexLeaf(2, &quot;PART1CODELONG&quot;, &quot;([%pLN_.@]+)[%s]+as[%s]*[%g]([^%g]+)[%g]&quot;)), //
				new RegexLeaf(2, &quot;PART1ANCHOR&quot;, ANCHOR), //
<span class="fc" id="L97">				RegexLeaf.spaceZeroOrMore(), //</span>
				new RegexOptional(new RegexOr(&quot;ARROW_DRESSING1&quot;, //
						new RegexLeaf(&quot;[%s][ox]&quot;), //
						new RegexLeaf(&quot;(?:[%s][ox]|\\(\\d+\\))?&lt;&lt;?_?&quot;), //
						new RegexLeaf(&quot;(?:[%s][ox])?//?&quot;), //
						new RegexLeaf(&quot;(?:[%s][ox])?\\\\\\\\?&quot;))), //
				new RegexOr(new RegexConcat( //
						new RegexLeaf(1, &quot;ARROW_BODYA1&quot;, &quot;(-+)&quot;), //
<span class="fc" id="L105">						new RegexLeaf(1, &quot;ARROW_STYLE1&quot;, getColorOrStylePattern()), //</span>
						new RegexLeaf(1, &quot;ARROW_BODYB1&quot;, &quot;(-*)&quot;)), //
						new RegexConcat( //
								new RegexLeaf(1, &quot;ARROW_BODYA2&quot;, &quot;(-*)&quot;), //
<span class="fc" id="L109">								new RegexLeaf(1, &quot;ARROW_STYLE2&quot;, getColorOrStylePattern()), //</span>
								new RegexLeaf(1, &quot;ARROW_BODYB2&quot;, &quot;(-+)&quot;))), //
				new RegexOptional(new RegexOr(&quot;ARROW_DRESSING2&quot;, //
						new RegexLeaf(&quot;_?&gt;&gt;?(?:[ox][%s]|\\(\\d+\\))?&quot;), //
						new RegexLeaf(&quot;//?(?:[ox][%s])?&quot;), //
						new RegexLeaf(&quot;\\\\\\\\?(?:[ox][%s])?&quot;), //
						new RegexLeaf(&quot;[ox][%s]&quot;))), //
<span class="fc" id="L116">				RegexLeaf.spaceZeroOrMore(), //</span>
				new RegexOr(&quot;PART2&quot;, //
						new RegexLeaf(1, &quot;PART2CODE&quot;, &quot;([%pLN_.@]+)&quot;), //
						new RegexLeaf(1, &quot;PART2LONG&quot;, &quot;[%g]([^%g]+)[%g]&quot;), //
						new RegexLeaf(2, &quot;PART2LONGCODE&quot;, &quot;[%g]([^%g]+)[%g][%s]*as[%s]+([%pLN_.@]+)&quot;), //
						new RegexLeaf(2, &quot;PART2CODELONG&quot;, &quot;([%pLN_.@]+)[%s]+as[%s]*[%g]([^%g]+)[%g]&quot;)), //
				new RegexLeaf(1, &quot;MULTICAST&quot;, &quot;((?:\\s&amp;\\s[%pLN_.@]+)*)&quot;), //
				new RegexLeaf(2, &quot;PART2ANCHOR&quot;, ANCHOR), //
<span class="fc" id="L124">				RegexLeaf.spaceZeroOrMore(), //</span>
				new RegexLeaf(1, &quot;ACTIVATION&quot;, &quot;(?:(\\+\\+|\\*\\*|!!|--|--\\+\\+|\\+\\+--)?)&quot;), //
<span class="fc" id="L126">				RegexLeaf.spaceZeroOrMore(), //</span>
				new RegexLeaf(1, &quot;LIFECOLOR&quot;, &quot;(?:(#\\w+)?)&quot;), //
<span class="fc" id="L128">				StereotypePattern.optional(&quot;STEREOTYPE&quot;), //</span>
				UrlBuilder.OPTIONAL, //
<span class="fc" id="L130">				RegexLeaf.spaceZeroOrMore(), //</span>
				new RegexLeaf(1, &quot;MESSAGE&quot;, &quot;(?::[%s]*(.*))?&quot;), //
<span class="fc" id="L132">				RegexLeaf.end()).protectSize(2000);</span>
	}

	private List&lt;Participant&gt; getMulticasts(LineLocation location, SequenceDiagram system, RegexResult arg2) {
<span class="fc" id="L136">		final String multicast = arg2.get(&quot;MULTICAST&quot;, 0);</span>
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">		if (multicast != null) {</span>
<span class="fc" id="L138">			final List&lt;Participant&gt; result = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">			for (String s : multicast.split(&quot;&amp;&quot;)) {</span>
<span class="fc" id="L140">				s = s.trim();</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">				if (s.length() == 0)</span>
<span class="fc" id="L142">					continue;</span>

<span class="nc" id="L144">				final Participant participant = system.getOrCreateParticipant(location, s);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">				if (participant != null)</span>
<span class="nc" id="L146">					result.add(participant);</span>

			}
<span class="fc" id="L149">			return Collections.unmodifiableList(result);</span>
		}
<span class="nc" id="L151">		return Collections.emptyList();</span>
	}

	private Participant getOrCreateParticipant(LineLocation location, SequenceDiagram system, RegexResult arg2, String n) {
		final String code;
		final Display display;
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">		if (arg2.get(n + &quot;CODE&quot;, 0) != null) {</span>
<span class="fc" id="L158">			code = arg2.get(n + &quot;CODE&quot;, 0);</span>
<span class="fc" id="L159">			display = Display.getWithNewlines(system.getPragma(), code);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">		} else if (arg2.get(n + &quot;LONG&quot;, 0) != null) {</span>
<span class="nc" id="L161">			code = arg2.get(n + &quot;LONG&quot;, 0);</span>
<span class="nc" id="L162">			display = Display.getWithNewlines(system.getPragma(), code);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">		} else if (arg2.get(n + &quot;LONGCODE&quot;, 0) != null) {</span>
<span class="nc" id="L164">			display = Display.getWithNewlines(system.getPragma(), arg2.get(n + &quot;LONGCODE&quot;, 0));</span>
<span class="nc" id="L165">			code = arg2.get(n + &quot;LONGCODE&quot;, 1);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">		} else if (arg2.get(n + &quot;CODELONG&quot;, 0) != null) {</span>
<span class="nc" id="L167">			code = arg2.get(n + &quot;CODELONG&quot;, 0);</span>
<span class="nc" id="L168">			display = Display.getWithNewlines(system.getPragma(), arg2.get(n + &quot;CODELONG&quot;, 1));</span>
<span class="nc" id="L169">			return system.getOrCreateParticipant(location, code, display);</span>
		} else {
<span class="nc" id="L171">			throw new IllegalStateException();</span>
		}
<span class="fc" id="L173">		return system.getOrCreateParticipant(location, code, display);</span>
	}

	private boolean contains(String string, String... totest) {
<span class="fc bfc" id="L177" title="All 2 branches covered.">		for (String t : totest)</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">			if (string.contains(t))</span>
<span class="fc" id="L179">				return true;</span>

<span class="fc" id="L181">		return false;</span>
	}

	private String getDressing(RegexResult arg, String key) {
<span class="fc" id="L185">		String value = arg.get(key, 0);</span>
<span class="fc" id="L186">		value = CommandLinkClass.notNull(value);</span>
<span class="fc" id="L187">		value = value.replace(&quot;_&quot;, &quot;&quot;);</span>
<span class="fc" id="L188">		return StringUtils.goLowerCase(value);</span>
	}

	private int getInclination(String key) {
<span class="fc bfc" id="L192" title="All 2 branches covered.">		if (key == null)</span>
<span class="fc" id="L193">			return 0;</span>
<span class="fc" id="L194">		final int x1 = key.indexOf('(');</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">		if (x1 == -1)</span>
<span class="fc" id="L196">			return 0;</span>
<span class="nc" id="L197">		final int x2 = key.indexOf(')');</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">		if (x2 == -1)</span>
<span class="nc" id="L199">			return 0;</span>
<span class="nc" id="L200">		return Integer.parseInt(key.substring(x1 + 1, x2));</span>
	}

	@Override
	protected CommandExecutionResult executeArg(SequenceDiagram diagram, LineLocation location, RegexResult arg, ParserPass currentPass)
			throws NoSuchColorException {

<span class="fc" id="L207">		final String dressing1 = getDressing(arg, &quot;ARROW_DRESSING1&quot;);</span>
<span class="fc" id="L208">		final String dressing2 = getDressing(arg, &quot;ARROW_DRESSING2&quot;);</span>
<span class="fc" id="L209">		final int inclination1 = getInclination(arg.get(&quot;ARROW_DRESSING1&quot;, 0));</span>
<span class="fc" id="L210">		final int inclination2 = getInclination(arg.get(&quot;ARROW_DRESSING2&quot;, 0));</span>

		// Sorry, this code is note very clear
<span class="fc" id="L213">		final boolean hasDressing1butx = contains(dressing1, &quot;&lt;&quot;, &quot;\\&quot;, &quot;/&quot;);</span>
<span class="fc" id="L214">		final boolean xInDressing1 = dressing1.contains(&quot;x&quot;);</span>
<span class="fc" id="L215">		final boolean hasDressing2butx = contains(dressing2, &quot;&gt;&quot;, &quot;\\&quot;, &quot;/&quot;);</span>
<span class="fc" id="L216">		final boolean xInDressing2 = dressing2.contains(&quot;x&quot;);</span>
		final boolean reverseDefine;
<span class="pc bpc" id="L218" title="1 of 6 branches missed.">		if (hasDressing2butx || (xInDressing1 &amp;&amp; xInDressing2))</span>
<span class="fc" id="L219">			reverseDefine = false;</span>
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">		else if (hasDressing1butx)</span>
<span class="fc" id="L221">			reverseDefine = true;</span>
<span class="nc bnc" id="L222" title="All 4 branches missed.">		else if (xInDressing1 || xInDressing2)</span>
<span class="nc" id="L223">			reverseDefine = false;</span>
		else
<span class="nc" id="L225">			return CommandExecutionResult.error(&quot;Illegal sequence arrow&quot;);</span>

		final Participant p1;
		final Participant p2;
		final boolean circleAtStart;
		final boolean circleAtEnd;
		final boolean sync1;
		final boolean sync2;
<span class="fc bfc" id="L233" title="All 2 branches covered.">		if (reverseDefine) {</span>
			// Keep the order
			// See https://github.com/plantuml/plantuml/issues/1819#issuecomment-2158524871
<span class="fc" id="L236">			p2 = getOrCreateParticipant(location, diagram, arg, &quot;PART1&quot;);</span>
<span class="fc" id="L237">			p1 = getOrCreateParticipant(location, diagram, arg, &quot;PART2&quot;);</span>
<span class="fc" id="L238">			circleAtStart = dressing2.contains(&quot;o&quot;);</span>
<span class="fc" id="L239">			circleAtEnd = dressing1.contains(&quot;o&quot;);</span>
<span class="fc" id="L240">			sync2 = contains(dressing1, &quot;&lt;&lt;&quot;, &quot;\\\\&quot;, &quot;//&quot;);</span>
<span class="fc" id="L241">			sync1 = contains(dressing2, &quot;&gt;&gt;&quot;, &quot;\\\\&quot;, &quot;//&quot;);</span>
		} else {
<span class="fc" id="L243">			p1 = getOrCreateParticipant(location, diagram, arg, &quot;PART1&quot;);</span>
<span class="fc" id="L244">			p2 = getOrCreateParticipant(location, diagram, arg, &quot;PART2&quot;);</span>
<span class="fc" id="L245">			circleAtStart = dressing1.contains(&quot;o&quot;);</span>
<span class="fc" id="L246">			circleAtEnd = dressing2.contains(&quot;o&quot;);</span>
<span class="fc" id="L247">			sync1 = contains(dressing1, &quot;&lt;&lt;&quot;, &quot;\\\\&quot;, &quot;//&quot;);</span>
<span class="fc" id="L248">			sync2 = contains(dressing2, &quot;&gt;&gt;&quot;, &quot;\\\\&quot;, &quot;//&quot;);</span>
		}


<span class="fc bfc" id="L252" title="All 2 branches covered.">		final boolean dotted = getLength(arg) &gt; 1;</span>

		final Display labels;
<span class="fc bfc" id="L255" title="All 2 branches covered.">		if (arg.get(&quot;MESSAGE&quot;, 0) == null) {</span>
<span class="fc" id="L256">			labels = Display.create(&quot;&quot;);</span>
		} else {
			// final String message = UrlBuilder.multilineTooltip(arg.get(&quot;MESSAGE&quot;, 0));
<span class="fc" id="L259">			final String message = arg.get(&quot;MESSAGE&quot;, 0);</span>
<span class="fc" id="L260">			labels = Display.getWithNewlines(diagram.getPragma(), message);</span>
		}

<span class="fc bfc" id="L263" title="All 4 branches covered.">		ArrowConfiguration config = hasDressing1butx &amp;&amp; hasDressing2butx ? ArrowConfiguration.withDirectionBoth()</span>
<span class="fc" id="L264">				: ArrowConfiguration.withDirectionNormal();</span>
<span class="fc bfc" id="L265" title="All 2 branches covered.">		if (dotted)</span>
<span class="fc" id="L266">			config = config.withBody(ArrowBody.DOTTED);</span>

<span class="pc bpc" id="L268" title="1 of 2 branches missed.">		if (sync1)</span>
<span class="nc" id="L269">			config = config.withHead1(ArrowHead.ASYNC);</span>
<span class="fc bfc" id="L270" title="All 2 branches covered.">		if (sync2)</span>
<span class="fc" id="L271">			config = config.withHead2(ArrowHead.ASYNC);</span>

<span class="fc bfc" id="L273" title="All 4 branches covered.">		if (dressing2.contains(&quot;\\&quot;) || dressing1.contains(&quot;/&quot;))</span>
<span class="fc" id="L274">			config = config.withPart(ArrowPart.TOP_PART);</span>

<span class="fc bfc" id="L276" title="All 4 branches covered.">		if (dressing2.contains(&quot;/&quot;) || dressing1.contains(&quot;\\&quot;))</span>
<span class="fc" id="L277">			config = config.withPart(ArrowPart.BOTTOM_PART);</span>

<span class="fc bfc" id="L279" title="All 2 branches covered.">		if (circleAtEnd)</span>
<span class="fc" id="L280">			config = config.withDecoration2(ArrowDecoration.CIRCLE);</span>

<span class="fc bfc" id="L282" title="All 2 branches covered.">		if (circleAtStart)</span>
<span class="fc" id="L283">			config = config.withDecoration1(ArrowDecoration.CIRCLE);</span>

<span class="fc bfc" id="L285" title="All 2 branches covered.">		if (reverseDefine) {</span>
<span class="fc bfc" id="L286" title="All 2 branches covered.">			if (xInDressing1)</span>
<span class="fc" id="L287">				config = config.withHead2(ArrowHead.CROSSX);</span>

<span class="fc bfc" id="L289" title="All 2 branches covered.">			if (xInDressing2)</span>
<span class="fc" id="L290">				config = config.withHead1(ArrowHead.CROSSX);</span>

		} else {
<span class="fc bfc" id="L293" title="All 2 branches covered.">			if (xInDressing1)</span>
<span class="fc" id="L294">				config = config.withHead1(ArrowHead.CROSSX);</span>

<span class="fc bfc" id="L296" title="All 2 branches covered.">			if (xInDressing2)</span>
<span class="fc" id="L297">				config = config.withHead2(ArrowHead.CROSSX);</span>

		}
<span class="fc bfc" id="L300" title="All 2 branches covered.">		if (reverseDefine)</span>
<span class="fc" id="L301">			config = config.reverseDefine();</span>

<span class="fc" id="L303">		config = applyStyle(arg.getLazzy(&quot;ARROW_STYLE&quot;, 0), config);</span>

<span class="fc" id="L305">		config = config.withInclination(inclination1 + inclination2);</span>

<span class="fc" id="L307">		final String activationSpec = arg.get(&quot;ACTIVATION&quot;, 0);</span>

<span class="pc bpc" id="L309" title="3 of 4 branches missed.">		if (activationSpec != null &amp;&amp; activationSpec.charAt(0) == '*')</span>
<span class="nc" id="L310">			diagram.activate(p2, LifeEventType.CREATE, null);</span>

<span class="fc" id="L312">		final String messageNumber = diagram.getNextMessageNumber();</span>
<span class="fc" id="L313">		final Message msg = new Message(diagram.getSkinParam().getCurrentStyleBuilder(), p1, p2,</span>
<span class="fc" id="L314">				diagram.manageVariable(labels), config, messageNumber);</span>
<span class="fc" id="L315">		msg.setMulticast(getMulticasts(location, diagram, arg));</span>
<span class="fc" id="L316">		final String url = arg.get(&quot;URL&quot;, 0);</span>
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">		if (url != null) {</span>
<span class="nc" id="L318">			final UrlBuilder urlBuilder = new UrlBuilder(diagram.getSkinParam().getValue(&quot;topurl&quot;), UrlMode.STRICT);</span>
<span class="nc" id="L319">			final Url urlLink = urlBuilder.getUrl(url);</span>
<span class="nc" id="L320">			msg.setUrl(urlLink);</span>
		}

<span class="pc bpc" id="L323" title="1 of 2 branches missed.">		if (arg.get(&quot;STEREOTYPE&quot;, 0) != null) {</span>
<span class="nc" id="L324">			final Stereotype stereotype = Stereotype.build(arg.get(&quot;STEREOTYPE&quot;, 0));</span>
<span class="nc" id="L325">			msg.getStereotype(stereotype);</span>
		}

<span class="pc bpc" id="L328" title="1 of 2 branches missed.">		final boolean parallel = arg.get(&quot;PARALLEL&quot;, 0) != null;</span>
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">		if (parallel)</span>
<span class="nc" id="L330">			msg.goParallel();</span>

<span class="fc" id="L332">		msg.setAnchor(arg.get(&quot;ANCHOR&quot;, 1));</span>
<span class="fc" id="L333">		msg.setPart1Anchor(arg.get(&quot;PART1ANCHOR&quot;, 1));</span>
<span class="fc" id="L334">		msg.setPart2Anchor(arg.get(&quot;PART2ANCHOR&quot;, 1));</span>

<span class="fc" id="L336">		final CommandExecutionResult status = diagram.addMessage(msg);</span>
<span class="pc bpc" id="L337" title="1 of 2 branches missed.">		if (status.isOk() == false)</span>
<span class="nc" id="L338">			return status;</span>

<span class="fc" id="L340">		final String s = arg.get(&quot;LIFECOLOR&quot;, 0);</span>

<span class="pc bpc" id="L342" title="1 of 2 branches missed.">		final HColor activationColor = s == null ? null : diagram.getSkinParam().getIHtmlColorSet().getColor(s);</span>

<span class="pc bpc" id="L344" title="1 of 2 branches missed.">		if (activationSpec != null)</span>
<span class="nc" id="L345">			return manageActivations(activationSpec, diagram, p1, p2, activationColor);</span>

<span class="pc bpc" id="L347" title="5 of 6 branches missed.">		if (diagram.isAutoactivate() &amp;&amp; (config.getHead() == ArrowHead.NORMAL || config.getHead() == ArrowHead.ASYNC))</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">			if (config.isDotted())</span>
<span class="nc" id="L349">				diagram.activate(p1, LifeEventType.DEACTIVATE, null);</span>
			else
<span class="nc" id="L351">				diagram.activate(p2, LifeEventType.ACTIVATE, activationColor);</span>

<span class="fc" id="L353">		return CommandExecutionResult.ok();</span>
	}

	private CommandExecutionResult manageActivations(String spec, SequenceDiagram diagram, Participant p1,
			Participant p2, HColor activationColor) {
<span class="nc bnc" id="L358" title="All 4 branches missed.">		switch (spec.charAt(0)) {</span>
		case '+':
<span class="nc" id="L360">			diagram.activate(p2, LifeEventType.ACTIVATE, activationColor);</span>
<span class="nc" id="L361">			break;</span>
		case '-':
<span class="nc" id="L363">			diagram.activate(p1, LifeEventType.DEACTIVATE, null);</span>
<span class="nc" id="L364">			break;</span>
		case '!':
<span class="nc" id="L366">			diagram.activate(p2, LifeEventType.DESTROY, null);</span>
			break;
		}
<span class="nc bnc" id="L369" title="All 2 branches missed.">		if (spec.length() == 4) {</span>
<span class="nc bnc" id="L370" title="All 3 branches missed.">			switch (spec.charAt(2)) {</span>
			case '+':
<span class="nc" id="L372">				diagram.activate(p2, LifeEventType.ACTIVATE, activationColor);</span>
<span class="nc" id="L373">				break;</span>
			case '-':
<span class="nc" id="L375">				diagram.activate(p1, LifeEventType.DEACTIVATE, null);</span>
				break;
			}
		}
<span class="nc" id="L379">		return CommandExecutionResult.ok();</span>
	}

	private int getLength(RegexResult arg2) {
<span class="fc" id="L383">		String sa = arg2.getLazzy(&quot;ARROW_BODYA&quot;, 0);</span>
<span class="pc bpc" id="L384" title="1 of 2 branches missed.">		if (sa == null)</span>
<span class="nc" id="L385">			sa = &quot;&quot;;</span>

<span class="fc" id="L387">		String sb = arg2.getLazzy(&quot;ARROW_BODYB&quot;, 0);</span>
<span class="pc bpc" id="L388" title="1 of 2 branches missed.">		if (sb == null)</span>
<span class="nc" id="L389">			sb = &quot;&quot;;</span>

<span class="fc" id="L391">		return sa.length() + sb.length();</span>
	}

	public static ArrowConfiguration applyStyle(String arrowStyle, ArrowConfiguration config)
			throws NoSuchColorException {
<span class="fc bfc" id="L396" title="All 2 branches covered.">		if (arrowStyle == null)</span>
<span class="fc" id="L397">			return config;</span>

<span class="fc" id="L399">		final StringTokenizer st = new StringTokenizer(arrowStyle, &quot;,&quot;);</span>
<span class="fc bfc" id="L400" title="All 2 branches covered.">		while (st.hasMoreTokens()) {</span>
<span class="fc" id="L401">			final String s = st.nextToken();</span>
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">			if (s.equalsIgnoreCase(&quot;dashed&quot;)) {</span>
<span class="nc" id="L403">				config = config.withBody(ArrowBody.DOTTED);</span>
<span class="pc bpc" id="L404" title="1 of 2 branches missed.">			} else if (s.equalsIgnoreCase(&quot;bold&quot;)) {</span>
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">			} else if (s.equalsIgnoreCase(&quot;dotted&quot;)) {</span>
<span class="nc" id="L406">				config = config.withBody(ArrowBody.DOTTED);</span>
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">			} else if (s.equalsIgnoreCase(&quot;hidden&quot;)) {</span>
<span class="nc" id="L408">				config = config.withBody(ArrowBody.HIDDEN);</span>
			} else {
<span class="fc" id="L410">				config = config.withColor(HColorSet.instance().getColor(s));</span>
			}
<span class="fc" id="L412">		}</span>
<span class="fc" id="L413">		return config;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>