<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FontChecker.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">plantuml</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.plantuml.swing</a> &gt; <span class="el_source">FontChecker.java</span></div><h1>FontChecker.java</h1><pre class="source lang-java linenums">/* ========================================================================
 * PlantUML : a free UML diagram generator
 * ========================================================================
 *
 * (C) Copyright 2009-2024, Arnaud Roques
 *
 * Project Info:  https://plantuml.com
 *
 * If you like this project or if you find it useful, you can support us at:
 *
 * https://plantuml.com/patreon (only 1$ per month!)
 * https://plantuml.com/paypal
 *
 * This file is part of PlantUML.
 *
 * PlantUML is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * PlantUML distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
 * License for more details.
 *
 * You should have received a copy of the GNU General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301,
 * USA.
 *
 *
 * Original Author:  Arnaud Roques
 *
 *
 */
package net.sourceforge.plantuml.swing;

import java.awt.Font;
import java.awt.GraphicsEnvironment;
import java.awt.Shape;
import java.awt.font.TextLayout;
import java.awt.geom.PathIterator;
import java.awt.image.BufferedImage;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.Arrays;
import java.util.HashSet;
import java.util.Set;

import javax.xml.transform.TransformerException;

import net.atmp.ImageBuilder;
import net.sourceforge.plantuml.FileFormat;
import net.sourceforge.plantuml.FileFormatOption;
import net.sourceforge.plantuml.klimt.UTranslate;
import net.sourceforge.plantuml.klimt.color.HColors;
import net.sourceforge.plantuml.klimt.drawing.LimitFinder;
import net.sourceforge.plantuml.klimt.drawing.UGraphic;
import net.sourceforge.plantuml.klimt.drawing.svg.SvgGraphics;
import net.sourceforge.plantuml.klimt.drawing.svg.SvgOption;
import net.sourceforge.plantuml.klimt.font.FontConfiguration;
import net.sourceforge.plantuml.klimt.font.UFont;
import net.sourceforge.plantuml.klimt.font.UFontContext;
import net.sourceforge.plantuml.klimt.font.UFontFactory;
import net.sourceforge.plantuml.klimt.font.UFontImpl;
import net.sourceforge.plantuml.klimt.shape.UDrawable;
import net.sourceforge.plantuml.klimt.shape.URectangle;
import net.sourceforge.plantuml.klimt.shape.UText;
import net.sourceforge.plantuml.security.SFile;
import net.sourceforge.plantuml.security.SImageIO;

public class FontChecker {
	// ::remove folder when __HAXE__
	// ::remove file when __CORE__

	final private UFont font;
<span class="nc" id="L78">	private static final Set&lt;String&gt; SQUARE = new HashSet&lt;&gt;(Arrays.asList(&quot;MI=I=XM=I=IX&quot;, &quot;MI=I=XM=I=IXMI=I=XM=I=IX&quot;));</span>

<span class="nc" id="L80">	public FontChecker(UFont font) {</span>
<span class="nc" id="L81">		this.font = font;</span>
<span class="nc" id="L82">	}</span>

	public boolean isCharOk(char c) {
<span class="nc bnc" id="L85" title="All 2 branches missed.">		return SQUARE.contains(getCharDesc(c)) == false;</span>
	}

	static private String getType(int type, double oldX, double oldY, double x, double y) {
<span class="nc bnc" id="L89" title="All 2 branches missed.">		if (type == PathIterator.SEG_CLOSE) {</span>
<span class="nc" id="L90">			return &quot;X&quot;;</span>
		}
<span class="nc bnc" id="L92" title="All 2 branches missed.">		if (type == PathIterator.SEG_LINETO) {</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">			if (oldX == x) {</span>
<span class="nc" id="L94">				return &quot;I&quot;;</span>
			}
<span class="nc bnc" id="L96" title="All 2 branches missed.">			if (oldY == y) {</span>
<span class="nc" id="L97">				return &quot;=&quot;;</span>
			}
<span class="nc" id="L99">			return &quot;L&quot;;</span>
		}
<span class="nc bnc" id="L101" title="All 2 branches missed.">		if (type == PathIterator.SEG_MOVETO) {</span>
<span class="nc" id="L102">			return &quot;M&quot;;</span>
		}
<span class="nc bnc" id="L104" title="All 2 branches missed.">		if (type == PathIterator.SEG_QUADTO) {</span>
<span class="nc" id="L105">			return &quot;Q&quot;;</span>
		}
<span class="nc bnc" id="L107" title="All 2 branches missed.">		if (type == PathIterator.SEG_CUBICTO) {</span>
<span class="nc" id="L108">			return &quot;C&quot;;</span>
		}
<span class="nc" id="L110">		throw new IllegalArgumentException();</span>
	}

	public String getCharDesc(char c) {
<span class="nc" id="L114">		final TextLayout t = UFontContext.G2D.createTextLayout(font, &quot;&quot; + c);</span>
<span class="nc" id="L115">		final Shape sh = t.getOutline(null);</span>
<span class="nc" id="L116">		final double current[] = new double[6];</span>
<span class="nc" id="L117">		final PathIterator it = sh.getPathIterator(null);</span>
<span class="nc" id="L118">		int sum = 0;</span>
<span class="nc" id="L119">		final StringBuilder result = new StringBuilder();</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">		while (it.isDone() == false) {</span>
<span class="nc" id="L121">			final double oldX = current[0];</span>
<span class="nc" id="L122">			final double oldY = current[1];</span>
<span class="nc" id="L123">			final int nb = it.currentSegment(current);</span>
<span class="nc" id="L124">			sum += nb;</span>
<span class="nc" id="L125">			result.append(getType(nb, oldX, oldY, current[0], current[1]));</span>
<span class="nc" id="L126">			it.next();</span>
<span class="nc" id="L127">		}</span>
<span class="nc" id="L128">		return result.toString();</span>
	}

	public String getCharDescVerbose(char c) {
<span class="nc" id="L132">		final TextLayout t = UFontContext.G2D.createTextLayout(font, &quot;&quot; + c);</span>
<span class="nc" id="L133">		final Shape sh = t.getOutline(null);</span>
<span class="nc" id="L134">		final double current[] = new double[6];</span>
<span class="nc" id="L135">		final PathIterator it = sh.getPathIterator(null);</span>
<span class="nc" id="L136">		int sum = 0;</span>
<span class="nc" id="L137">		final StringBuilder result = new StringBuilder();</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">		while (it.isDone() == false) {</span>
<span class="nc" id="L139">			final double oldX = current[0];</span>
<span class="nc" id="L140">			final double oldY = current[1];</span>
<span class="nc" id="L141">			final int nb = it.currentSegment(current);</span>
<span class="nc" id="L142">			sum += nb;</span>
<span class="nc" id="L143">			result.append(getType(nb, oldX, oldY, current[0], current[1]));</span>
<span class="nc" id="L144">			appendValue(result, current);</span>
<span class="nc" id="L145">			it.next();</span>
<span class="nc" id="L146">		}</span>
<span class="nc" id="L147">		return result.toString();</span>
	}

	private void appendValue(StringBuilder result, double[] current) {
<span class="nc bnc" id="L151" title="All 2 branches missed.">		for (double v : current) {</span>
<span class="nc" id="L152">			final int i = (int) (v * 100);</span>
<span class="nc" id="L153">			result.append(i);</span>
<span class="nc" id="L154">			result.append(&quot;:&quot;);</span>
		}

<span class="nc" id="L157">	}</span>

	public void printChar(final PrintWriter pw, char c) throws IOException, TransformerException {
<span class="nc" id="L160">		pw.println(&quot;&lt;p&gt;&quot;);</span>
<span class="nc" id="L161">		final int ascii = (int) c;</span>
<span class="nc" id="L162">		pw.println(ascii + &quot; - &quot; + Integer.toHexString(ascii) + &quot; - &quot;);</span>
<span class="nc" id="L163">		pw.println(&quot;&amp;#&quot; + ascii + &quot;;&quot;);</span>
<span class="nc" id="L164">		final String svg = getSvgImage(c);</span>
<span class="nc" id="L165">		pw.println(svg);</span>
<span class="nc" id="L166">	}</span>

	private String getSvgImage(char c) throws IOException, TransformerException {
<span class="nc" id="L169">		final SvgGraphics svg = new SvgGraphics(42, SvgOption.basic());</span>
<span class="nc" id="L170">		svg.setStrokeColor(&quot;black&quot;);</span>
<span class="nc" id="L171">		svg.svgImage(getBufferedImage(c), 0, 0);</span>
<span class="nc" id="L172">		final ByteArrayOutputStream os = new ByteArrayOutputStream();</span>
<span class="nc" id="L173">		svg.createXml(os);</span>
<span class="nc" id="L174">		os.close();</span>
<span class="nc" id="L175">		return new String(os.toByteArray());</span>
	}

	public BufferedImage getBufferedImage(final char c) throws IOException {
<span class="nc bnc" id="L179" title="All 2 branches missed.">		assert c != '\t';</span>

<span class="nc" id="L181">		final double dim = 20;</span>
<span class="nc" id="L182">		final UDrawable drawable = new UDrawable() {</span>
			public void drawU(UGraphic ug) {
<span class="nc" id="L184">				ug = ug.apply(HColors.BLACK);</span>
<span class="nc" id="L185">				ug.draw(URectangle.build(dim - 1, dim - 1));</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">				if (!(ug instanceof LimitFinder)) {</span>
<span class="nc" id="L187">					ug = ug.apply(new UTranslate(dim / 3, 2 * dim / 3));</span>
<span class="nc" id="L188">					final UText text = UText.build(&quot;&quot; + c, FontConfiguration.blackBlueTrue(font));</span>
<span class="nc" id="L189">					ug.draw(text);</span>
				}
<span class="nc" id="L191">			}</span>
		};
<span class="nc" id="L193">		final byte[] bytes = ImageBuilder.create(new FileFormatOption(FileFormat.PNG), drawable).writeByteArray();</span>
<span class="nc" id="L194">		return SImageIO.read(bytes);</span>
	}

	// public BufferedImage getBufferedImageOld(char c) throws IOException {
	// final double dim = 20;
	// UGraphic2 ug = new FileFormatOption(FileFormat.PNG).createUGraphic(new
	// Dimension2DDouble(dim, dim));
	// ug = (UGraphic2) ug.apply(UChangeColor.nnn(HtmlColorUtils.BLACK));
	// ug.draw(URectangle.build(dim - 1, dim - 1));
	// ug = (UGraphic2) ug.apply(new UTranslate(dim / 3, 2 * dim / 3));
	// final UText text = new UText(&quot;&quot; + c, FontConfiguration.create(font,
	// HtmlColorUtils.BLACK));
	// ug.draw(text);
	// final ByteArrayOutputStream os = new ByteArrayOutputStream();
	// ug.writeImageTOBEMOVED(os, null, 96);
	// os.close();
	// return ImageIO.read(new ByteArrayInputStream(os.toByteArray()));
	// }

	public static void main(String[] args) throws IOException, TransformerException {

<span class="nc" id="L215">		final String name = args[0];</span>
<span class="nc" id="L216">		final int size = Integer.parseInt(args[1]);</span>
<span class="nc" id="L217">		final int v1 = Integer.parseInt(args[2]);</span>
<span class="nc" id="L218">		final int v2 = Integer.parseInt(args[3]);</span>
<span class="nc" id="L219">		final SFile f = new SFile(&quot;fontchecker-&quot; + name + &quot;-&quot; + v1 + &quot;-&quot; + v2 + &quot;.html&quot;);</span>

<span class="nc" id="L221">		final FontChecker fc = new FontChecker(UFontFactory.build(name, Font.PLAIN, size));</span>
<span class="nc" id="L222">		final PrintWriter pw = f.createPrintWriter();</span>
<span class="nc" id="L223">		pw.println(&quot;&lt;html&gt;&quot;);</span>
<span class="nc" id="L224">		pw.println(&quot;&lt;h1&gt;PROBLEM&lt;/h1&gt;&quot;);</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">		for (int i = v1; i &lt;= v2; i++) {</span>
<span class="nc" id="L226">			final char c = (char) i;</span>
<span class="nc" id="L227">			final boolean ok = fc.isCharOk(c);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">			if (ok == false) {</span>
<span class="nc" id="L229">				fc.printChar(pw, c);</span>
<span class="nc" id="L230">				pw.println(&quot;&lt;/p&gt;&quot;);</span>
			}
		}
<span class="nc" id="L233">		pw.println(&quot;&lt;h1&gt;OK&lt;/h1&gt;&quot;);</span>
<span class="nc" id="L234">		final String allFontNames[] = GraphicsEnvironment.getLocalGraphicsEnvironment().getAvailableFontFamilyNames();</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">		for (int i = v1; i &lt;= v2; i++) {</span>
<span class="nc" id="L236">			final char c = (char) i;</span>
<span class="nc" id="L237">			final boolean ok = fc.isCharOk(c);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">			if (ok) {</span>
<span class="nc" id="L239">				fc.printChar(pw, c);</span>
<span class="nc" id="L240">				final String desc = fc.getCharDescVerbose(c);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">				for (String n : allFontNames) {</span>
<span class="nc" id="L242">					final FontChecker other = new FontChecker(UFontFactory.build(n, Font.PLAIN, size));</span>
<span class="nc" id="L243">					final String descOther = other.getCharDescVerbose(c);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">					if (desc.equals(descOther)) {</span>
<span class="nc" id="L245">						pw.println(&quot;&amp;nbsp;&quot;);</span>
<span class="nc" id="L246">						pw.println(n);</span>
					}
				}
<span class="nc" id="L249">				pw.println(&quot;&lt;/p&gt;&quot;);</span>

			}
		}
<span class="nc" id="L253">		pw.println(&quot;&lt;/html&gt;&quot;);</span>
<span class="nc" id="L254">		pw.close();</span>

<span class="nc" id="L256">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>