<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PSystemCommandFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">plantuml</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.plantuml.command</a> &gt; <span class="el_source">PSystemCommandFactory.java</span></div><h1>PSystemCommandFactory.java</h1><pre class="source lang-java linenums">/* ========================================================================
 * PlantUML : a free UML diagram generator
 * ========================================================================
 *
 * (C) Copyright 2009-2024, Arnaud Roques
 *
 * Project Info:  https://plantuml.com
 *
 * If you like this project or if you find it useful, you can support us at:
 *
 * https://plantuml.com/patreon (only 1$ per month!)
 * https://plantuml.com/paypal
 *
 * This file is part of PlantUML.
 *
 * PlantUML is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * PlantUML distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
 * License for more details.
 *
 * You should have received a copy of the GNU General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301,
 * USA.
 *
 *
 * Original Author:  Arnaud Roques
 *
 *
 */
package net.sourceforge.plantuml.command;

import java.util.ArrayList;
import java.util.List;
import java.util.Set;

import net.sourceforge.plantuml.AbstractPSystem;
import net.sourceforge.plantuml.EmbeddedDiagram;
import net.sourceforge.plantuml.ErrorUml;
import net.sourceforge.plantuml.ErrorUmlType;
import net.sourceforge.plantuml.Previous;
import net.sourceforge.plantuml.core.Diagram;
import net.sourceforge.plantuml.core.DiagramType;
import net.sourceforge.plantuml.core.UmlSource;
import net.sourceforge.plantuml.error.PSystemError;
import net.sourceforge.plantuml.error.PSystemErrorUtils;
import net.sourceforge.plantuml.nio.PathSystem;
import net.sourceforge.plantuml.preproc.PreprocessingArtifact;
import net.sourceforge.plantuml.text.StringLocated;
import net.sourceforge.plantuml.utils.BlocLines;
import net.sourceforge.plantuml.utils.LineLocation;
import net.sourceforge.plantuml.utils.StartUtils;
import net.sourceforge.plantuml.version.IteratorCounter2;

public abstract class PSystemCommandFactory extends PSystemAbstractFactory {

<span class="fc" id="L62">	private final List&lt;Command&gt; cmds = new ArrayList&lt;&gt;();</span>

	protected abstract void initCommandsList(List&lt;Command&gt; cmds);

	public abstract AbstractPSystem createEmptyDiagram(PathSystem pathSystem, UmlSource source, Previous previous, PreprocessingArtifact preprocessing);

	protected PSystemCommandFactory() {
<span class="fc" id="L69">		this(DiagramType.UML);</span>
<span class="fc" id="L70">	}</span>

	protected PSystemCommandFactory(DiagramType type) {
<span class="fc" id="L73">		super(type);</span>
<span class="fc" id="L74">	}</span>

	@Override
	final public Diagram createSystem(PathSystem pathSystem, UmlSource source, Previous previous, PreprocessingArtifact preprocessing) {
<span class="fc" id="L78">		IteratorCounter2 it = source.iterator2();</span>
<span class="fc" id="L79">		final StringLocated startLine = it.next();</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">		if (StartUtils.isArobaseStartDiagram(startLine.getString()) == false)</span>
<span class="nc" id="L81">			throw new UnsupportedOperationException();</span>

<span class="fc bfc" id="L83" title="All 2 branches covered.">		if (source.isEmpty()) {</span>
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">			if (it.hasNext())</span>
<span class="fc" id="L85">				it.next();</span>

<span class="fc" id="L87">			return buildEmptyError(source, startLine.getLocation(), it.getTrace(), preprocessing);</span>
		}
<span class="fc" id="L89">		AbstractPSystem sys = createEmptyDiagram(pathSystem, source, previous, preprocessing);</span>

<span class="fc" id="L91">		final Set&lt;ParserPass&gt; requiredPass = sys.getRequiredPass();</span>

<span class="fc bfc" id="L93" title="All 2 branches covered.">		for (ParserPass pass : requiredPass) {</span>
<span class="fc" id="L94">			sys.startingPass(pass);</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">			while (it.hasNext()) {</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">				if (StartUtils.isArobaseEndDiagram(it.peek().getString())) {</span>
<span class="fc" id="L97">					it = source.iterator2();</span>
<span class="fc" id="L98">					it.next();</span>
					// For next pass
<span class="fc" id="L100">					break;</span>
				}
<span class="fc" id="L102">				sys = executeFewLines(sys, source, it, pass, preprocessing);</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">				if (sys instanceof PSystemError)</span>
<span class="fc" id="L104">					return sys;</span>
			}
<span class="fc" id="L106">		}</span>
<span class="fc" id="L107">		return finalizeDiagram(sys, source, it, preprocessing);</span>

	}

	private Diagram finalizeDiagram(AbstractPSystem sys, UmlSource source, IteratorCounter2 it, PreprocessingArtifact preprocessing) {
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">		if (sys == null)</span>
<span class="nc" id="L113">			return null;</span>

<span class="fc" id="L115">		final String err = sys.checkFinalError();</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">		if (err != null) {</span>
<span class="nc" id="L117">			final LineLocation location = it.next().getLocation();</span>
<span class="nc" id="L118">			return buildExecutionError(source, err, location, it.getTrace(), preprocessing);</span>
		}
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">		if (source.getTotalLineCount() == 2) {</span>
<span class="nc" id="L121">			final LineLocation location = it.next().getLocation();</span>
<span class="nc" id="L122">			return buildEmptyError(source, location, it.getTrace(), preprocessing);</span>
		}
<span class="fc" id="L124">		sys.makeDiagramReady();</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">		if (sys.isOk() == false)</span>
<span class="fc" id="L126">			return null;</span>

<span class="fc" id="L128">		return sys;</span>
	}

	private AbstractPSystem executeFewLines(AbstractPSystem sys, UmlSource source, final IteratorCounter2 it,
			ParserPass currentPass, PreprocessingArtifact preprocessing) {
<span class="fc" id="L133">		final Step step = getCandidate(it);</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">		if (step == null) {</span>
<span class="fc" id="L135">			final ErrorUml err = new ErrorUml(ErrorUmlType.SYNTAX_ERROR, &quot;Syntax Error?&quot;, 0, it.peek().getLocation(), getUmlDiagramType());</span>
<span class="fc" id="L136">			it.next();</span>
<span class="fc" id="L137">			return PSystemErrorUtils.buildV2(source, err, null, it.getTrace(), preprocessing);</span>
		}

<span class="fc bfc" id="L140" title="All 2 branches covered.">		if (step.command.isEligibleFor(currentPass) == false)</span>
<span class="fc" id="L141">			return sys;</span>

<span class="fc" id="L143">		final CommandExecutionResult result = sys.executeCommand(step.command, step.blocLines, currentPass);</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">		if (result.isOk() == false) {</span>
<span class="fc" id="L145">			final LineLocation location = ((StringLocated) step.blocLines.getFirst()).getLocation();</span>
<span class="fc" id="L146">			final ErrorUml err = new ErrorUml(ErrorUmlType.EXECUTION_ERROR, result.getError(), result.getScore(),</span>
<span class="fc" id="L147">					location, getUmlDiagramType());</span>
<span class="fc" id="L148">			sys = PSystemErrorUtils.buildV2(source, err, result.getDebugLines(), it.getTrace(), preprocessing);</span>
		}
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">		if (result.getNewDiagram() != null)</span>
<span class="nc" id="L151">			sys = result.getNewDiagram();</span>

<span class="fc" id="L153">		return sys;</span>

	}

	static class Step {
		final Command command;
		final BlocLines blocLines;

<span class="fc" id="L161">		Step(Command command, BlocLines blocLines) {</span>
<span class="fc" id="L162">			this.command = command;</span>
<span class="fc" id="L163">			this.blocLines = blocLines;</span>
<span class="fc" id="L164">		}</span>

	}

	private Step getCandidate(final IteratorCounter2 it) {
<span class="fc" id="L169">		final BlocLines single = BlocLines.single(it.peek());</span>
<span class="fc" id="L170">		synchronized (cmds) {</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">			if (cmds.size() == 0)</span>
<span class="fc" id="L172">				initCommandsList(cmds);</span>
<span class="fc" id="L173">		}</span>

<span class="fc bfc" id="L175" title="All 2 branches covered.">		for (Command cmd : cmds) {</span>
<span class="fc" id="L176">			final CommandControl result = cmd.isValid(single);</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">			if (result == CommandControl.OK) {</span>
<span class="fc" id="L178">				it.next();</span>
<span class="fc" id="L179">				return new Step(cmd, single);</span>
			}
<span class="fc bfc" id="L181" title="All 2 branches covered.">			if (result == CommandControl.OK_PARTIAL) {</span>
<span class="fc" id="L182">				final IteratorCounter2 cloned = it.cloneMe();</span>
<span class="fc" id="L183">				final BlocLines lines = isMultilineCommandOk(cloned, cmd);</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">				if (lines == null)</span>
<span class="fc" id="L185">					continue;</span>

<span class="fc" id="L187">				it.copyStateFrom(cloned);</span>
<span class="fc" id="L188">				return new Step(cmd, lines);</span>
			}
<span class="fc" id="L190">		}</span>
<span class="fc" id="L191">		return null;</span>
	}

	private BlocLines isMultilineCommandOk(IteratorCounter2 it, Command cmd) {
<span class="fc" id="L195">		BlocLines lines = BlocLines.create();</span>
<span class="fc" id="L196">		int nb = 0;</span>
<span class="fc bfc" id="L197" title="All 2 branches covered.">		while (it.hasNext()) {</span>
<span class="fc" id="L198">			lines = addOneSingleLineManageEmbedded2(it, lines);</span>
<span class="fc" id="L199">			final CommandControl result = cmd.isValid(lines);</span>
<span class="fc bfc" id="L200" title="All 2 branches covered.">			if (result == CommandControl.NOT_OK)</span>
<span class="fc" id="L201">				return null;</span>

<span class="fc bfc" id="L203" title="All 2 branches covered.">			if (result == CommandControl.OK)</span>
<span class="fc" id="L204">				return lines;</span>

<span class="fc" id="L206">			nb++;</span>
<span class="pc bpc" id="L207" title="1 of 4 branches missed.">			if (cmd instanceof CommandDecoratorMultine &amp;&amp; nb &gt; ((CommandDecoratorMultine) cmd).getNbMaxLines())</span>
<span class="nc" id="L208">				return null;</span>

<span class="fc" id="L210">		}</span>
<span class="fc" id="L211">		return null;</span>
	}

	private static BlocLines addOneSingleLineManageEmbedded2(IteratorCounter2 it, BlocLines lines) {
<span class="fc" id="L215">		final StringLocated linetoBeAdded = it.next();</span>
<span class="fc" id="L216">		lines = lines.add(linetoBeAdded);</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">		if (EmbeddedDiagram.getEmbeddedType(linetoBeAdded.getTrimmed().getString()) != null) {</span>
<span class="fc" id="L218">			int nested = 1;</span>
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">			while (it.hasNext()) {</span>
<span class="fc" id="L220">				final StringLocated s = it.next();</span>
<span class="fc" id="L221">				lines = lines.add(s);</span>
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">				if (EmbeddedDiagram.getEmbeddedType(s.getTrimmed().getString()) != null)</span>
					// if (s.getTrimmed().getString().startsWith(EmbeddedDiagram.EMBEDDED_START))
<span class="nc" id="L224">					nested++;</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">				else if (s.getTrimmed().getString().equals(EmbeddedDiagram.EMBEDDED_END)) {</span>
<span class="fc" id="L226">					nested--;</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">					if (nested == 0)</span>
<span class="fc" id="L228">						return lines;</span>
				}
<span class="fc" id="L230">			}</span>
		}

<span class="fc" id="L233">		return lines;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>