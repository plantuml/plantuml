<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EpsGraphics.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">plantuml</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.plantuml.klimt.drawing.eps</a> &gt; <span class="el_source">EpsGraphics.java</span></div><h1>EpsGraphics.java</h1><pre class="source lang-java linenums">/* ========================================================================
 * PlantUML : a free UML diagram generator
 * ========================================================================
 *
 * (C) Copyright 2009-2024, Arnaud Roques
 *
 * Project Info:  https://plantuml.com
 * 
 * If you like this project or if you find it useful, you can support us at:
 * 
 * https://plantuml.com/patreon (only 1$ per month!)
 * https://plantuml.com/paypal
 * 
 * This file is part of PlantUML.
 *
 * PlantUML is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * PlantUML distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
 * License for more details.
 *
 * You should have received a copy of the GNU General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301,
 * USA.
 *
 *
 * Original Author:  Arnaud Roques
 * 
 *
 */
package net.sourceforge.plantuml.klimt.drawing.eps;


import java.awt.geom.PathIterator;
import java.util.List;
import java.util.Locale;
import java.util.StringTokenizer;

import net.sourceforge.plantuml.klimt.UPath;
import net.sourceforge.plantuml.klimt.awt.PortableImage;
import net.sourceforge.plantuml.klimt.awt.XColor;
import net.sourceforge.plantuml.klimt.color.ColorMapper;
import net.sourceforge.plantuml.klimt.color.HColorGradient;
import net.sourceforge.plantuml.klimt.geom.USegment;
import net.sourceforge.plantuml.klimt.geom.USegmentType;
import net.sourceforge.plantuml.klimt.geom.XCubicCurve2D;
import net.sourceforge.plantuml.klimt.shape.DotPath;
import net.sourceforge.plantuml.security.SecurityUtils;
import net.sourceforge.plantuml.text.BackSlash;
import net.sourceforge.plantuml.utils.Log;
import net.sourceforge.plantuml.utils.MathUtils;
import net.sourceforge.plantuml.version.Version;

<span class="fc" id="L59">public class EpsGraphics {</span>
	// ::remove folder when __CORE__

	public static final String END_OF_FILE = &quot;%plantuml done&quot;;
	protected static final long COEF = 100L;

	// http://www.linuxfocus.org/Francais/May1998/article43.html
	// http://www.tailrecursive.org/postscript/text.html
<span class="fc" id="L67">	private final StringBuilder body = new StringBuilder();</span>
<span class="fc" id="L68">	private final StringBuilder header = new StringBuilder();</span>

<span class="fc" id="L70">	private XColor color = XColor.BLACK;</span>
<span class="fc" id="L71">	private XColor fillcolor = XColor.BLACK;</span>

<span class="fc" id="L73">	private String strokeWidth = format(1);</span>
	// private String strokeDasharray = null;

<span class="fc" id="L76">	private final PostScriptCommandMacro setcolorgradient = new PostScriptCommandMacro(&quot;setcolorgradient&quot;);</span>
<span class="fc" id="L77">	private final PostScriptCommandMacro simplerect = new PostScriptCommandMacro(&quot;simplerect&quot;);</span>
<span class="fc" id="L78">	private final PostScriptCommandMacro roundrect = new PostScriptCommandMacro(&quot;roundrect&quot;);</span>
<span class="fc" id="L79">	private boolean setcolorgradientUsed = false;</span>
<span class="fc" id="L80">	private boolean simplerectUsed = false;</span>
<span class="fc" id="L81">	private boolean roundrectUsed = false;</span>

<span class="fc" id="L83">	public EpsGraphics() {</span>
<span class="fc" id="L84">		header.append(&quot;%!PS-Adobe-3.0 EPSF-3.0\n&quot;);</span>
<span class="fc" id="L85">		header.append(&quot;%%Creator: PlantUML v&quot; + Version.versionString(15) + BackSlash.NEWLINE);</span>
<span class="fc" id="L86">		header.append(&quot;%%Title: noTitle\n&quot;);</span>
		// header.append(&quot;%%CreationDate: &quot; + new Date() + BackSlash.BS_N);
<span class="fc" id="L88">		setcolorgradient.add(new PostScriptCommandRaw(&quot;3 index 7 index sub 1 index mul 7 index add&quot;, true));</span>
<span class="fc" id="L89">		setcolorgradient.add(new PostScriptCommandRaw(&quot;3 index 7 index sub 2 index mul 7 index add&quot;, true));</span>
<span class="fc" id="L90">		setcolorgradient.add(new PostScriptCommandRaw(&quot;3 index 7 index sub 3 index mul 7 index add&quot;, true));</span>
<span class="fc" id="L91">		setcolorgradient.add(new PostScriptCommandRaw(&quot;setrgbcolor&quot;, true));</span>
		// setcolorgradient.add(new PostScriptCommandRaw(&quot;0 7 1 {pop} for&quot;));
<span class="fc" id="L93">		setcolorgradient.add(new PostScriptCommandRaw(&quot;pop pop pop pop pop pop pop &quot;, true));</span>

<span class="fc" id="L95">		simplerect.add(new PostScriptCommandRaw(&quot;newpath moveto 1 index 0 rlineto&quot;, true));</span>
<span class="fc" id="L96">		simplerect.add(new PostScriptCommandRaw(&quot;0 exch rlineto&quot;, true));</span>
<span class="fc" id="L97">		simplerect.add(new PostScriptCommandRaw(&quot;neg 0 rlineto&quot;, true));</span>

<span class="fc" id="L99">		roundrect.add(new PostScriptCommandRaw(&quot;newpath&quot;, true));</span>
<span class="fc" id="L100">		roundrect.add(new PostScriptCommandRaw(&quot;dup 3 index add 2 index 2 index add 2 index 180 270 arc&quot;, true));</span>
<span class="fc" id="L101">		roundrect.add(new PostScriptCommandRaw(&quot;2 index 5 index add 1 index sub 2 index 2 index add 2 index 270 0 arc&quot;,</span>
				true));
<span class="fc" id="L103">		roundrect.add(new PostScriptCommandRaw(</span>
				&quot;2 index 5 index add 1 index sub 2 index 5 index add 2 index sub 2 index 0 90 arc&quot;, true));
<span class="fc" id="L105">		roundrect.add(</span>
				new PostScriptCommandRaw(&quot;dup 3 index add 2 index 5 index add 2 index sub 2 index 90 180 arc&quot;, true));
<span class="fc" id="L107">		roundrect.add(new PostScriptCommandRaw(&quot;pop pop pop pop pop &quot;, true));</span>
<span class="fc" id="L108">	}</span>

<span class="fc" id="L110">	private boolean closeDone = false;</span>

<span class="fc" id="L112">	private int maxX = 10;</span>
<span class="fc" id="L113">	private int maxY = 10;</span>

	final protected void ensureVisible(double x, double y) {
<span class="fc bfc" id="L116" title="All 2 branches covered.">		if (x &gt; maxX)</span>
<span class="fc" id="L117">			maxX = (int) (x + 1);</span>

<span class="fc bfc" id="L119" title="All 2 branches covered.">		if (y &gt; maxY)</span>
<span class="fc" id="L120">			maxY = (int) (y + 1);</span>

<span class="pc bpc" id="L122" title="1 of 2 branches missed.">		if (urlArea != null)</span>
<span class="nc" id="L123">			urlArea.ensureVisible((int) Math.round(x), (int) Math.round(y));</span>

<span class="fc" id="L125">	}</span>

	protected final XColor getColor() {
<span class="fc" id="L128">		return color;</span>
	}

	final public void close() {
<span class="fc" id="L132">		checkCloseDone();</span>

<span class="fc" id="L134">		header.append(&quot;%%BoundingBox: 0 0 &quot; + maxX + &quot; &quot; + maxY + BackSlash.NEWLINE);</span>
		// header.append(&quot;%%DocumentData: Clean7Bit\n&quot;);
		// header.append(&quot;%%DocumentProcessColors: Black\n&quot;);
<span class="fc" id="L137">		header.append(&quot;%%ColorUsage: Color\n&quot;);</span>
<span class="fc" id="L138">		header.append(&quot;%%Origin: 0 0\n&quot;);</span>
<span class="fc" id="L139">		header.append(&quot;%%EndComments\n\n&quot;);</span>
<span class="fc" id="L140">		header.append(&quot;gsave\n&quot;);</span>
<span class="fc" id="L141">		header.append(&quot;0 &quot; + maxY + &quot; translate\n&quot;);</span>
<span class="fc" id="L142">		header.append(&quot;.01 -.01 scale\n&quot;);</span>

<span class="pc bpc" id="L144" title="1 of 2 branches missed.">		if (setcolorgradientUsed)</span>
<span class="nc" id="L145">			header.append(setcolorgradient.getPostStringDefinition());</span>

<span class="pc bpc" id="L147" title="1 of 2 branches missed.">		if (simplerectUsed)</span>
<span class="nc" id="L148">			header.append(simplerect.getPostStringDefinition());</span>

<span class="pc bpc" id="L150" title="1 of 2 branches missed.">		if (roundrectUsed)</span>
<span class="fc" id="L151">			header.append(roundrect.getPostStringDefinition());</span>

<span class="fc" id="L153">		append(&quot;grestore&quot;, true);</span>

		// if(isClipSet())
		// writer.write(&quot;grestore\n&quot;);

<span class="fc" id="L158">		append(&quot;showpage&quot;, true);</span>
<span class="fc" id="L159">		append(END_OF_FILE, true);</span>
<span class="fc" id="L160">		append(&quot;%%EOF&quot;, true);</span>
<span class="fc" id="L161">		closeDone = true;</span>
<span class="fc" id="L162">	}</span>

	private void checkCloseDone() {
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">		if (closeDone)</span>
<span class="nc" id="L166">			throw new IllegalStateException();</span>

<span class="fc" id="L168">	}</span>

	final public String getEPSCode() {
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">		if (closeDone == false)</span>
<span class="fc" id="L172">			close();</span>

<span class="fc" id="L174">		return header.toString() + getBodyString();</span>
	}

	protected String getBodyString() {
<span class="nc" id="L178">		return body.toString();</span>
	}

	public final void setStrokeColor(XColor c) {
<span class="fc" id="L182">		checkCloseDone();</span>
<span class="fc" id="L183">		this.color = c;</span>
<span class="fc" id="L184">	}</span>

	final public void setFillColor(XColor c) {
<span class="fc" id="L187">		checkCloseDone();</span>
<span class="fc" id="L188">		this.fillcolor = c;</span>
<span class="fc" id="L189">	}</span>

	public final void setStrokeWidth(double strokeWidth, double dashVisible, double dashSpace) {
<span class="fc" id="L192">		checkCloseDone();</span>
<span class="fc" id="L193">		this.strokeWidth = format(strokeWidth);</span>
<span class="fc" id="L194">		this.dashVisible = (long) (dashVisible * COEF);</span>
<span class="fc" id="L195">		this.dashSpace = (long) (dashSpace * COEF);</span>
<span class="fc" id="L196">	}</span>

<span class="fc" id="L198">	private long dashVisible = 0;</span>
<span class="fc" id="L199">	private long dashSpace = 0;</span>

	final public void newpathDot() {
<span class="nc" id="L202">		final boolean dashed = isDashed();</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">		if (isNull(color))</span>
<span class="nc" id="L204">			throw new IllegalStateException();</span>

<span class="nc" id="L206">		checkCloseDone();</span>
<span class="nc" id="L207">		append(strokeWidth + &quot; setlinewidth&quot;, true);</span>
<span class="nc" id="L208">		appendColor(color);</span>

<span class="nc bnc" id="L210" title="All 2 branches missed.">		if (dashed)</span>
<span class="nc" id="L211">			append(&quot;[&quot; + dashSpace + &quot; &quot; + dashVisible + &quot;] 0 setdash&quot;, true);</span>

<span class="nc" id="L213">		append(&quot;newpath&quot;, true);</span>
<span class="nc" id="L214">	}</span>

	private boolean isDashed() {
<span class="nc bnc" id="L217" title="All 4 branches missed.">		return dashVisible != 0 || dashSpace != 0;</span>
	}

	private boolean isDashed2() {
<span class="pc bpc" id="L221" title="1 of 4 branches missed.">		return dashVisible == 0 || dashSpace == 0;</span>
	}

	private boolean isDashed3() {
<span class="pc bpc" id="L225" title="3 of 4 branches missed.">		return dashSpace != 0 &amp;&amp; dashVisible != 0;</span>
	}

	final public void closepathDot() {
<span class="nc" id="L229">		final boolean dashed = isDashed();</span>
<span class="nc" id="L230">		append(&quot;stroke&quot;, true);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">		if (dashed)</span>
<span class="nc" id="L232">			append(&quot;[] 0 setdash&quot;, true);</span>

<span class="nc" id="L234">	}</span>

	final public void epsLine(double x1, double y1, double x2, double y2) {
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">		if (isNull(color))</span>
<span class="nc" id="L238">			throw new IllegalStateException();</span>
<span class="fc" id="L239">		ensureVisible(x1, y1);</span>
<span class="fc" id="L240">		ensureVisible(x2, y2);</span>
<span class="fc" id="L241">		checkCloseDone();</span>
<span class="fc" id="L242">		append(strokeWidth + &quot; setlinewidth&quot;, true);</span>
<span class="fc" id="L243">		appendColor(color);</span>
<span class="fc" id="L244">		append(&quot;newpath&quot;, true);</span>
<span class="fc bfc" id="L245" title="All 2 branches covered.">		if (isDashed2()) {</span>
<span class="fc" id="L246">			append(format(x1) + &quot; &quot; + format(y1) + &quot; moveto&quot;, true);</span>
<span class="fc" id="L247">			append(format(x2 - x1) + &quot; &quot; + format(y2 - y1) + &quot; rlineto&quot;, true);</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">		} else if (x1 == x2) {</span>
<span class="fc" id="L249">			epsHLine(x1, Math.min(y1, y2), Math.max(y1, y2));</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">		} else if (y1 == y2) {</span>
<span class="nc" id="L251">			epsVLine(y1, Math.min(x1, x2), Math.max(x1, x2));</span>
		}
<span class="fc" id="L253">		append(&quot;stroke&quot;, true);</span>
<span class="fc" id="L254">		ensureVisible(Math.max(x1, x2), Math.max(y1, y2));</span>
<span class="fc" id="L255">	}</span>

	protected void epsHLine(final double x, final double ymin, final double ymax) {
<span class="nc" id="L258">		append(format(x) + &quot; &quot; + format(ymin) + &quot; moveto&quot;, true);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">		for (long y2 = (long) (ymin * COEF); y2 &lt; (long) (ymax * COEF); y2 += (dashVisible + dashSpace)) {</span>
			final long v;
<span class="nc bnc" id="L261" title="All 2 branches missed.">			if (y2 + dashVisible &gt; (long) (ymax * COEF))</span>
<span class="nc" id="L262">				v = y2 - (long) (ymax * COEF);</span>
			else
<span class="nc" id="L264">				v = dashSpace;</span>

<span class="nc" id="L266">			append(&quot;0 &quot; + v + &quot; rlineto&quot;, true);</span>
<span class="nc" id="L267">			append(&quot;0 &quot; + dashSpace + &quot; rmoveto&quot;, true);</span>
		}
<span class="nc" id="L269">	}</span>

	protected void epsVLine(final double y, final double xmin, final double xmax) {
<span class="nc" id="L272">		append(format(xmin) + &quot; &quot; + format(y) + &quot; moveto&quot;, true);</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">		for (long x2 = (long) (xmin * COEF); x2 &lt; (long) (xmax * COEF); x2 += (dashVisible + dashSpace)) {</span>
			final long v;
<span class="nc bnc" id="L275" title="All 2 branches missed.">			if (x2 + dashVisible &gt; (long) (xmax * COEF))</span>
<span class="nc" id="L276">				v = x2 - (long) (xmax * COEF);</span>
			else
<span class="nc" id="L278">				v = dashSpace;</span>

<span class="nc" id="L280">			append(&quot;&quot; + v + &quot; 0 rlineto&quot;, true);</span>
<span class="nc" id="L281">			append(&quot;&quot; + dashSpace + &quot; 0 rmoveto&quot;, true);</span>
		}
<span class="nc" id="L283">	}</span>

	final public void epsPath(double x, double y, UPath path) {
<span class="nc" id="L286">		checkCloseDone();</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">		if (isNull(fillcolor) == false) {</span>
<span class="nc" id="L288">			appendColor(fillcolor);</span>
<span class="nc" id="L289">			append(&quot;newpath&quot;, true);</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">			for (USegment seg : path) {</span>
<span class="nc" id="L291">				final USegmentType type = seg.getSegmentType();</span>
<span class="nc" id="L292">				final double coord[] = seg.getCoord();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">				if (type == USegmentType.SEG_MOVETO) {</span>
<span class="nc" id="L294">					movetoNoMacro(coord[0] + x, coord[1] + y);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">				} else if (type == USegmentType.SEG_LINETO) {</span>
<span class="nc" id="L296">					linetoNoMacro(coord[0] + x, coord[1] + y);</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">				} else if (type == USegmentType.SEG_QUADTO) {</span>
<span class="nc" id="L298">					throw new UnsupportedOperationException();</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">				} else if (type == USegmentType.SEG_CUBICTO) {</span>
<span class="nc" id="L300">					curvetoNoMacro(coord[0] + x, coord[1] + y, coord[2] + x, coord[3] + y, coord[4] + x, coord[5] + y);</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">				} else if (type == USegmentType.SEG_CLOSE) {</span>
					// Nothing
<span class="nc bnc" id="L303" title="All 2 branches missed.">				} else if (type == USegmentType.SEG_ARCTO) {</span>
<span class="nc" id="L304">					linetoNoMacro(coord[5] + x, coord[6] + y);</span>
				} else {
<span class="nc" id="L306">					Log.println(&quot;unknown1 &quot; + seg);</span>
				}
<span class="nc" id="L308">			}</span>
<span class="nc" id="L309">			append(&quot;closepath eofill&quot;, true);</span>
		}

<span class="nc bnc" id="L312" title="All 2 branches missed.">		if (isNull(color) == false) {</span>
<span class="nc" id="L313">			append(strokeWidth + &quot; setlinewidth&quot;, true);</span>
<span class="nc" id="L314">			appendColor(color);</span>
<span class="nc" id="L315">			append(&quot;newpath&quot;, true);</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">			for (USegment seg : path) {</span>
<span class="nc" id="L317">				final USegmentType type = seg.getSegmentType();</span>
<span class="nc" id="L318">				final double coord[] = seg.getCoord();</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">				if (type == USegmentType.SEG_MOVETO) {</span>
<span class="nc" id="L320">					movetoNoMacro(coord[0] + x, coord[1] + y);</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">				} else if (type == USegmentType.SEG_LINETO) {</span>
<span class="nc" id="L322">					linetoNoMacro(coord[0] + x, coord[1] + y);</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">				} else if (type == USegmentType.SEG_QUADTO) {</span>
<span class="nc" id="L324">					throw new UnsupportedOperationException();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">				} else if (type == USegmentType.SEG_CUBICTO) {</span>
<span class="nc" id="L326">					curvetoNoMacro(coord[0] + x, coord[1] + y, coord[2] + x, coord[3] + y, coord[4] + x, coord[5] + y);</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">				} else if (type == USegmentType.SEG_CLOSE) {</span>
					// Nothing
<span class="nc bnc" id="L329" title="All 2 branches missed.">				} else if (type == USegmentType.SEG_ARCTO) {</span>
<span class="nc" id="L330">					linetoNoMacro(coord[5] + x, coord[6] + y);</span>
				} else {
<span class="nc" id="L332">					Log.println(&quot;unknown2 &quot; + seg);</span>
				}
<span class="nc" id="L334">			}</span>
<span class="nc" id="L335">			append(&quot;stroke&quot;, true);</span>
		}

<span class="nc" id="L338">	}</span>

	private final boolean isNull(XColor c) {
<span class="pc bpc" id="L341" title="1 of 4 branches missed.">		return c == null || c.getAlpha() == 0;</span>
	}

	final public void epsPolygon(HColorGradient gr, ColorMapper mapper, double... points) {
<span class="nc bnc" id="L345" title="All 2 branches missed.">		assert points.length % 2 == 0;</span>
<span class="nc" id="L346">		setFillColor(gr.getColor1().toColor(mapper));</span>
<span class="nc" id="L347">		epsPolygon(points);</span>
<span class="nc" id="L348">	}</span>

	final public void epsPolygon(double... points) {
<span class="pc bpc" id="L351" title="1 of 2 branches missed.">		assert points.length % 2 == 0;</span>
<span class="fc" id="L352">		checkCloseDone();</span>
<span class="fc" id="L353">		double lastX = 0;</span>
<span class="fc" id="L354">		double lastY = 0;</span>
<span class="pc bpc" id="L355" title="1 of 2 branches missed.">		if (isNull(fillcolor) == false) {</span>
<span class="fc" id="L356">			appendColor(fillcolor);</span>
<span class="fc" id="L357">			append(&quot;newpath&quot;, true);</span>
<span class="fc bfc" id="L358" title="All 2 branches covered.">			for (int i = 0; i &lt; points.length; i += 2) {</span>
<span class="fc" id="L359">				ensureVisible(points[i], points[i + 1]);</span>
<span class="fc bfc" id="L360" title="All 2 branches covered.">				if (i == 0)</span>
<span class="fc" id="L361">					append(format(points[i]) + &quot; &quot; + format(points[i + 1]) + &quot; moveto&quot;, true);</span>
				else
<span class="fc" id="L363">					append(format(points[i] - lastX) + &quot; &quot; + format(points[i + 1] - lastY) + &quot; rlineto&quot;, true);</span>

<span class="fc" id="L365">				lastX = points[i];</span>
<span class="fc" id="L366">				lastY = points[i + 1];</span>
			}
<span class="fc" id="L368">			append(format(points[0]) + &quot; &quot; + format(points[1]) + &quot; lineto&quot;, true);</span>
<span class="fc" id="L369">			append(&quot;closepath eofill&quot;, true);</span>
		}

<span class="pc bpc" id="L372" title="1 of 2 branches missed.">		if (isNull(color) == false) {</span>
<span class="fc" id="L373">			append(strokeWidth + &quot; setlinewidth&quot;, true);</span>
<span class="fc" id="L374">			appendColor(color);</span>
<span class="fc" id="L375">			append(&quot;newpath&quot;, true);</span>
<span class="fc bfc" id="L376" title="All 2 branches covered.">			for (int i = 0; i &lt; points.length; i += 2) {</span>
<span class="fc" id="L377">				ensureVisible(points[i], points[i + 1]);</span>
<span class="fc bfc" id="L378" title="All 2 branches covered.">				if (i == 0)</span>
<span class="fc" id="L379">					append(format(points[i]) + &quot; &quot; + format(points[i + 1]) + &quot; moveto&quot;, true);</span>
				else
<span class="fc" id="L381">					append(format(points[i] - lastX) + &quot; &quot; + format(points[i + 1] - lastY) + &quot; rlineto&quot;, true);</span>

<span class="fc" id="L383">				lastX = points[i];</span>
<span class="fc" id="L384">				lastY = points[i + 1];</span>
			}
<span class="fc" id="L386">			append(format(points[0]) + &quot; &quot; + format(points[1]) + &quot; lineto&quot;, true);</span>
<span class="fc" id="L387">			append(&quot;closepath stroke&quot;, true);</span>
		}

<span class="fc" id="L390">	}</span>

	final public void epsRectangle(double x, double y, double width, double height, double rx, double ry) {
<span class="fc" id="L393">		checkCloseDone();</span>
<span class="fc" id="L394">		ensureVisible(x, y);</span>
<span class="fc" id="L395">		ensureVisible(x + width, y + height);</span>
<span class="fc bfc" id="L396" title="All 2 branches covered.">		if (isNull(fillcolor) == false) {</span>
<span class="fc" id="L397">			appendColor(fillcolor);</span>
<span class="fc" id="L398">			epsRectangleInternal(x, y, width, height, rx, ry, true);</span>
<span class="fc" id="L399">			append(&quot;closepath eofill&quot;, true);</span>
<span class="pc bpc" id="L400" title="1 of 2 branches missed.">			if (isDashed3())</span>
<span class="nc" id="L401">				append(&quot;[] 0 setdash&quot;, true);</span>
		}

<span class="fc bfc" id="L404" title="All 2 branches covered.">		if (isNull(color) == false) {</span>
<span class="fc" id="L405">			append(strokeWidth + &quot; setlinewidth&quot;, true);</span>
<span class="fc" id="L406">			appendColor(color);</span>
<span class="fc" id="L407">			epsRectangleInternal(x, y, width, height, rx, ry, false);</span>
<span class="fc" id="L408">			append(&quot;closepath stroke&quot;, true);</span>
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">			if (isDashed3())</span>
<span class="nc" id="L410">				append(&quot;[] 0 setdash&quot;, true);</span>

		}
<span class="fc" id="L413">	}</span>

	final public void epsRectangle(double x, double y, double width, double height, double rx, double ry,
			HColorGradient gr, ColorMapper mapper) {
<span class="nc bnc" id="L417" title="All 2 branches missed.">		if (isNull(color))</span>
<span class="nc" id="L418">			throw new IllegalStateException();</span>
<span class="nc" id="L419">		checkCloseDone();</span>
<span class="nc" id="L420">		ensureVisible(x, y);</span>
<span class="nc" id="L421">		ensureVisible(x + width, y + height);</span>
<span class="nc" id="L422">		setcolorgradientUsed = true;</span>

<span class="nc bnc" id="L424" title="All 4 branches missed.">		if (rx == 0 &amp;&amp; ry == 0) {</span>
<span class="nc" id="L425">			simplerectUsed = true;</span>
<span class="nc" id="L426">			appendColorShort(gr.getColor1().toColor(mapper));</span>
<span class="nc" id="L427">			appendColorShort(gr.getColor2().toColor(mapper));</span>
<span class="nc" id="L428">			append(format(width) + &quot; &quot; + format(height) + &quot; &quot; + format(x) + &quot; &quot; + format(y), true);</span>
<span class="nc" id="L429">			append(&quot;100 -1 1 {&quot;, true);</span>
<span class="nc" id="L430">			append(&quot;100 div&quot;, true);</span>
<span class="nc" id="L431">			append(&quot;newpath&quot;, true);</span>
<span class="nc" id="L432">			append(&quot;2 index 2 index moveto&quot;, true);</span>
<span class="nc" id="L433">			append(&quot;dup 5 index mul 2 mul dup 0 rlineto&quot;, true);</span>
<span class="nc" id="L434">			append(&quot;neg 4 index 2 index mul 2 mul rlineto&quot;, true);</span>
<span class="nc" id="L435">			append(&quot;closepath eoclip&quot;, true);</span>
<span class="nc" id="L436">			append(&quot;10 index 10 index 10 index&quot;, true);</span>
<span class="nc" id="L437">			append(&quot;10 index 10 index 10 index&quot;, true);</span>
<span class="nc" id="L438">			append(&quot;6 index setcolorgradient&quot;, true);</span>
<span class="nc" id="L439">			append(&quot;4 index 4 index 4 index 4 index simplerect&quot;, true);</span>
<span class="nc" id="L440">			append(&quot;closepath eofill&quot;, true);</span>
<span class="nc" id="L441">			append(&quot;pop&quot;, true);</span>
<span class="nc" id="L442">			append(&quot;} for&quot;, true);</span>
<span class="nc" id="L443">			append(&quot;pop pop pop pop&quot;, true);</span>
<span class="nc" id="L444">			append(&quot;pop pop pop&quot;, true);</span>
<span class="nc" id="L445">			append(&quot;pop pop pop&quot;, true);</span>
<span class="nc" id="L446">			append(&quot;initclip&quot;, true);</span>
		} else {
<span class="nc" id="L448">			roundrectUsed = true;</span>
<span class="nc" id="L449">			appendColorShort(gr.getColor1().toColor(mapper));</span>
<span class="nc" id="L450">			appendColorShort(gr.getColor2().toColor(mapper));</span>
<span class="nc" id="L451">			append(format(width) + &quot; &quot; + format(height) + &quot; &quot; + format(x) + &quot; &quot; + format(y) + &quot; &quot;</span>
<span class="nc" id="L452">					+ format((rx + ry) / 2), true);</span>
<span class="nc" id="L453">			append(&quot;100 -1 1 {&quot;, true);</span>
<span class="nc" id="L454">			append(&quot;100 div&quot;, true);</span>
<span class="nc" id="L455">			append(&quot;newpath&quot;, true);</span>
<span class="nc" id="L456">			append(&quot;3 index 3 index moveto&quot;, true);</span>
<span class="nc" id="L457">			append(&quot;dup 6 index mul 2 mul dup 0 rlineto&quot;, true);</span>
<span class="nc" id="L458">			append(&quot;neg 5 index 2 index mul 2 mul rlineto&quot;, true);</span>
<span class="nc" id="L459">			append(&quot;closepath eoclip&quot;, true);</span>
<span class="nc" id="L460">			append(&quot;11 index 11 index 11 index&quot;, true);</span>
<span class="nc" id="L461">			append(&quot;11 index 11 index 11 index&quot;, true);</span>
<span class="nc" id="L462">			append(&quot;6 index setcolorgradient&quot;, true);</span>
<span class="nc" id="L463">			append(&quot;5 index 5 index 5 index 5 index 5 index roundrect&quot;, true);</span>
<span class="nc" id="L464">			append(&quot;closepath eofill&quot;, true);</span>
<span class="nc" id="L465">			append(&quot;pop&quot;, true);</span>
<span class="nc" id="L466">			append(&quot;} for&quot;, true);</span>
<span class="nc" id="L467">			append(&quot;pop pop pop pop pop&quot;, true);</span>
<span class="nc" id="L468">			append(&quot;pop pop pop&quot;, true);</span>
<span class="nc" id="L469">			append(&quot;pop pop pop&quot;, true);</span>
<span class="nc" id="L470">			append(&quot;initclip&quot;, true);</span>
		}
<span class="nc" id="L472">	}</span>

	private void epsRectangleInternal(double x, double y, double width, double height, double rx, double ry,
			boolean fill) {
<span class="pc bpc" id="L476" title="3 of 4 branches missed.">		if (rx == 0 &amp;&amp; ry == 0)</span>
<span class="nc" id="L477">			simpleRectangle(x, y, width, height, fill);</span>
		else
<span class="fc" id="L479">			roundRectangle(x, y, width, height, rx, ry);</span>

<span class="fc" id="L481">	}</span>

	private void roundRectangle(double x, double y, double width, double height, double rx, double ry) {
<span class="pc bpc" id="L484" title="1 of 2 branches missed.">		if (isDashed3())</span>
<span class="nc" id="L485">			append(&quot;[&quot; + dashSpace + &quot; &quot; + dashVisible + &quot;] 0 setdash&quot;, true);</span>

<span class="fc" id="L487">		final double round = MathUtils.min((rx + ry) / 2, width / 2, height / 2);</span>
<span class="fc" id="L488">		append(format(width) + &quot; &quot; + format(height) + &quot; &quot; + format(x) + &quot; &quot; + format(y) + &quot; &quot; + format(round)</span>
				+ &quot; roundrect&quot;, true);
<span class="fc" id="L490">		roundrectUsed = true;</span>
<span class="fc" id="L491">	}</span>

	private void simpleRectangle(double x, double y, double width, double height, boolean fill) {
<span class="nc bnc" id="L494" title="All 2 branches missed.">		if (isDashed3())</span>
<span class="nc" id="L495">			append(&quot;[&quot; + dashSpace + &quot; &quot; + dashVisible + &quot;] 0 setdash&quot;, true);</span>

		// if (isDashed3() || fill) {
<span class="nc" id="L498">		append(format(width) + &quot; &quot; + format(height) + &quot; &quot; + format(x) + &quot; &quot; + format(y) + &quot; simplerect&quot;, true);</span>
<span class="nc" id="L499">		simplerectUsed = true;</span>
		// }
<span class="nc" id="L501">	}</span>

	/**
	 * Converts a counter clockwise angle to a clockwise angle. i.e. 0 -&gt; 360, 90 -&gt;
	 * 270, 180 -&gt; 180, 270 -&gt; 90
	 * 
	 * @param counterClockwise counter clockwise angle in degrees
	 * @return clockwise angle in degrees
	 */
	private int convertToClockwiseAngle(double counterClockwise) {
<span class="nc" id="L511">		return (int) (360.0 - counterClockwise);</span>
	}

	final public void epsEllipse(double x, double y, double xRadius, double yRadius, double start, double extend) {
<span class="nc" id="L515">		checkCloseDone();</span>
<span class="nc" id="L516">		ensureVisible(x + xRadius, y + yRadius);</span>
<span class="nc" id="L517">		double scale = 1;</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">		if (xRadius != yRadius) {</span>
<span class="nc" id="L519">			scale = yRadius / xRadius;</span>
<span class="nc" id="L520">			append(&quot;gsave&quot;, true);</span>
<span class="nc" id="L521">			append(&quot;1 &quot; + format(scale) + &quot; scale&quot;, true);</span>
		}
		// if (fillcolor != null) {
		// appendColor(fillcolor);
		// append(&quot;newpath&quot;, true);
		// append(format(x) + &quot; &quot; + format(y / scale) + &quot; &quot; + format(xRadius) + &quot; 0 360
		// arc&quot;, true);
		// append(&quot;closepath eofill&quot;, true);
		// }

<span class="nc bnc" id="L531" title="All 2 branches missed.">		if (isNull(color) == false) {</span>
<span class="nc" id="L532">			append(strokeWidth + &quot; setlinewidth&quot;, true);</span>
<span class="nc" id="L533">			appendColor(color);</span>
<span class="nc" id="L534">			append(&quot;newpath&quot;, true);</span>

<span class="nc" id="L536">			final double a1 = convertToClockwiseAngle(start + extend);</span>
<span class="nc" id="L537">			final double a2 = convertToClockwiseAngle(start);</span>
<span class="nc" id="L538">			append(format(x) + &quot; &quot; + format(y / scale) + &quot; &quot; + format(xRadius) + &quot; &quot; + a1 + &quot; &quot; + a2 + &quot; arc&quot;, true);</span>
<span class="nc" id="L539">			append(&quot;stroke&quot;, true);</span>
		}

<span class="nc bnc" id="L542" title="All 2 branches missed.">		if (scale != 1)</span>
<span class="nc" id="L543">			append(&quot;grestore&quot;, true);</span>

<span class="nc" id="L545">	}</span>

	final public void epsEllipse(double x, double y, double xRadius, double yRadius) {
<span class="nc" id="L548">		checkCloseDone();</span>
<span class="nc" id="L549">		ensureVisible(x + xRadius, y + yRadius);</span>
<span class="nc" id="L550">		double scale = 1;</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">		if (xRadius != yRadius) {</span>
<span class="nc" id="L552">			scale = yRadius / xRadius;</span>
<span class="nc" id="L553">			append(&quot;gsave&quot;, true);</span>
<span class="nc" id="L554">			append(&quot;1 &quot; + formatSimple4(scale) + &quot; scale&quot;, true);</span>
		}
<span class="nc bnc" id="L556" title="All 2 branches missed.">		if (isNull(fillcolor) == false) {</span>
<span class="nc" id="L557">			appendColor(fillcolor);</span>
<span class="nc" id="L558">			append(&quot;newpath&quot;, true);</span>
<span class="nc" id="L559">			append(format(x) + &quot; &quot; + format(y / scale) + &quot; &quot; + format(xRadius) + &quot; 0 360 arc&quot;, true);</span>
<span class="nc" id="L560">			append(&quot;closepath eofill&quot;, true);</span>
		}

<span class="nc bnc" id="L563" title="All 2 branches missed.">		if (isNull(color) == false) {</span>
<span class="nc" id="L564">			append(strokeWidth + &quot; setlinewidth&quot;, true);</span>
<span class="nc" id="L565">			appendColor(color);</span>
<span class="nc" id="L566">			append(&quot;newpath&quot;, true);</span>
<span class="nc" id="L567">			append(format(x) + &quot; &quot; + format(y / scale) + &quot; &quot; + format(xRadius) + &quot; 0 360 arc&quot;, true);</span>
<span class="nc" id="L568">			append(&quot;closepath stroke&quot;, true);</span>
		}

<span class="nc bnc" id="L571" title="All 2 branches missed.">		if (scale != 1)</span>
<span class="nc" id="L572">			append(&quot;grestore&quot;, true);</span>

<span class="nc" id="L574">	}</span>

	final protected void appendColor(XColor c) {
<span class="pc bpc" id="L577" title="1 of 2 branches missed.">		if (isNull(c))</span>
<span class="nc" id="L578">			return;</span>

<span class="fc" id="L580">		final double r = c.getRed() / 255.0;</span>
<span class="fc" id="L581">		final double g = c.getGreen() / 255.0;</span>
<span class="fc" id="L582">		final double b = c.getBlue() / 255.0;</span>
<span class="fc" id="L583">		append(formatSimple2(r) + &quot; &quot; + formatSimple2(g) + &quot; &quot; + formatSimple2(b) + &quot; setrgbcolor&quot;, true);</span>
<span class="fc" id="L584">	}</span>

	final protected void appendColorShort(XColor c) {
<span class="nc bnc" id="L587" title="All 2 branches missed.">		if (isNull(c))</span>
<span class="nc" id="L588">			return;</span>

<span class="nc" id="L590">		final double r = c.getRed() / 255.0;</span>
<span class="nc" id="L591">		final double g = c.getGreen() / 255.0;</span>
<span class="nc" id="L592">		final double b = c.getBlue() / 255.0;</span>
<span class="nc" id="L593">		append(formatSimple2(r) + &quot; &quot; + formatSimple2(g) + &quot; &quot; + formatSimple2(b), true);</span>
<span class="nc" id="L594">	}</span>

	static String format(double x) {
<span class="fc bfc" id="L597" title="All 2 branches covered.">		if (x == 0)</span>
<span class="fc" id="L598">			return &quot;0&quot;;</span>

<span class="fc" id="L600">		return Long.toString((long) (x * COEF));</span>
	}

	public static String formatSimple4(double x) {
<span class="nc bnc" id="L604" title="All 2 branches missed.">		if (x == 0)</span>
<span class="nc" id="L605">			return &quot;0&quot;;</span>

<span class="nc" id="L607">		String s = String.format(Locale.US, &quot;%1.4f&quot;, x);</span>
<span class="nc" id="L608">		s = s.replaceAll(&quot;(\\.\\d*?)0+$&quot;, &quot;$1&quot;);</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">		if (s.endsWith(&quot;.&quot;))</span>
<span class="nc" id="L610">			s = s.substring(0, s.length() - 1);</span>

<span class="nc" id="L612">		return s;</span>
	}

	private static String formatSimple2(double x) {
<span class="fc bfc" id="L616" title="All 2 branches covered.">		if (x == 0)</span>
<span class="fc" id="L617">			return &quot;0&quot;;</span>

<span class="fc" id="L619">		String s = String.format(Locale.US, &quot;%1.2f&quot;, x);</span>
<span class="fc" id="L620">		s = s.replaceAll(&quot;(\\.\\d*?)0+$&quot;, &quot;$1&quot;);</span>
<span class="pc bpc" id="L621" title="1 of 2 branches missed.">		if (s.endsWith(&quot;.&quot;))</span>
<span class="nc" id="L622">			s = s.substring(0, s.length() - 1);</span>

<span class="fc" id="L624">		return s;</span>
	}

	protected void append(String s, boolean checkConsistence) {
<span class="nc bnc" id="L628" title="All 4 branches missed.">		if (checkConsistence &amp;&amp; s.indexOf(&quot;  &quot;) != -1)</span>
<span class="nc" id="L629">			throw new IllegalArgumentException(s);</span>

<span class="nc" id="L631">		body.append(s + BackSlash.NEWLINE);</span>
<span class="nc" id="L632">	}</span>

	final public void linetoNoMacro(double x1, double y1) {
<span class="nc" id="L635">		append(format(x1) + &quot; &quot; + format(y1) + &quot; lineto&quot;, true);</span>
<span class="nc" id="L636">		ensureVisible(x1, y1);</span>
<span class="nc" id="L637">	}</span>

	final public void movetoNoMacro(double x1, double y1) {
<span class="nc" id="L640">		append(format(x1) + &quot; &quot; + format(y1) + &quot; moveto&quot;, true);</span>
<span class="nc" id="L641">		ensureVisible(x1, y1);</span>
<span class="nc" id="L642">	}</span>

	final public void curvetoNoMacro(double x1, double y1, double x2, double y2, double x3, double y3) {
<span class="nc" id="L645">		append(format(x1) + &quot; &quot; + format(y1) + &quot; &quot; + format(x2) + &quot; &quot; + format(y2) + &quot; &quot; + format(x3) + &quot; &quot; + format(y3)</span>
				+ &quot; curveto&quot;, true);
<span class="nc" id="L647">		ensureVisible(x1, y1);</span>
<span class="nc" id="L648">		ensureVisible(x2, y2);</span>
<span class="nc" id="L649">		ensureVisible(x3, y3);</span>
<span class="nc" id="L650">	}</span>

	// FONT
	public void moveto(double x1, double y1) {
<span class="nc" id="L654">		append(format(x1) + &quot; &quot; + format(y1) + &quot; moveto&quot;, true);</span>
<span class="nc" id="L655">		ensureVisible(x1, y1);</span>
<span class="nc" id="L656">	}</span>

	public void lineto(double x1, double y1) {
<span class="nc" id="L659">		append(format(x1) + &quot; &quot; + format(y1) + &quot; lineto&quot;, true);</span>
<span class="nc" id="L660">		ensureVisible(x1, y1);</span>
<span class="nc" id="L661">	}</span>

	public void curveto(double x1, double y1, double x2, double y2, double x3, double y3) {
<span class="nc" id="L664">		append(format(x1) + &quot; &quot; + format(y1) + &quot; &quot; + format(x2) + &quot; &quot; + format(y2) + &quot; &quot; + format(x3) + &quot; &quot; + format(y3)</span>
				+ &quot; curveto&quot;, true);
<span class="nc" id="L666">		ensureVisible(x1, y1);</span>
<span class="nc" id="L667">		ensureVisible(x2, y2);</span>
<span class="nc" id="L668">		ensureVisible(x3, y3);</span>
<span class="nc" id="L669">	}</span>

	public void quadto(double x1, double y1, double x2, double y2) {
<span class="nc" id="L672">		append(format(x1) + &quot; &quot; + format(y1) + &quot; &quot; + format(x1) + &quot; &quot; + format(y1) + &quot; &quot; + format(x2) + &quot; &quot; + format(y2)</span>
				+ &quot; curveto&quot;, true);
<span class="nc" id="L674">		ensureVisible(x1, y1);</span>
<span class="nc" id="L675">		ensureVisible(x2, y2);</span>
<span class="nc" id="L676">	}</span>

	public void newpath() {
<span class="nc" id="L679">		append(&quot;0 setlinewidth&quot;, true);</span>
<span class="nc" id="L680">		appendColor(color);</span>
<span class="nc" id="L681">		append(&quot;newpath&quot;, true);</span>
<span class="nc" id="L682">	}</span>

	public void closepath() {
<span class="nc" id="L685">		append(&quot;closepath&quot;, true);</span>
<span class="nc" id="L686">	}</span>

	public void fill(int windingRule) {
<span class="nc" id="L689">		append(&quot;%fill&quot;, true);</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">		if (windingRule == PathIterator.WIND_EVEN_ODD)</span>
<span class="nc" id="L691">			append(&quot;eofill&quot;, true);</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">		else if (windingRule == PathIterator.WIND_NON_ZERO)</span>
<span class="nc" id="L693">			append(&quot;fill&quot;, true);</span>

<span class="nc" id="L695">	}</span>

	final public void drawImage(PortableImage image, double x, double y) {
<span class="nc" id="L698">		final int width = image.getWidth();</span>
<span class="nc" id="L699">		final int height = image.getHeight();</span>
<span class="nc" id="L700">		append(&quot;gsave&quot;, true);</span>
<span class="nc" id="L701">		append(format(x) + &quot; &quot; + format(y) + &quot; translate&quot;, true);</span>
<span class="nc" id="L702">		append(format(width) + &quot; &quot; + format(height) + &quot; scale&quot;, true);</span>
<span class="nc" id="L703">		append(&quot;&quot; + width + &quot; &quot; + height + &quot; 8 [&quot; + width + &quot; 0 0 -&quot; + height + &quot; 0 &quot; + height + &quot;]&quot;, true);</span>
		// append(&quot;&quot; + width + &quot; &quot; + height + &quot; 8 [0 0 0 0 0 0]&quot;);
<span class="nc" id="L705">		append(&quot;{&lt;&quot;, true);</span>
<span class="nc" id="L706">		final StringBuilder sb = new StringBuilder(width * height * 6);</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">		for (int j = height - 1; j &gt;= 0; j--)</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">			for (int i = 0; i &lt; width; i++) {</span>
<span class="nc" id="L709">				final String hexString = getRgb(image.getRGB(i, j));</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">				assert hexString.length() == 6;</span>
<span class="nc" id="L711">				sb.append(hexString);</span>
			}

<span class="nc" id="L714">		append(sb.toString(), true);</span>
		// append(&quot;&gt;} image&quot;);
<span class="nc" id="L716">		append(&quot;&gt;} false 3 colorimage&quot;, true);</span>
<span class="nc" id="L717">		ensureVisible(x + width, y + height);</span>
<span class="nc" id="L718">		append(&quot;grestore&quot;, true);</span>
<span class="nc" id="L719">	}</span>

	static String getRgb(int x) {
<span class="nc" id="L722">		final String s = &quot;000000&quot; + Integer.toHexString(x);</span>
<span class="nc" id="L723">		return s.substring(s.length() - 6);</span>
	}

	final public void drawEps(String eps, double x, double y) {

<span class="nc" id="L728">		final int idx = eps.indexOf(&quot;%%BoundingBox:&quot;);</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">		if (idx == -1)</span>
<span class="nc" id="L730">			throw new IllegalArgumentException();</span>

<span class="nc" id="L732">		final StringTokenizer st = new StringTokenizer(eps.substring(idx + &quot;%%BoundingBox:&quot;.length()), &quot; \n\t\r&quot;);</span>
<span class="nc" id="L733">		final int x1 = Integer.parseInt(st.nextToken());</span>
<span class="nc" id="L734">		final int y1 = Integer.parseInt(st.nextToken());</span>
<span class="nc" id="L735">		final int x2 = Integer.parseInt(st.nextToken());</span>
<span class="nc" id="L736">		final int y2 = Integer.parseInt(st.nextToken());</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">		assert x2 &gt;= x1;</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">		assert y2 &gt;= y1;</span>

<span class="nc" id="L740">		append(&quot;gsave&quot;, true);</span>
<span class="nc" id="L741">		final double dx = x - x1;</span>
<span class="nc" id="L742">		final double dy = y + y2;</span>
<span class="nc" id="L743">		append(format(dx) + &quot; &quot; + format(dy) + &quot; translate&quot;, true);</span>
<span class="nc" id="L744">		append(&quot;1 -1 scale&quot;, true);</span>
<span class="nc" id="L745">		append(eps, false);</span>
<span class="nc" id="L746">		ensureVisible(x + (x2 - x1), y + (y2 - y1));</span>
<span class="nc" id="L747">		append(&quot;grestore&quot;, true);</span>
<span class="nc" id="L748">	}</span>

	protected final long getDashVisible() {
<span class="fc" id="L751">		return dashVisible;</span>
	}

	protected final long getDashSpace() {
<span class="fc" id="L755">		return dashSpace;</span>
	}

	static class UrlArea {
		private final String url;
<span class="nc" id="L760">		private int xmin = Integer.MAX_VALUE;</span>
<span class="nc" id="L761">		private int xmax = Integer.MIN_VALUE;</span>
<span class="nc" id="L762">		private int ymin = Integer.MAX_VALUE;</span>
<span class="nc" id="L763">		private int ymax = Integer.MIN_VALUE;</span>

<span class="nc" id="L765">		UrlArea(String url) {</span>
<span class="nc" id="L766">			this.url = url;</span>
<span class="nc" id="L767">		}</span>

		void ensureVisible(int x, int y) {
<span class="nc bnc" id="L770" title="All 2 branches missed.">			if (x &lt; xmin)</span>
<span class="nc" id="L771">				xmin = x;</span>

<span class="nc bnc" id="L773" title="All 2 branches missed.">			if (x &gt; xmax)</span>
<span class="nc" id="L774">				xmax = x;</span>

<span class="nc bnc" id="L776" title="All 2 branches missed.">			if (y &lt; ymin)</span>
<span class="nc" id="L777">				ymin = y;</span>

<span class="nc bnc" id="L779" title="All 2 branches missed.">			if (y &gt; ymax)</span>
<span class="nc" id="L780">				ymax = y;</span>

<span class="nc" id="L782">		}</span>
	}

	private UrlArea urlArea;

	final public void closeLink() {
<span class="nc bnc" id="L788" title="All 4 branches missed.">		if (urlArea != null &amp;&amp; urlArea.xmin != Integer.MAX_VALUE) {</span>
<span class="nc" id="L789">			final int width = urlArea.xmax - urlArea.xmin;</span>
<span class="nc" id="L790">			final int height = urlArea.ymax - urlArea.ymin;</span>
<span class="nc bnc" id="L791" title="All 4 branches missed.">			assert width &gt;= 0 &amp;&amp; height &gt;= 0;</span>
<span class="nc" id="L792">			epsUrlLink(urlArea.xmin, urlArea.ymin, width, height, urlArea.url);</span>
		}
<span class="nc" id="L794">		this.urlArea = null;</span>
<span class="nc" id="L795">	}</span>

	final public void epsUrlLink(int x, int y, int width, int height, String url) {
<span class="nc" id="L798">		append(&quot;[ /Rect [ &quot; + x + &quot; &quot; + y + &quot; &quot; + (x + width) + &quot; &quot; + (y + height) + &quot; ]&quot;, true);</span>
<span class="nc" id="L799">		append(&quot;/Border [ 0 0 0 ]&quot;, true);</span>
<span class="nc" id="L800">		append(&quot;/Action &lt;&lt; /Subtype /URI /URI (&quot; + url + &quot;) &gt;&gt;&quot;, true);</span>
<span class="nc" id="L801">		append(&quot;/Subtype /Link&quot;, true);</span>
<span class="nc" id="L802">		append(&quot;/ANN pdfmark&quot;, true);</span>
<span class="nc" id="L803">	}</span>

	final public void openLink(String url) {
		// javascript: security issue
<span class="nc bnc" id="L807" title="All 2 branches missed.">		if (SecurityUtils.ignoreThisLink(url))</span>
<span class="nc" id="L808">			return;</span>

<span class="nc" id="L810">		this.urlArea = new UrlArea(url);</span>
<span class="nc" id="L811">	}</span>

	// Shadow
<span class="fc" id="L814">	final private ShadowManager shadowManager = new ShadowManager(50, 200);</span>

	final public void epsRectangleShadow(double x, double y, double width, double height, double rx, double ry,
			double deltaShadow) {
<span class="nc" id="L818">		setStrokeColor(null);</span>
<span class="nc bnc" id="L819" title="All 2 branches missed.">		for (double i = 0; i &lt;= deltaShadow; i += 0.5) {</span>
<span class="nc" id="L820">			setFillColor(shadowManager.getColor(i, deltaShadow));</span>
<span class="nc" id="L821">			final double diff = i;</span>
<span class="nc" id="L822">			epsRectangle(x + deltaShadow + diff, y + deltaShadow + diff, width - 2 * diff, height - 2 * diff, rx + 1,</span>
					ry + 1);
		}
<span class="nc" id="L825">	}</span>

	final public void epsPolygonShadow(double deltaShadow, double... points) {
<span class="nc bnc" id="L828" title="All 2 branches missed.">		assert points.length % 2 == 0;</span>
<span class="nc" id="L829">		setStrokeColor(null);</span>
<span class="nc bnc" id="L830" title="All 2 branches missed.">		for (double i = 0; i &lt;= deltaShadow; i += 0.5) {</span>
<span class="nc" id="L831">			setFillColor(shadowManager.getColor(i, deltaShadow));</span>
<span class="nc" id="L832">			final double diff = i;</span>
<span class="nc" id="L833">			epsPolygon(shadowManager.getShadowDeltaPoints(deltaShadow, diff, points));</span>
		}
<span class="nc" id="L835">	}</span>

	final public void epsEllipseShadow(double x, double y, double xRadius, double yRadius, double deltaShadow) {
<span class="nc" id="L838">		setStrokeColor(null);</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">		for (double i = 0; i &lt;= deltaShadow; i += 0.5) {</span>
<span class="nc" id="L840">			setFillColor(shadowManager.getColor(i, deltaShadow));</span>
<span class="nc" id="L841">			final double diff = i;</span>
<span class="nc" id="L842">			epsEllipse(x + deltaShadow, y + deltaShadow, xRadius - diff, yRadius - diff);</span>
		}
<span class="nc" id="L844">	}</span>

	public void drawOk(DotPath dotPath, double x, double y) {
		// boolean first = true;
<span class="nc bnc" id="L848" title="All 2 branches missed.">		for (XCubicCurve2D bez : dotPath.getBeziers()) {</span>
<span class="nc" id="L849">			bez = new XCubicCurve2D(x + bez.x1, y + bez.y1, x + bez.ctrlx1, y + bez.ctrly1, x + bez.ctrlx2,</span>
					y + bez.ctrly2, x + bez.x2, y + bez.y2);
<span class="nc" id="L851">			this.epsLine(bez.x1, bez.y1, bez.x2, bez.y2);</span>
<span class="nc" id="L852">		}</span>
<span class="nc" id="L853">	}</span>

	public void drawBezier(List&lt;XCubicCurve2D&gt; beziers, double x, double y) {
<span class="nc" id="L856">		this.newpathDot();</span>
<span class="nc" id="L857">		final boolean dashed = false;</span>
<span class="nc" id="L858">		boolean first = true;</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">		for (XCubicCurve2D bez : beziers) {</span>
<span class="nc" id="L860">			bez = new XCubicCurve2D(x + bez.x1, y + bez.y1, x + bez.ctrlx1, y + bez.ctrly1, x + bez.ctrlx2,</span>
					y + bez.ctrly2, x + bez.x2, y + bez.y2);
<span class="nc bnc" id="L862" title="All 2 branches missed.">			if (first) {</span>
<span class="nc" id="L863">				this.movetoNoMacro(bez.x1, bez.y1);</span>
<span class="nc" id="L864">				first = dashed;</span>
			}
<span class="nc" id="L866">			this.curvetoNoMacro(bez.ctrlx1, bez.ctrly1, bez.ctrlx2, bez.ctrly2, bez.x2, bez.y2);</span>
<span class="nc" id="L867">		}</span>
<span class="nc" id="L868">		this.closepathDot();</span>
<span class="nc" id="L869">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>